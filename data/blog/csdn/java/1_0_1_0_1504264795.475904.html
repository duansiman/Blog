

<p>1、编写anction,如下：</p>&#13;
<p>package cn.com.css.misps.onlinegraph.web.action;</p>&#13;
<p>import java.io.File;<br />&#13;
import java.io.FileInputStream;<br />&#13;
import java.io.InputStream;<br />&#13;
import java.net.URLEncoder;<br />&#13;
import java.util.ArrayList;<br />&#13;
import java.util.HashMap;<br />&#13;
import java.util.LinkedHashMap;<br />&#13;
import java.util.List;<br />&#13;
import java.util.Map;</p>&#13;
<p>import javax.annotation.Resource;</p>&#13;
<p>import org.springframework.context.annotation.Scope;<br />&#13;
import org.springframework.stereotype.Controller;</p>&#13;
<p>import cn.com.css.common.action.BaseAction;<br />&#13;
import cn.com.css.misps.domain.ServiceCode;<br />&#13;
import cn.com.css.misps.domain.ServiceProductCode;<br />&#13;
import cn.com.css.misps.domain.TPrCategory;<br />&#13;
import cn.com.css.misps.onlinegraph.service.IServiceCodeService;<br />&#13;
import cn.com.css.misps.onlinegraph.service.IServiceProductCodeService;<br />&#13;
import cn.com.css.misps.onlinegraph.service.ITPrCategoryService;<br />&#13;
import cn.com.css.misps.onlinegraph.service.ITProductInfoService;<br />&#13;
import cn.com.css.misps.onlinegraph.util.AnalysisMicaps2BytesUtils;<br />&#13;
import cn.com.css.misps.onlinegraph.util.DateUtil;<br />&#13;
import cn.com.css.misps.onlinegraph.util.FNameUtils;<br />&#13;
import cn.com.css.misps.onlinegraph.util.ImageBytesAnalysisUtils;<br />&#13;
import cn.com.css.misps.onlinegraph.util.ProductsStorageUtils;<br />&#13;
import cn.com.css.misps.onlinegraph.webservice.impl.GraphWebServiceImpl;<br />&#13;
import cn.com.system.domain.Account;<br />&#13;
import com.opensymphony.xwork2.ActionContext;</p>&#13;
<p>/**<br />&#13;
 * @brief OnlineGraphAction.java 这里是在线出图部分的代码<br />&#13;
 * @attention 要注意的是页面中的表单填写的是服务方法中要求填写的参数<br />&#13;
 * @author 涂作权<br />&#13;
 * @date 2013-9-4<br />&#13;
 * @note begin modify by null<br />&#13;
 */<br />&#13;
@SuppressWarnings("serial")<br />&#13;
@Scope("prototype")<br />&#13;
@Controller<br />&#13;
public class OnlineGraphAction extends BaseAction {</p>&#13;
<p><br />&#13;
 // 相对门户项目的相对路径<br />&#13;
 private String relativeStorageFilePath;</p>&#13;
<p><br />&#13;
 // 图形文件的文件名称<br />&#13;
 private String imgPath;</p>&#13;
<p> // 下载文件用户的<br />&#13;
 private InputStream inputStream;</p>&#13;
<p> </p>&#13;
<p> /**<br />&#13;
  * \brief 下载产生的图片<br />&#13;
  * <br />&#13;
  * @return<br />&#13;
  * @attention<br />&#13;
  * @author 涂作权<br />&#13;
  * @date 2014-3-26<br />&#13;
  * @note begin modify by null<br />&#13;
  */<br />&#13;
 public String download() throws Exception {<br />&#13;
  inputStream = new FileInputStream(<br />&#13;
    ProductsStorageUtils.graphAbsolutePath<br />&#13;
      + relativeStorageFilePath + "/" + imgPath);<br />&#13;
  //这里的imgPath表示的是的是文件的名称，即：fName<br />&#13;
  String name = URLEncoder.encode(imgPath,"utf-8");<br />&#13;
  ActionContext.getContext().put("name", name);<br />&#13;
  return "download";<br />&#13;
 }</p>&#13;
<p> </p>&#13;
<p> /**<br />&#13;
  * @return the imgPath<br />&#13;
  */<br />&#13;
 public String getImgPath() {<br />&#13;
  return imgPath;<br />&#13;
 }</p>&#13;
<p> /**<br />&#13;
  * @param imgPath<br />&#13;
  *            the imgPath to set<br />&#13;
  */<br />&#13;
 public void setImgPath(String imgPath) {<br />&#13;
  this.imgPath = imgPath;<br />&#13;
 }</p>&#13;
<p> </p>&#13;
<p> /**<br />&#13;
  * @return the inputStream<br />&#13;
  */<br />&#13;
 public InputStream getInputStream() {<br />&#13;
  return inputStream;<br />&#13;
 }</p>&#13;
<p> /**<br />&#13;
  * @param inputStream<br />&#13;
  *            the inputStream to set<br />&#13;
  */</p>&#13;
<p> public void setInputStream(InputStream inputStream) {<br />&#13;
  this.inputStream = inputStream;<br />&#13;
 }<br />&#13;
}<br />&#13;
</p>&#13;
<p><span style="background-color:rgb(51,255,51)">在struts配置文件中进行如下配置：</span></p>&#13;
<p> &lt;action name="onlinegraph_*" class="cn.com.css.misps.onlinegraph.web.action.OnlineGraphAction" method="{1}"&gt;<br />&#13;
   &lt;result name="download" type="stream"&gt;<br />&#13;
    &lt;param name="inputName"&gt;inputStream&lt;/param&gt;<br />&#13;
    &lt;param name="contentDisposition"&gt;attachment;filename="${#name}"&lt;/param&gt;<br />&#13;
    &lt;param name="bufferSize"&gt;4096&lt;/param&gt;<br />&#13;
   &lt;/result&gt;<br />&#13;
  &lt;/action&gt;</p>&#13;
<p> </p>&#13;
   &#13;
