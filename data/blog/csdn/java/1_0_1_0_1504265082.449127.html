

<p><span style="font-family:KaiTi_GB2312; font-size:18px">    因为事务需要实现ACID，即原子性、一致性、隔离性、持久性，所以需要采用一定的机制来保证，通常采用的是分阶段提交的方式。</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    XA:XA协议，规定事务管理器和资源管理器接口，采用二阶段提交协议。</span></p>&#13;
<h1><span style="font-family:KaiTi_GB2312; font-size:18px">一阶段提交协议</span></h1>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    一阶段提交协议相对简单，如下图：</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    <img src="http://img.blog.csdn.net/20140811114943913?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlkYXRnYg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /></span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    当然，前提是开启了事务，然后在应用程序发出提交/回滚请求后，数据库执行操作，而后将成功/失败返回给应用程序，程序继续执行。</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    一阶段提交协议相对简单，简单带来的优点就是，它不用再与其他的对象交互，节省了判断步骤和时间，所以在性能上是在阶段提交协议中对好的。</span></p>&#13;
<h1><span style="font-family:KaiTi_GB2312; font-size:18px">二阶段提交协议</span></h1>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    一阶段提交协议有其优点，但缺点也很明显：</span></p>&#13;
<p></p>&#13;
<ul>&#13;
<li><span style="font-family:KaiTi_GB2312; font-size:18px">数据库确认执行事务的时间较长，出问题的可能性就随之增大。</span></li><li><span style="font-family:KaiTi_GB2312; font-size:18px">如果有多个数据源，一阶段提交协议无法协调他们之间的关系。</span></li></ul>&#13;
<p></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">   所以在一阶段协议的基础上，有了二阶段协议，二阶段协议的好处是添加了一个管理者角色，如下：</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    <img src="http://img.blog.csdn.net/20140811143332953?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlkYXRnYg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br />&#13;
</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    很明显，二阶段协议通过将两层变为三层，增加了中间的管理者角色，从而协调多个数据源之间的关系，二阶段提交协议分为两个阶段。</span></p>&#13;
<h2><span style="font-family:KaiTi_GB2312; font-size:18px">    第一阶段</span></h2>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    <img src="http://img.blog.csdn.net/20140811143756616?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlkYXRnYg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br />&#13;
</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    <span style="font-family:KaiTi_GB2312; font-size:18px">应用程序调用了事务管理器的提交方法，此后第一阶段分为两个步骤：</span></span></p>&#13;
<p></p>&#13;
<ul>&#13;
<li><span style="font-family:KaiTi_GB2312; font-size:18px">事务管理器通知参与该事务的各个资源管理器，通知他们开始准备事务。</span></li><li><span style="font-family:KaiTi_GB2312; font-size:18px">资源管理器接收到消息后开始准备阶段，写好事务日志并执行事务，但不提交，然后将是否就绪的消息返回给事务管理器（此时已经将事务的大部分事情做完，以后的内容耗时极小）。</span></li></ul>&#13;
<p></p>&#13;
<h2><span style="font-family:KaiTi_GB2312; font-size:18px">    第二阶段</span></h2>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    <img src="http://img.blog.csdn.net/20140811143852214?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGlkYXRnYg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br />&#13;
</span></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px">    第二阶段也分为两个步骤：</span><span style="font-family:KaiTi_GB2312; font-size:18px">    </span></p>&#13;
<p></p>&#13;
<ul>&#13;
<li><span style="font-family:KaiTi_GB2312; font-size:18px">事务管理器在接受各个消息后，开始分析，如果有任意其一失败，则发送回滚命令，否则发送提交命令。</span></li><li><span style="font-family:KaiTi_GB2312; font-size:18px">各个资源管理器接收到命令后，执行（耗时很少），并将提交消息返回给事务管理器。</span></li></ul>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    事务管理器接受消息后，事务结束，应用程序继续执行。</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    为什么要分两步执行？一是因为分两步，就有了事务管理器统一管理的机会；二尽可能晚地提交事务，让事务在提交前尽可能地完成所有能完成的工作，这样，最后的提交阶段将是耗时极短，耗时极短意味着操作失败的可能性也就降低。<br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    同时，二阶段提交协议为了保证事务的一致性，不管是事务管理器还是各个资源管理器，每执行一步操作，都会记录日志，为出现故障后的恢复准备依据。</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    二阶段提交协议的存在的弊端是阻塞，因为事务管理器要收集各个资源管理器的响应消息，如果其中一个或多个一直不返回消息，则事务管理器一直等待，应用程序也被阻塞，甚至可能永久阻塞。</span></div>&#13;
<h1><span style="font-family:KaiTi_GB2312; font-size:18px">事务与协议</span></h1>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    那么本地事务和分布式事务，分别采用的是哪些协议？我在<a target="_blank" href="http://www.redbooks.ibm.com/redbooks/pdfs/sg246122.pdf">RedBooks</a>的一个文档中看到的是：</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px"><strong>Global transactions</strong><br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    Although the XAResource interface is intended to support two phase commit, the specification does not force an adapter to support two phase commit. However, if the resource adapter does implement&#13;
 XAResource it must also implement support for one phase commit. This allows the transaction manager to do one phase commit optimization (explained later) by setting the onePhase flag to true when doing acommit.……<br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px"><strong>Local transactions</strong><br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    A local transaction is managed by the resource manager without the need for an <br />&#13;
external transaction manager, and can be utilized when only one resource is <br />&#13;
involved. <strong><span style="color:#990000">Local transactions only support one phase commit</span></strong>, because they only <br />&#13;
reference one EIS.……<br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    大意是：虽然实现XA接口的目的是为了支持二阶段提交协议，但是它也支持一阶段提交协议。</span><span style="font-family:KaiTi_GB2312; font-size:18px">本地事务只支持一阶段提交；分布式事务默认采用的是二阶段提交，如果在分布式事务中非得使用一阶段提交协议，那么只要数据源多余一个就会抛出异常，如果只有一个数据源则正确执行。</span></div>&#13;
<h1><span style="font-family:KaiTi_GB2312; font-size:18px">总结</span></h1>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px">    一阶段提交协议和二阶段提交协议只是比较常用的两个，此外还有其他协议，可自行研究。</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px"><br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px"><br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px"><br />&#13;
</span></div>&#13;
<div><span style="font-family:KaiTi_GB2312; font-size:18px"><br />&#13;
</span></div>&#13;
<p></p>&#13;
<p><span style="font-family:KaiTi_GB2312; font-size:18px"><br />&#13;
</span></p>&#13;
<p><br />&#13;
</p>&#13;
   &#13;
