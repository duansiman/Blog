
<div class="blog-abstract" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 23px 0px 45px; line-height: 28px; word-break: break-all; color: rgb(102, 102, 102); font-size: 18px; font-style: italic; font-family: Baskerville, Georgia, &quot;Liberation Serif&quot;, &quot;Kaiti SC&quot;, STKaiti, &quot;AR PL UKai CN&quot;, &quot;AR PL UKai HK&quot;, &quot;AR PL UKai TW&quot;, &quot;AR PL UKai TW MBE&quot;, &quot;AR PL KaitiM GB&quot;, KaiTi, KaiTi_GB2312, TW-Kai, serif; background-color: rgb(248, 248, 248);">摘要: JDK本身提供了很多方便的JVM性能调优监控工具，除了集成式的VisualVM和jConsole外，还有jps、jstack、jmap、jhat、jstat、hprof等小巧的工具，本博客希望能起抛砖引玉之用，让大家能开始对JVM性能调优的常用工具有所了解。</div><div class="blog-body" id="blogBody" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; word-wrap: break-word; font-size: 16px; font-family: &quot;Pingfang SC&quot;, STHeiti, &quot;Lantinghei SC&quot;, &quot;Open Sans&quot;, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, SimSun, sans-serif; color: rgb(61, 70, 77); line-height: 28px; margin-top: 30px; position: relative; background-color: rgb(248, 248, 248);"><val data-name="blog_content_type" data-value="richtext" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;"></val><div class="BlogContent" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    现实企业级Java开发中，有时候我们会碰到下面这些问题：</p><ul style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px 0px 0px 30px; padding: 8px 15px;"><li style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">OutOfMemoryError，内存不足</p></li><li style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">内存泄露</p></li><li style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">线程死锁</p></li><li style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">锁争用（Lock Contention）</p></li><li style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">Java进程消耗CPU过高</p></li><li style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin: 0px; padding: 0px;"><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">......</p></li></ul><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    这些问题在日常开发中可能被很多人忽视（比如有的人遇到上面的问题只是重启服务器或者调大内存，而不会深究问题根源），但能够理解并解决这些问题是Java程序员进阶的必备要求。本文将对一些常用的JVM性能调优监控工具进行介绍，希望能起抛砖引玉之用。本文参考了网上很多资料，难以一一列举，在此对这些资料的作者表示感谢！关于JVM性能调优相关的资料，请参考文末。</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;"><br style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;" /></span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;">A、</span></span><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;"> jps(Java Virtual Machine Process Status Tool)      </span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    jps主要用来输出JVM中运行的进程状态信息。语法格式如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jps</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[options]</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[hostid]</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    如果不指定hostid就默认为当前主机或服务器。</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    命令行参数选项说明如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs haml" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs haml" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">-<span class="ruby" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">q 不输出类名、Jar名和传入main方法的参数
</span>-<span class="ruby" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">m 输出传入main方法的参数
</span>-<span class="ruby" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">l 输出main类或Jar的全限名
</span>-<span class="ruby" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">v 输出传入JVM的参数</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">   比如下面：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# jps -m -l
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2458</span> org.artifactory.standalone.main.Main /usr/local/artifactory-<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2.2</span>.<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">5</span>/etc/jetty.xml
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">29920</span> com.sun.tools.hat.Main -port <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">9998</span> /tmp/dump.dat
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3149</span> org.apache.catalina.startup.Bootstrap start
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">30972</span> sun.tools.jps.Jps -m -l
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">8247</span> org.apache.catalina.startup.Bootstrap start
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25687</span> com.sun.tools.hat.Main -port <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">9999</span> dump.dat
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span> mrf-center.jar</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><br style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">B、</span></span><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;"> jstack</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">    jstack主要用来查看某个Java进程内的线程堆栈信息。语法格式如下：</span></p><pre class="brush:shell;toolbar: true; auto-links: false; hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jstack</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[option]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">pid</span>
<span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jstack</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[option]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">executable</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">core</span>
<span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jstack</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[option]</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[server-id@]</span><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">remote-hostname-or-ip</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">    命令行参数选项说明如下：</span></p><pre class="brush:shell;toolbar: true; auto-links: false; hljs haml" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs haml" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">-<span class="ruby" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">l long listings，会打印出额外的锁信息，在发生死锁时可以用jstack -l pid来观察锁持有情况
</span>-<span class="ruby" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">m mixed mode，不仅会输出Java堆栈信息，还会输出C/C++堆栈信息（比如Native方法）</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">    jstack可以定位到线程堆栈，根据堆栈信息我们可以定位到具体代码，所以它在JVM性能调优中使用得非常多。下面我们来一个实例找出某个Java进程中最耗费CPU的Java线程并定位堆栈信息，用到的命令有ps、top、printf、jstack、grep。</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;">    第一步先找出Java进程ID，我部署在服务器上的Java应用名称为mrf-center：</span></p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# ps -ef | grep mrf-center | grep -v grep
root     <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span>     <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1</span>  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">14</span>:<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">47</span> pts/<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">00</span>:<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">02</span>:<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">10</span> java -jar mrf-center.jar</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    得到进程ID为21711，第二步找出该进程内最耗费CPU的线程，可以使用ps -Lfp pid或者ps -mp pid -o THREAD, tid, time或者top -Hp pid，我这里用第三个，输出如下：</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><img src="http://static.oschina.net/uploads/space/2014/0128/170402_A57i_111708.png" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; margin: auto; max-width: 80%; height: auto;" alt="" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    TIME列就是各个Java线程耗费的CPU时间，CPU时间最长的是线程ID为21742的线程，用</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs perl" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs perl" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">printf</span> <span class="hljs-string" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(204, 147, 147);">"%x\n"</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21742</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    得到21742的十六进制值为54ee，下面会用到。    </p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    OK，下一步终于轮到jstack上场了，它用来输出进程21711的堆栈信息，然后根据线程ID的十六进制值grep，如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# jstack <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span> | grep <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">54</span>ee
<span class="hljs-string" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(204, 147, 147);">"PollIntervalRetrySchedulerThread"</span> prio=<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">10</span> tid=<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0</span>x00007f950043e000 nid=<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0</span>x54ee in Object.wait() [<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0</span>x00007f94c6eda000]</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    可以看到CPU消耗在PollIntervalRetrySchedulerThread这个类的Object.wait()，我找了下我的代码，定位到下面的代码：</p><pre class="brush:java;toolbar: true; auto-links: false; hljs" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs java" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-comment" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(127, 159, 127);">// Idle wait</span>
getLog().info(<span class="hljs-string" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(204, 147, 147);">"Thread ["</span> + getName() + <span class="hljs-string" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(204, 147, 147);">"] is idle waiting..."</span>);
schedulerThreadState = PollTaskSchedulerThreadState.IdleWaiting;
<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">long</span> now = System.currentTimeMillis();
<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">long</span> waitTime = now + getIdleWaitTime();
<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">long</span> timeUntilContinue = waitTime - now;
<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">synchronized</span>(sigLock) {
	<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">try</span> {
    	<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">if</span>(!halted.get()) {
    		sigLock.wait(timeUntilContinue);
    	}
    } 
	<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">catch</span> (InterruptedException ignore) {
    }
}</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    它是轮询任务的空闲等待代码，上面的sigLock.wait(timeUntilContinue)就对应了前面的Object.wait()。</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><br style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">C、</span></span><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;"> jmap（Memory Map）和jhat（Java Heap Analysis Tool）</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">    jmap用来查看堆内存使用状况，一般结合jhat使用。</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">    jmap语法格式如下：</span></p><pre class="brush:shell;toolbar: true; auto-links: false; hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jmap</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[option]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">pid</span>
<span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jmap</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[option]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">executable</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">core</span>
<span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jmap</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[option]</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[server-id@]</span><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">remote-hostname-or-ip</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;"></span>    如果运行在64位JVM上，可能需要指定-J-d64命令选项参数。</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs tcl" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs tcl" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">jmap -permstat <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">pid</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    打印进程的类加载器和类加载器加载的持久代对象信息，输出：类加载器名称、对象是否存活（不可靠）、对象地址、父类加载器、已加载的类大小等信息，如下图：</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><img src="http://static.oschina.net/uploads/space/2014/0128/172247_5UEj_111708.png" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; margin: auto; max-width: 80%; height: auto;" alt="" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">   使用jmap -heap pid查看进程堆内存使用情况，包括使用的GC算法、堆配置参数和各代中堆内存使用情况。<span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;">比如下面的例子：</span></p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# jmap -heap <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span>
Attaching to process ID <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span>, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">20.10</span>-b01

using thread-local object allocation.
Parallel GC with <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4</span> thread(s)

Heap <span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">Configuration</span>:
   MinHeapFreeRatio = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">40</span>
   MaxHeapFreeRatio = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">70</span>
   MaxHeapSize      = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2067791872</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1972.0</span>MB)
   NewSize          = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1310720</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1.25</span>MB)
   MaxNewSize       = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">17592186044415</span> MB
   OldSize          = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">5439488</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">5.1875</span>MB)
   NewRatio         = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2</span>
   SurvivorRatio    = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">8</span>
   PermSize         = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21757952</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">20.75</span>MB)
   MaxPermSize      = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">85983232</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">82.0</span>MB)

Heap <span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">Usage</span>:
PS Young Generation
Eden <span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">Space</span>:
   capacity = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">6422528</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">6.125</span>MB)
   used     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">5445552</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">5.1932830810546875</span>MB)
   free     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">976976</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.9317169189453125</span>MB)
   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">84.78829520089286%</span> used
From <span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">Space</span>:
   capacity = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">131072</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.125</span>MB)
   used     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">98304</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.09375</span>MB)
   free     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32768</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.03125</span>MB)
   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">75.0%</span> used
To <span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">Space</span>:
   capacity = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">131072</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.125</span>MB)
   used     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.0</span>MB)
   free     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">131072</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.125</span>MB)
   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.0%</span> used
PS Old Generation
   capacity = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">35258368</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">33.625</span>MB)
   used     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4119544</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3.9287033081054688</span>MB)
   free     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">31138824</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">29.69629669189453</span>MB)
   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">11.683876009235595%</span> used
PS Perm Generation
   capacity = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">52428800</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">50.0</span>MB)
   used     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">26075168</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">24.867218017578125</span>MB)
   free     = <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">26353632</span> (<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25.132781982421875</span>MB)
   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">49.73443603515625%</span> used
   ....</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    使用jmap -histo[:live] pid查看堆内存中的对象数目、大小统计直方图，如果带上live则只统计活对象，如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs scss" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs scss" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root@ubuntu:/# jmap -histo:live 21711 | more

 num     #instances         <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">#b</span>ytes  class name
----------------------------------------------
   1:         38445        5597736  &lt;constMethodKlass&gt;
   2:         38445        5237288  &lt;methodKlass&gt;
   3:          3500        3749504  &lt;constantPoolKlass&gt;
   4:         60858        3242600  &lt;symbolKlass&gt;
   5:          3500        2715264  &lt;instanceKlassKlass&gt;
   6:          2796        2131424  &lt;constantPoolCacheKlass&gt;
   7:          5543        1317400  [I
   8:         13714        1010768  [C
   9:          4752        1003344  [B
  10:          1225         639656  &lt;methodDataKlass&gt;
  11:         14194         454208  java.lang.String
  12:          3809         396136  java.lang.Class
  13:          4979         311952  [S
  14:          5598         287064  [[I
  15:          3028         266464  java.lang.reflect.Method
  16:           280         163520  &lt;objArrayKlassKlass&gt;
  17:          4355         139360  java.util.HashMap<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$Entry</span>
  18:          1869         138568  [Ljava.util.HashMap<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$Entry</span>;
  19:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2443</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">97720</span>  java.util.LinkedHashMap<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$Entry</span>
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">20</span>:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2072</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">82880</span>  java.lang.ref.SoftReference
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21</span>:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1807</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">71528</span>  [Ljava.lang.Object;
  22:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2206</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">70592</span>  java.lang.ref.WeakReference
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">23</span>:           <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">934</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">52304</span>  java.util.LinkedHashMap
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">24</span>:           <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">871</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">48776</span>  java.beans.MethodDescriptor
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25</span>:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1442</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">46144</span>  java.util.concurrent.ConcurrentHashMap<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$HashEntry</span>
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">26</span>:           <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">804</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">38592</span>  java.util.HashMap
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">27</span>:           <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">948</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">37920</span>  java.util.concurrent.ConcurrentHashMap<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$Segment</span>
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">28</span>:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1621</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">35696</span>  [Ljava.lang.Class;
  29:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1313</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">34880</span>  [Ljava.lang.String;
  30:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1396</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">33504</span>  java.util.LinkedList<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$Entry</span>
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">31</span>:           <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">462</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">33264</span>  java.lang.reflect.Field
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32</span>:          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1024</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32768</span>  java.util.Hashtable<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$Entry</span>
  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">33</span>:           <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">948</span>          <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">31440</span>  [Ljava.util.concurrent.ConcurrentHashMap<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">$HashEntry</span>;</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    class name是对象类型，说明如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs java" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs java" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">B  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">byte</span>
C  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">char</span>
D  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">double</span>
F  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">float</span>
I  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">int</span>
J  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">long</span>
Z  <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">boolean</span>
[  数组，如[I表示<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">int</span>[]
[L+类名 其他对象</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    还有一个很常用的情况是：用jmap把进程内存使用情况dump到文件中，再用jhat分析查看。jmap进行dump命令格式如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs tcl" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs tcl" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">jmap -dump:<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">format</span>=b,<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">file</span>=dumpFileName <span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">pid</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    我一样地对上面进程ID为21711进行Dump：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# jmap <span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">-dump</span>:format=b,file=/tmp/dump.dat <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span>     
Dumping heap to /tmp/dump.dat ...
Heap dump file created</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">   dump出来的文件可以用MAT、VisualVM等工具查看，这里用jhat查看：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# jhat -port <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">9998</span> /tmp/dump.dat
Reading from /tmp/dump.dat...
Dump file created Tue Jan <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">28</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">17</span>:<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">46</span>:<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">14</span> CST <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2014</span>
Snapshot read, resolving...
Resolving <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">132207</span> objects...
Chasing references, expect <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">26</span> dots..........................
Eliminating duplicate references..........................
Snapshot resolved.
Started HTTP server on port <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">9998</span>
Server is ready.</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">     注意如果Dump文件太大，可能需要加上-J-Xmx512m这种参数指定最大堆内存，即jhat -J-Xmx512m -port 9998 /tmp/dump.dat。然后就可以在浏览器中输入主机地址:9998查看了：</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><img src="http://static.oschina.net/uploads/space/2014/0128/174715_FTKZ_111708.png" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; margin: auto; max-width: 80%; height: auto;" alt="" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    上面红线框出来的部分大家可以自己去摸索下，最后一项支持OQL（对象查询语言）。</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><br style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">D、</span></span><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; line-height: 22.5px;">jstat（JVM统计监测工具）</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    语法格式如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">jstat</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[ generalOption | outputOptions vmid [interval[s|ms]</span> <span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[count]</span>] ]</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    vmid是Java虚拟机ID，在Linux/Unix系统上一般就是进程ID。interval是采样时间间隔。count是采样数目。比如下面输出的是GC信息，采样时间间隔为250ms，采样数为4：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs less" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">root<span class="hljs-variable" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">@ubuntu:</span>/# jstat -gc <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">21711</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">250</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4</span>
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT   
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">64.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.0</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">6144.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1854.9</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32000.0</span>     <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4111.6</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">55296.0</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25472.7</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">702</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.431</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3</span>      <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.218</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.649</span>
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">64.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.0</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">6144.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1972.2</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32000.0</span>     <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4111.6</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">55296.0</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25472.7</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">702</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.431</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3</span>      <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.218</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.649</span>
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">64.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.0</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">6144.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">1972.2</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32000.0</span>     <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4111.6</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">55296.0</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25472.7</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">702</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.431</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3</span>      <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.218</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.649</span>
<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>  <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">192.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">64.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.0</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">6144.0</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">2109.7</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">32000.0</span>     <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">4111.6</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">55296.0</span> <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">25472.7</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">702</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.431</span>   <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3</span>      <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.218</span>    <span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">0.649</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    要明白上面各列的意义，先看JVM堆内存布局：</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><img src="http://static.oschina.net/uploads/space/2014/0128/181847_dAR9_111708.jpg" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; margin: auto; max-width: 80%; height: auto;" alt="" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    可以看出：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs gradle" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs gradle" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">堆内存 = 年轻代 + 年老代 + 永久代
年轻代 = Eden区 + 两个Survivor区（<span class="hljs-keyword" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">From</span>和To）</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    现在来解释各列含义：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">S0C、S1C、S0U、S1U：Survivor 0/1区容量（Capacity）和使用量（Used）
EC、EU：Eden区容量和使用量
OC、OU：年老代容量和使用量
PC、PU：永久代容量和使用量
YGC、YGT：年轻代GC次数和GC耗时
FGC、FGCT：Full GC次数和Full GC耗时
GCT：GC总耗时</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><br style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;" /></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">E、</span>hprof（Heap/CPU Profiling Tool）</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    hprof能够展现CPU使用率，统计堆内存使用情况。</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    语法格式如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs css" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">java</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">-agentlib</span><span class="hljs-selector-pseudo" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">:hprof</span><span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[=options]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">ToBeProfiledClass</span>
<span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">java</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">-Xrunprof</span><span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[:options]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">ToBeProfiledClass</span>
<span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">javac</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">-J-agentlib</span><span class="hljs-selector-pseudo" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">:hprof</span><span class="hljs-selector-attr" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">[=options]</span> <span class="hljs-selector-tag" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(227, 206, 171);">ToBeProfiledClass</span></code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    完整的命令选项如下：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs makefile" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs makefile" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">Option Name and Value  Description                    Default
---------------------  -----------                    -------
heap=dump|sites|all    heap profiling                 all
cpu=samples|times|old  CPU usage                      off
monitor=y|n            monitor contention             n
format=a|b             text(txt) or binary output     a
file=&lt;file&gt;            write data to file             java.hprof[.txt]
net=&lt;host&gt;:&lt;port&gt;      send data over a socket        off
depth=&lt;size&gt;           stack trace depth              4
interval=&lt;ms&gt;          sample interval in ms          10
cutoff=&lt;value&gt;         output cutoff point            0.0001
lineno=y|n             line number in traces?         y
thread=y|n             thread in traces?              n
doe=y|n                dump on exit?                  y
msa=y|n                Solaris micro state accounting n
force=y|n              force output to &lt;file&gt;         y
verbose=y|n            print messages about dumps     y</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    来几个官方指南上的实例。</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    CPU Usage Sampling Profiling(cpu=samples)的例子：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs nginx" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs nginx" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">java</span> -agentlib:hprof=cpu=samples,interval=<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">20</span>,depth=<span class="hljs-number" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(140, 208, 211);">3</span> Hello</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    上面每隔20毫秒采样CPU消耗信息，堆栈深度为3，生成的profile文件名称是java.hprof.txt，在当前目录。 </p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    CPU Usage Times Profiling(cpu=times)的例子，它相对于CPU Usage Sampling Profile能够获得更加细粒度的CPU消耗信息，能够细到每个方法调用的开始和结束，它的实现使用了字节码注入技术（BCI）：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs bash" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs bash" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;">javac -J-agentlib:hprof=cpu=<span class="hljs-built_in" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(204, 147, 147);">times</span> Hello.java</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    Heap Allocation Profiling(heap=sites)的例子：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs nginx" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs nginx" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">javac</span> -J-agentlib:hprof=heap=sites Hello.java</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    Heap Dump(heap=dump)的例子，它比上面的Heap Allocation Profiling能生成更详细的Heap Dump信息：</p><pre class="brush:shell;toolbar: true; auto-links: false; hljs nginx" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; overflow-x: auto; padding: 2px; color: rgb(220, 220, 220); border-radius: 3px; line-height: 1.4; word-wrap: normal; font-size: 13px; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background: rgb(63, 63, 63);"><code class="hljs nginx" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; display: block; overflow-x: auto; padding: 10px; border-radius: 4px; line-height: 1.4; word-wrap: normal; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span class="hljs-attribute" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; color: rgb(239, 220, 188);">javac</span> -J-agentlib:hprof=heap=dump Hello.java</code></pre><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">    <span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;">虽然在JVM启动参数中加入-Xrunprof:heap=sites参数可以生成CPU/Heap Profile文件，但对JVM性能影响非常大，不建议在线上服务器环境使用。</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;"><br style="box-sizing: inherit; -webkit-tap-highlight-color: transparent;" /></span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;"><span style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; font-size: 12.5px;">其他JVM性能调优参考资料：</span></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">《Java虚拟机规范》</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">《Java Performance》</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">《Trouble Shooting Guide for JavaSE 6 with HotSpot VM》: <a target="_blank" href="http://www.oracle.com/technetwork/java/javase/tsg-vm-149989.pdf" rel="nofollow" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; outline: 0px; transition: color 0.3s; text-decoration: none; color: rgb(68, 102, 187);">http://www.oracle.com/technetwork/java/javase/tsg-vm-149989.pdf</a> </p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">《Effective Java》</p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">VisualVM: <a target="_blank" href="http://docs.oracle.com/javase/7/docs/technotes/guides/visualvm/" rel="nofollow" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; outline: 0px; transition: color 0.3s; text-decoration: none; color: rgb(68, 102, 187);">http://docs.oracle.com/javase/7/docs/technotes/guides/visualvm/</a></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">jConsole: <a target="_blank" href="http://docs.oracle.com/javase/1.5.0/docs/guide/management/jconsole.html" rel="nofollow" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; outline: 0px; transition: color 0.3s; text-decoration: none; color: rgb(68, 102, 187);">http://docs.oracle.com/javase/1.5.0/docs/guide/management/jconsole.html</a></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">Monitoring and Managing JavaSE 6 Applications: <a target="_blank" href="http://www.oracle.com/technetwork/articles/javase/monitoring-141801.html" rel="nofollow" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; outline: 0px; transition: color 0.3s; text-decoration: none; color: rgb(68, 102, 187);">http://www.oracle.com/technetwork/articles/javase/monitoring-141801.html</a></p><p style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; margin-bottom: 16px;">BTrace：<a target="_blank" href="https://kenai.com/projects/btrace" rel="nofollow" style="box-sizing: inherit; -webkit-tap-highlight-color: transparent; border: none; outline: 0px; transition: color 0.3s; text-decoration: none; color: rgb(68, 102, 187);">https://kenai.com/projects/btrace</a></p></div></div>   &#13;
