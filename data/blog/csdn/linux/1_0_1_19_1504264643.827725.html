
<span style="font-size:18px;"><strong><span style="font-family: 宋体, Arial; line-height: 26px;">asmlinkage是个宏，使用它是为了保持参数在stack中。</span><br style="word-wrap: break-word; font-family: 宋体, Arial; line-height: 26px;" /><br style="word-wrap: break-word; font-family: 宋体, Arial; line-height: 26px;" /></strong></span><div style="word-wrap: break-word; font-family: &#x5B8B;&#x4F53;, Arial; line-height: 26px;"><span style="font-size:18px;"><strong>看一下/usr/include/asm/linkage.h里面的定义：<br style="word-wrap: break-word;" />#define asmlinkage CPP_ASMLINKAGE __attribute__((regparm(0)))<br style="word-wrap: break-word;" /><br style="word-wrap: break-word;" />其中 __attribute__是关键字，是gcc的C语言扩展。<br style="word-wrap: break-word;" /><br style="word-wrap: break-word;" />__attribute__机制是GNU C的一大特色，它可以设置函数属性、变量属性和类型属性等。可以通过它们向编译器提供更多数据，帮助编译器执行优化等。<br style="word-wrap: break-word;" />__attribute__((regparm(0)))：告诉gcc编译器该函数不需要通过任何寄存器来传递参数，参数只是通过堆栈来传递。<br style="word-wrap: break-word;" />__attribute__((regparm(3)))：告诉gcc编译器这个函数可以通过寄存器传递多达3个的参数，这3个寄存器依次为EAX、EDX 和 ECX。更多的参数才通过堆栈传递。这样可以减少一些入栈出栈操作，因此调用比较快。<br style="word-wrap: break-word;" /><span class="body" style="word-wrap: break-word;"></span><br style="word-wrap: break-word;" />asmlinkage大都用在系统调用中。<span class="body" style="word-wrap: break-word;">有一些情况下是需要明确的告诉编译器，我们是使用stack来传递参数的，比如X86中的系统调用，是先将参数压入stack以后调用sys_*函数的，所以所有的sys_*函数都有asmlinkage来告诉编译器不要使用寄存器来编译，</span><br style="word-wrap: break-word;" /><br style="word-wrap: break-word;" /><span style="color:#ff0000;">The asmlinkage tag is one other thing that we should observe about this simple function. This is a #define for some gcc magic that tells the compiler that the function should not expect to find any of its arguments in registers (a common optimization), but only on the CPU's stack. Recall our earlier assertion that system_call consumes its first argument, the system call number, and allows up to four more arguments that are passed along to the real system call. system_call achieves this feat simply by leaving its other arguments (which were passed to it in registers) on the stack. All system calls are marked with the asmlinkage tag, so they all look to the stack for arguments. Of course, in sys_ni_syscall's case, this doesn't make any difference, because sys_ni_syscall doesn't take any arguments, but it's an issue for most other system calls. And, because you'll be seeing asmlinkage in front of many other functions, I thought you should know what it was about.</span></strong></span></div>   &#13;
