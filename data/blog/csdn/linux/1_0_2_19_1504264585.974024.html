
<p></p><p><br /></p><h2><strong>路由表</strong></h2><h3><strong>内核中路由表有<span style="font-family:Calibri;">2</span><span style="font-family:宋体;">种：</span></strong></h3><p>l 一个是缓存路由（<span style="font-family:Calibri;">fib</span><span style="font-family:宋体;">），是自动学习生成自动管理的，用户没必要去干预，但是内核还是提供了方法让用户可以去清空它。但是用户不能设置它的项，但是可以根据这个缓存更新的原理从外部影响他。</span></p><p>l 路由表：一共有<span style="font-family:Calibri;">256</span><span style="font-family:宋体;">个，在内核中是一个数组，可以配置让内核使用其中的一个或者多个。默认的是使用</span><span style="font-family:Calibri;">0</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">254</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">255</span><span style="font-family:宋体;">这三个。一般大家关系都是</span><span style="font-family:Calibri;">254</span><span style="font-family:宋体;">号的</span><span style="font-family:Calibri;">main</span><span style="font-family:宋体;">路由，</span><span style="font-family:Calibri;">route </span><span style="font-family:宋体;">命令看到的和操作的都是这个路由表。</span><span style="font-family:Calibri;">255</span><span style="font-family:宋体;">是</span><span style="font-family:Calibri;">local</span><span style="font-family:宋体;">路由，还包含了广播地址等，</span><span style="font-family:Calibri;">0</span><span style="font-family:宋体;">是全路由，还包括了</span><span style="font-family:Calibri;">ipv6</span><span style="font-family:宋体;">的，是最全面的。但是</span><span style="font-family:Calibri;">254</span><span style="font-family:宋体;">的主路由是最容易看，也是用户最关心的，所以</span><span style="font-family:Calibri;">route</span><span style="font-family:宋体;">命令只操作这个路由表。选择使用哪个路由表叫做留有策略，这个也是可以通过</span><span style="font-family:Calibri;">ip rule</span><span style="font-family:宋体;">命令配置的。</span></p><h3><strong>路由表里面的路由类型有<span style="font-family:Calibri;">6</span><span style="font-family:宋体;">种，我们平时见的最多的是单播和网段类型的：</span></strong></h3><p>l 单播。目的地址是某一个<span style="font-family:Calibri;">ip</span><span style="font-family:宋体;">，一般是手动添加的。</span></p><p>l 网段。这个是最常见的，到达某个网段需要从哪里发送出去</p><p>l Nat<span style="font-family:宋体;">。是的，</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">也是路由的一种，他会修改掉</span><span style="font-family:Calibri;">ip</span><span style="font-family:宋体;">的地址域为要到达的地址。之所以</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">也是路由的一种是因为，</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">也是一种形式的路由。这个</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">和</span><span style="font-family:Calibri;">iptable</span><span style="font-family:宋体;">的</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">是同时存在的两种不同的机制。</span></p><p>l Unreachable<span style="font-family:宋体;">：不可达类型的路由。我们经常看到不可达，通常是因为没有配置到目的地址的路由，或者是配置的不对。但是还可以单独的配置一个不可达类型的路由，即使他是可达的。</span></p><p>l Prohibit<span style="font-family:宋体;">：禁止类型的路由。到某个地址的路由默认都是添加的如何到达，但是也可以添加如何禁止。同样是到某个网段或地址的路由，可以在某个网口上设置其禁止，这个与实际的到不了不再一个层次。这个是查路由的时候路由表告诉你的这个网段是被禁止的。</span></p><p>l Blackhole<span style="font-family:宋体;">：到达目标网段的所有数据包都可以查到，但是都会直接被丢弃。也就是这是一个欺骗的路由条目。你以为你查到了，你以为你发出去了，其实都被悄悄地丢掉了。</span></p><p align="justify"> </p><p align="justify">这些种类的路由由于功能和路由策略重合，同时使用比较混乱，所以如果要实现复杂的路由，就应该使用路由策略规则，而不是这里的路由类型。</p><h3><strong>路由表查询匹配算法</strong></h3><p align="justify">路由表的查询匹配算法一般是<span style="font-family:Calibri;">lpm</span><span style="font-family:宋体;">（</span><span style="font-family:Calibri;">longest prefix match</span><span style="font-family:宋体;">），这种算法适合于不同精细度的网段，允许匹配最精细的网段设置，如果没有更精细的则匹配当前的。最不精细的等级就是</span><span style="font-family:Calibri;">0.0.0.0</span><span style="font-family:宋体;">网段，可以匹配全部的网段。</span></p><p align="justify"> </p><h2><strong>路由策略</strong></h2><p>每一个路由表都对应一个路由策略，默认的路由策略最简单，就是查询表即可。默认也有<span style="font-family:Calibri;">3</span><span style="font-family:宋体;">个路由策略：</span></p><p><span style="font-family:宋体;"><img src="http://img.blog.csdn.net/20160516123713911?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br /></span></p><p> </p><p>所以，我们自己添加了一个<span style="font-family:Calibri;">0</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">254</span><span style="font-family:宋体;">，</span><span style="font-family:Calibri;">255</span><span style="font-family:宋体;">之外的路由表之后，这个路由表也是不会正常的工作的，路由表只是数据库，查不查询，怎么查询是由路由策略决定的。自己添加了路由表之后要想让这个路由表被查询，需要添加一个对应的路由策略。默认的路由策略都是</span><span style="font-family:Calibri;">lookup</span><span style="font-family:宋体;">，就是我们通常意义的查询行为，还有其他的路由策略行为：</span></p><p align="justify">l Nat<span style="font-family:宋体;">：查询到的路由是用来做</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">的。对应的路由表中一般是有很多</span><span style="font-family:Calibri;">nat</span><span style="font-family:宋体;">类型的路由表</span></p><p align="justify">l Unreachable<span style="font-family:宋体;">：所有在对应的路由表中查到的路由条目都给出</span><span style="font-family:Calibri;">unreachable</span><span style="font-family:宋体;">的答案</span></p><p align="justify">l Prohibit<span style="font-family:宋体;">：所有在对应的路由表中查到的路由条目都给出</span><span style="font-family:Calibri;">prohibit</span><span style="font-family:宋体;">的答案</span></p><p align="justify">l Blackhole<span style="font-family:宋体;">：所有在对应的路由表中查到的路由条目都直接丢弃</span></p><p align="justify"> </p><p align="justify">路由策略从第一个开始向后查询，进入查询每个策略对应的路由表，如果查到了，就采取对应的路由策略规定的行为。</p><h2><strong>路由查找流程</strong></h2><p>路由会现在缓存（<span style="font-family:Calibri;">fib</span><span style="font-family:宋体;">）中查找，找不到则到路由表中查找。但是这个在路由表中查找并不但单纯的去查表，网上很多资料都是描述的仿佛是直接去查路由表，匹配目的地址，但这已经是</span><span style="font-family:Calibri;">2.2</span><span style="font-family:宋体;">版本内核之前的事情了。现在的流程复杂的多。</span></p><p>以前的路由查找，只是单纯的根据目的<span style="font-family:Calibri;">ip</span><span style="font-family:宋体;">地址来进行</span><span style="font-family:Calibri;">lpm</span><span style="font-family:宋体;">匹配查询，而现在的策略路由支持根据其他的域，比如源地址，</span><span style="font-family:Calibri;">tos</span><span style="font-family:宋体;">，来的端口等来决定匹配的策略（这些叫做</span><span style="font-family:Calibri;">selector</span><span style="font-family:宋体;">）。当然，路由表还是单纯的目的地址匹配，支持多种匹配的是路由策略（</span><span style="font-family:Calibri;">rule</span><span style="font-family:宋体;">）。</span></p>   &#13;
