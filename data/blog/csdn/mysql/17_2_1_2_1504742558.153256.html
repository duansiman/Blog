
<div id="blog_content" class="blog_content">    <div style="font-size: 14px;" class="iteye-blog-content-contain"><p><span style="font-family:Microsoft YaHei;font-size:18px;">上一篇文章《<a target="_blank" href="http://chenzhou123520.iteye.com/blog/1860954" title="MySQL悲观锁总结和实践">MySQL悲观锁总结和实践</a>》谈到了MySQL悲观锁，但是悲观锁并不是适用于任何场景，它也有它存在的一些不足，因为<span style="color:#ff0000;background-color: #ffffff;">悲观锁大多数情况下依靠数据库的锁机制实现</span>，以保证操作最大程度的独占性。<span style="color:#ff0000;">如果加锁的时间过长，其他用户长时间无法访问，影响了程序的并发访问性，同时这样对数据库性能开销影响也很大</span>，特别是对长事务而言，这样的开销往往无法承受。所以与悲观锁相对的，我们有了乐观锁，具体参见下面介绍：</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"> </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"><strong>乐观锁介绍：</strong></span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">乐观锁（ Optimistic Locking ） 相对悲观锁而言，<span style="line-height: 1.5;">乐观锁假设认为数据一般情况下不会造成冲突</span>，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则让返回用户错误的信息，让用户决定如何去做。那么我们如何实现乐观锁呢，一般来说有以下2种方式：</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"><span style="line-height: 1.5;">1.使用数据版本（Version）记录机制实现，这是乐观锁最常用的一种实现方式。何谓数据版本？即为数据增加一个版本标识，一般是通过为数据库表增加一个数字类型的 “version” 字段来实现。当读取数据时，将version字段的值一同读出，数据每更新一次，对此version值加一。当我们提交更新的时候，判断数据库表对应记录的当前版本信息与第一次取出来的version值进行比对，如果数据库表当前版本号与第一次取出来的version值相等，则予以更新，否则认为是过期数据。用下面的一张图来说明：</span><img alt="" src="http://dl.iteye.com/upload/picture/pic/125402/22a9518f-e355-315f-8d66-d91af4fda723.jpg" title="点击查看原始大小图片" class="magplus" width="700" height="471" /></span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">如上图所示，如果更新操作顺序执行，则数据的版本（version）依次递增，不会产生冲突。但是如果发生有不同的业务操作对同一版本的数据进行修改，那么，先提交的操作（图中B）会把数据version更新为2，当A在B之后提交更新时发现数据的version已经被修改了，那么A的更新操作会失败。</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"> </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">2.乐观锁定的第二种实现方式和第一种差不多，同样是在需要乐观锁控制的table中增加一个字段，名称无所谓，字段类型使用时间戳（timestamp）, 和上面的version类似，也是在更新提交的时候检查当前数据库中数据的时间戳和自己更新前取到的时间戳进行对比，如果一致则OK，否则就是版本冲突。</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"> </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"><strong>使用举例</strong>：以MySQL InnoDB为例</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">还是拿之前的实例来举：商品goods表中有一个字段status，status为1代表商品未被下单，status为2代表商品已经被下单，那么我们对某个商品下单时必须确保该商品status为1。假设商品的id为1。</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"> </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">下单操作包括3步骤：</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">1.查询出商品信息</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">select (status,status,<span style="color:#ff0000;">version</span>) from t_goods where id=#{id}</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">2.根据商品信息生成订单</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">3.修改商品status为2</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">update t_goods </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">set status=2,<span style="color:#ff0000;">version=version+1</span></span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">where id=#{id} <span style="color:#ff0000;">and version=#{version}</span>;</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"> </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">那么为了使用乐观锁，我们首先修改t_goods表，增加一个version字段，数据默认version值为1。</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">t_goods表初始数据如下：</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Sql代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-sql"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span>mysql&gt; </span><span class="keyword">select</span><span> * </span><span class="keyword">from</span><span> t_goods;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>+<span class="comment">----+--------+------+---------+</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>| id | status | <span class="keyword">name</span><span> | version |  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>+<span class="comment">----+--------+------+---------+</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>|  1 |      1 | 道具 |       1 |  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>|  2 |      2 | 装备 |       2 |  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>+<span class="comment">----+--------+------+---------+</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>2 <span class="keyword">rows</span><span> </span><span class="op">in</span><span> </span><span class="keyword">set</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>mysql&gt;  </span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">对于乐观锁的实现，我使用MyBatis来进行实践，具体如下：</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">Goods实体类：</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Java代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-j"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * ClassName: Goods &lt;br/&gt;</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * Function: 商品实体. &lt;br/&gt;</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * date: 2013-5-8 上午09:16:19 &lt;br/&gt;</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * @author chenzhou1025@126.com</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="keyword">public</span><span> </span><span class="keyword">class</span><span> Goods </span><span class="keyword">implements</span><span> Serializable {  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     * serialVersionUID:序列化ID.</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">private</span><span> </span><span class="keyword">static</span><span> </span><span class="keyword">final</span><span> </span><span class="keyword">long</span><span> serialVersionUID = 6803791908148880587L;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     * id:主键id.</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">private</span><span> </span><span class="keyword">int</span><span> id;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     * status:商品状态：1未下单、2已下单.</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">private</span><span> </span><span class="keyword">int</span><span> status;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     * name:商品名称.</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">private</span><span> String name;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     * version:商品数据版本号.</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">     */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">private</span><span> </span><span class="keyword">int</span><span> version;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="annotation">@Override</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">public</span><span> String toString(){  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>        <span class="keyword">return</span><span> </span><span class="string">"good id:"</span><span>+id+</span><span class="string">",goods status:"</span><span>+status+</span><span class="string">",goods name:"</span><span>+name+</span><span class="string">",goods version:"</span><span>+version;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    }  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">//setter and getter</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>}  </span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">GoodsDao</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Java代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-j"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment">/**</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * updateGoodsUseCAS:使用CAS(Compare and set)更新商品信息. &lt;br/&gt;</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> *</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * @author chenzhou1025@126.com</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * @param goods 商品对象</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> * @return 影响的行数</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="comment"> */</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="keyword">int</span><span> updateGoodsUseCAS(Goods goods);  </span></span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">mapper.xml</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Xml代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-xml"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="tag">&lt;</span><span class="tag-name">update</span><span> </span><span class="attribute">id</span><span>=</span><span class="attribute-value">"updateGoodsUseCAS"</span><span> </span><span class="attribute">parameterType</span><span>=</span><span class="attribute-value">"Goods"</span><span class="tag">&gt;</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="cdata">&lt;![CDATA[</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="cdata">        update t_goods</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="cdata">        set status=#{status},name=#{name},version=version+1</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="cdata">        where id=#{id} and version=#{version}</span> </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="cdata">    ]]&gt;</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="tag">&lt;/</span><span class="tag-name">update</span><span class="tag">&gt;</span><span>  </span></span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">GoodsDaoTest测试类</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Java代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-j"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="annotation">@Test</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="keyword">public</span><span> </span><span class="keyword">void</span><span> goodsDaoTest(){  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">int</span><span> goodsId = </span><span class="number">1</span><span>;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">//根据相同的id查询出商品信息，赋给2个对象</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    Goods goods1 = <span class="keyword">this</span><span>.goodsDao.getGoodsById(goodsId);  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    Goods goods2 = <span class="keyword">this</span><span>.goodsDao.getGoodsById(goodsId);  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">//打印当前商品信息</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    System.out.println(goods1);  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    System.out.println(goods2);  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">//更新商品信息1</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    goods1.setStatus(<span class="number">2</span><span>);</span><span class="comment">//修改status为2</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">int</span><span> updateResult1 = </span><span class="keyword">this</span><span>.goodsDao.updateGoodsUseCAS(goods1);  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    System.out.println(<span class="string">"修改商品信息1"</span><span>+(updateResult1==</span><span class="number">1</span><span>?</span><span class="string">"成功"</span><span>:</span><span class="string">"失败"</span><span>));  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>      </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="comment">//更新商品信息2</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    goods1.setStatus(<span class="number">2</span><span>);</span><span class="comment">//修改status为2</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    <span class="keyword">int</span><span> updateResult2 = </span><span class="keyword">this</span><span>.goodsDao.updateGoodsUseCAS(goods1);  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>    System.out.println(<span class="string">"修改商品信息2"</span><span>+(updateResult2==</span><span class="number">1</span><span>?</span><span class="string">"成功"</span><span>:</span><span class="string">"失败"</span><span>));  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>}  </span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">输出结果：</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Shell代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-default"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span>good id:</span><span class="number">1</span><span>,goods status:</span><span class="number">1</span><span>,goods name:道具,goods version:</span><span class="number">1</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>good id:<span class="number">1</span><span>,goods status:</span><span class="number">1</span><span>,goods name:道具,goods version:</span><span class="number">1</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>修改商品信息<span class="number">1</span><span>成功  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>修改商品信息<span class="number">2</span><span>失败  </span></span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">说明：</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">在GoodsDaoTest测试方法中，我们同时查出同一个版本的数据，赋给不同的goods对象，然后先修改good1对象然后执行更新操作，执行成功。然后我们修改goods2，执行更新操作时提示操作失败。此时t_goods表中数据如下：</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Sql代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-sql"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span>mysql&gt; </span><span class="keyword">select</span><span> * </span><span class="keyword">from</span><span> t_goods;  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>+<span class="comment">----+--------+------+---------+</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>| id | status | <span class="keyword">name</span><span> | version |  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>+<span class="comment">----+--------+------+---------+</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>|  1 |      2 | 道具 |       2 |  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>|  2 |      2 | 装备 |       2 |  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>+<span class="comment">----+--------+------+---------+</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>2 <span class="keyword">rows</span><span> </span><span class="op">in</span><span> </span><span class="keyword">set</span><span>  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>  </span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span>mysql&gt;   </span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">我们可以看到 id为1的数据version已经在第一次更新时修改为2了。所以我们更新good2时update where条件已经不匹配了，所以更新不会成功，具体sql如下：</span></p><div class="dp-highlighter" id=""><div class="bar"><div class="tools"><span style="font-family:Microsoft YaHei;font-size:18px;">Sql代码  <a target="_blank" title="收藏这段代码"><img class="star" src="http://chenzhou123520.iteye.com/images/icon_star.png" alt="收藏代码" /></a></span></div></div><ol start="1" class="dp-sql"><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="keyword">update</span><span> t_goods   </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="keyword">set</span><span> status=2,version=version+1  </span></span></span></li><li><span style="font-family:Microsoft YaHei;font-size:18px;"><span><span class="keyword">where</span><span> id=#{id} </span><span class="op">and</span><span> version=#{version};  </span></span></span></li></ol></div><p><span style="font-family:Microsoft YaHei;font-size:18px;">这样我们就实现了乐观锁</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"> </span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;">以上就是我对MySQL乐观锁的总结和实践，写得比较浅显，有不对的地方欢迎拍砖</span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"><br /></span></p><p><span style="font-family:Microsoft YaHei;font-size:18px;"><br /></span></p></div>  </div>   &#13;
