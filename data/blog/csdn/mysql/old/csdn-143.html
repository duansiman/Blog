\n <div class="markdown_views"><h1 id="mysql必知必会学习笔记游标的使用">《MySQL必知必会学习笔记》：游标的使用</h1>\n\n<p>游标是什么？？ <br />\n《MySQL必知必会》这本书上面的定义如下：</p>\n\n<blockquote>\n <p>游标是一个存储在MySQL服务器上的数据库查询，它不是一条select语句，而是被该语句所检索出来的结果集。</p>\n</blockquote>\n\n<p>给我的第一感觉，游标就像是JAVA和C++中的迭代器。可以用来一个一个的按顺序的取出结果集中的元素。</p>\n\n<p>MySQL游标只能用于存储过程(和函数)。游标主要用于交互式应用。</p>\n\n<h2 id="使用游标">使用游标</h2>\n\n<p>在介绍如何创建游标之前，先说明下如何使用游标。</p>\n\n<p>使用游标涉及几个明确的步骤。</p>\n\n<p>1、在能够使用游标前，必须先定义它。这个过程实际上是没有检索数据的，它只是定义要使用的select语句。</p>\n\n<p>2、一旦你定义了游标后，必须打开游标以供使用。这个过程用前面定义的select语句把数据实际检索出来。即这个步骤之后，我们就可以操作游标中的数据了。</p>\n\n<p>3、对于有数据的游标，根据需要取出各行的数据来进行一定的操作。</p>\n\n<p>4、使用完游标后，一定要关闭游标。</p>\n\n\n\n<h2 id="创建游标">创建游标</h2>\n\n<p>创建一个游标的语法如下：</p>\n\n<p>用declare 来定义，具体如下：</p>\n\n<p><img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_cursor_v01.PNG" alt="" title="" /></p>\n\n<p>上面是定义游标的一般形式，当我们定义了一个游标之后，我们就可以来打开它、使用它、关闭它。</p>\n\n<p><strong>打开游标</strong>：</p>\n\n<p>open cursor_name;</p>\n\n<p><strong>关闭游标</strong>：</p>\n\n<p>close cursor_name;</p>\n\n<p><strong>使用游标</strong>： <br />\n使用游标用fetch来取出数据，例如：fetch cursor_name in variable;//取出游标所指示的数据给局部变量variable</p>\n\n<p>下面这个例子就是演示了创建一个游标，打开游标及关闭游标，但没有对游标所指示的数据进行数据。</p>\n\n<p><img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_cursor_v1.PNG" alt="" title="" /></p>\n\n\n\n<h2 id="实例操作游标中的数据">实例：操作游标中的数据</h2>\n\n<p>需求是这样，我们手上有一个student2表，表中的结构和数据如下： <br />\n<img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_cursor_v2.PNG" alt="" title="" /></p>\n\n<p>现在我们需要将student2表中所有学生的的平均成绩(mathScore+englishScore的一半)合成一行，用逗号’,’隔开。</p>\n\n<p>对于这样一个需求，下面我们尝试用游标来实现。</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs oxygene">DELIMITER $$\n\n<span class="hljs-keyword">CREATE</span>\n <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> `<span class="hljs-title">test</span>`.`<span class="hljs-title">procedure_student2</span>`<span class="hljs-params">()</span>\n <span class="hljs-title">BEGIN</span>\n -- <span class="hljs-title">declare</span> <span class="hljs-title">some</span> <span class="hljs-title">variable</span>，必须在声明游标和句柄之前，而声明句柄必须在声明游标之后。\n <span class="hljs-title">DECLARE</span> <span class="hljs-title">val</span> <span class="hljs-title">DOUBLE</span> <span class="hljs-title">DEFAULT</span> 0;</span>\n DECLARE tempRes VARCHAR(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>;\n DECLARE res VARCHAR(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span> ;\n -- declare a cursor\n DECLARE cursor_avgScore CURSOR\n <span class="hljs-keyword">FOR</span>\n <span class="hljs-keyword">SELECT</span> (mathScore+englishScore)/<span class="hljs-number">2</span> <span class="hljs-keyword">AS</span> student_avgScore <span class="hljs-keyword">FROM</span> student2;\n -- declare a <span class="hljs-keyword">continue</span> handler ,use finish <span class="hljs-keyword">while</span> <span class="hljs-keyword">loop</span> \n DECLARE <span class="hljs-keyword">CONTINUE</span> HANDLER <span class="hljs-keyword">FOR</span> SQLSTATE <span class="hljs-string">'02000'</span> <span class="hljs-keyword">SET</span> val= -<span class="hljs-number">1.0</span> ; \n -- open cursor\n OPEN cursor_avgScore ;\n FETCH cursor_avgScore <span class="hljs-keyword">INTO</span> val;\n -- fetch cursor\n <span class="hljs-keyword">WHILE</span> val!=-<span class="hljs-number">1</span> <span class="hljs-keyword">DO</span>\n <span class="hljs-keyword">SET</span> tempRes=<span class="hljs-keyword">CONCAT</span>(val,<span class="hljs-string">', '</span>);\n <span class="hljs-keyword">SET</span> res=<span class="hljs-keyword">CONCAT</span>(res,tempRes);\n FETCH cursor_avgScore <span class="hljs-keyword">INTO</span> val;\n <span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span>; \n -- close cursor\n CLOSE cursor_avgScore ;\n -- 显示结果\n <span class="hljs-keyword">SELECT</span> res;\n <span class="hljs-keyword">END</span>$$\n\nDELIMITER ;</code></pre>\n\n<p>调用此存储过程</p>\n\n<p>CALL procedure_student2();</p>\n\n<p>运行结果如下：</p>\n\n<p><img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_cursor_v4.PNG" alt="" title="" /></p>\n\n<p>上面这个是利用了while循环来一个一个的获取游标中的数据，在MySQL中我们还可以用repeat来做。</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs oxygene">DELIMITER $$\n\n<span class="hljs-keyword">CREATE</span>\n <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> `<span class="hljs-title">test</span>`.`<span class="hljs-title">procedure_student_v1</span>`<span class="hljs-params">()</span> \n <span class="hljs-title">BEGIN</span>\n -- <span class="hljs-title">declare</span> <span class="hljs-title">some</span> <span class="hljs-title">variable</span>，必须在声明游标和句柄之前，而声明句柄必须在声明游标之后。\n <span class="hljs-title">DECLARE</span> <span class="hljs-title">val</span> <span class="hljs-title">DOUBLE</span> <span class="hljs-title">DEFAULT</span> 0;</span>\n DECLARE tempRes VARCHAR(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>;\n DECLARE res VARCHAR(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span> ;\n -- declare a cursor\n DECLARE cursor_avgScore CURSOR\n <span class="hljs-keyword">FOR</span>\n <span class="hljs-keyword">SELECT</span> (mathScore+englishScore)/<span class="hljs-number">2</span> <span class="hljs-keyword">AS</span> student_avgScore <span class="hljs-keyword">FROM</span> student2;\n -- declare a <span class="hljs-keyword">continue</span> handler ,use finish <span class="hljs-keyword">while</span> <span class="hljs-keyword">loop</span> \n DECLARE <span class="hljs-keyword">CONTINUE</span> HANDLER <span class="hljs-keyword">FOR</span> SQLSTATE <span class="hljs-string">'02000'</span> <span class="hljs-keyword">SET</span> val= -<span class="hljs-number">1.0</span> ; \n -- open cursor\n OPEN cursor_avgScore ; \n -- fetch cursor\n <span class="hljs-keyword">REPEAT</span> \n FETCH cursor_avgScore <span class="hljs-keyword">INTO</span> val;\n <span class="hljs-keyword">IF</span> val!=-<span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span>\n <span class="hljs-keyword">SET</span> tempRes=<span class="hljs-keyword">CONCAT</span>(val,<span class="hljs-string">', '</span>);\n <span class="hljs-keyword">SET</span> res=<span class="hljs-keyword">CONCAT</span>(res,tempRes);\n <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;\n <span class="hljs-keyword">UNTIL</span> val=-<span class="hljs-number">1</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">REPEAT</span>; -- 居然MySQL中 用 val=-<span class="hljs-number">1</span> 来结束循环，原以为应该和java、c类似，用val==-<span class="hljs-number">1</span>来结束。 \n -- close cursor\n CLOSE cursor_avgScore ;\n -- 显示结果\n <span class="hljs-keyword">SELECT</span> res;\n <span class="hljs-keyword">END</span>$$\n\nDELIMITER ;</code></pre>\n\n<p>写这两个存储过程遇到了很多问题也，是由于语法不熟练导致的。呜呜。</p>\n\n<p>例如：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs fsharp">UNTIL <span class="hljs-keyword">val</span>=-<span class="hljs-number">1</span> END REPEAT; -- 居然MySQL中 用 <span class="hljs-keyword">val</span>=-<span class="hljs-number">1</span> 来结束循环，原以为应该和java、c类似，用<span class="hljs-keyword">val</span>==-<span class="hljs-number">1</span>来结束。 </code></pre>\n\n<p>以及</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs php"><span class="hljs-keyword">WHILE</span> val!=-<span class="hljs-number">1</span> <span class="hljs-keyword">DO</span> -- 后面要加上一个<span class="hljs-keyword">DO</span></code></pre>\n\n<p><font color="red" size="4">用JAVA、C写习惯了，写这些真的好不习惯也。</font></p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
