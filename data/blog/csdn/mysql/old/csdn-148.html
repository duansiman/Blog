\n <div class="markdown_views"><h1 id="mysql必知必会学习笔记触发器">《MySQL必知必会学习笔记》：触发器</h1>\n\n<p>什么是触发器？？？</p>\n\n<p>简单来说，就是监视某个事件A，触发某个动作(或事件)B。</p>\n\n<p>例如：当我们的订单中卖掉100个apple，则我们的商品表中的apple数量就要自动减少100.</p>\n\n<p>触发器是MySQL响应<strong>insert、update、delete</strong>这3个语句而自动执行的一条MySQL语句(或位于begin end之间的一组语句)。</p>\n\n\n\n<h2 id="创建触发器">创建触发器</h2>\n\n<p>创建触发器有4个要素：监视事件(insert/delete/update)、监视地点(table)、触发事件(一些操作)、触发时间(Before/after).</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql">DELIMITER $$\n\t<span class="hljs-operator"><span class="hljs-keyword">CREATE</span>\n <span class="hljs-keyword">TRIGGER</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`tg_insert`</span> <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> -- <span class="hljs-keyword">after</span> 为触发时间 -- <span class="hljs-keyword">insert</span> 为监视事件\n <span class="hljs-keyword">ON</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`student`</span> -- student 为 监视地点\n <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">BEGIN</span> -- <span class="hljs-keyword">begin</span> <span class="hljs-keyword">end</span>中间的就是 触发事件，即要做的事情\n\t-- <span class="hljs-keyword">select</span> <span class="hljs-string">'insert date in student table'</span> ;</span>这句话报错：Not allowed to return a result <span class="hljs-operator"><span class="hljs-keyword">set</span> <span class="hljs-keyword">from</span> a <span class="hljs-keyword">trigger</span>\n\t<span class="hljs-keyword">SELECT</span> <span class="hljs-string">'insert data in student table'</span> <span class="hljs-keyword">INTO</span> @res;</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span>$$ \n DELIMITER ;</span></code></pre>\n\n<p>上面这个例子的触发器的四要素如下</p>\n\n<p>监视事件为：insert</p>\n\n<p>监视地点：表student</p>\n\n<p>触发事件：SELECT ‘insert data in student table’ INTO @res;//将此字符串保存到变量@res中</p>\n\n<p>触发时间：after。</p>\n\n\n\n<h2 id="删除触发器">删除触发器</h2>\n\n<p>触发器不能更新，只能删除，删除命令如下：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">trigger</span> tg_name;</span></code></pre>\n\n\n\n<h2 id="触发器例子讲解">触发器例子讲解</h2>\n\n<p><font color="red">触发器按每个表每个事件每次地定义，每个表每个事件每次只允许一个触发器。因此，每个表最多支持6个触发器(每条insert、update和delete的before和after)；单一触发器不能与多个事件或多个表关联。</font></p>\n\n<p>下面就以买卖火车票进行讲解。我们都知道，当我们下一个订单之后就表示我们将买一张(或多张)某地点的火车票，因此剩余火车票表中相应的数据就要进行一定的更新处理。否则就会出现一直看着有票但是一直买不到的情况(虽然现实生活中买火车票时就是这样，看着看着有很多票，一下子就没了)。</p>\n\n<p>现在我们创建2个表，一个表为订单，一个表为火车票剩余票的表。</p>\n\n<p>创建表的命令如下：</p>\n\n<p>订单表如下：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> ordersintrain(\n id <span class="hljs-keyword">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">primary</span> <span class="hljs-keyword">key</span> auto_increment,\n trainID <span class="hljs-keyword">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,\n buyTicketNum <span class="hljs-keyword">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);</span></code></pre>\n\n<p>火车票库存表如下：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> ticket(\n trainID <span class="hljs-keyword">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,\n remainderNum <span class="hljs-keyword">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);</span></code></pre>\n\n<p>创建此表之后，我们为ticket添加了如下的内容：</p>\n\n<p><img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_trigger_v1.PNG" alt="" title="" /></p>\n\n<p>即由3趟火车，每趟火车现在的余票为100张。</p>\n\n<p>现在我们创建一个触发器，触发器的作用就是：当有人买票后，ticket的余票数要发生相应的变化。</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql">DELIMITER $$\n\n<span class="hljs-operator"><span class="hljs-keyword">CREATE</span>\n <span class="hljs-keyword">TRIGGER</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`tg_ticket`</span> <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span>\n <span class="hljs-keyword">ON</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`ordersintrain`</span>\n <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">BEGIN</span>\n <span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=remainderNum-new.buyTicketNum <span class="hljs-keyword">WHERE</span> trainID=new.trainID;</span> <span class="hljs-comment">-- new.trainID 指的是ordersintrain表中的trainID</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span>$$\n\nDELIMITER ;</span></code></pre>\n\n<p>有了触发器之后，我们为订单表ordersintrain插入一行内容，如下：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> ordersintrain(trainID,buyTicketNum) <span class="hljs-keyword">values</span>(<span class="hljs-number">424</span>,<span class="hljs-number">5</span>);</span></code></pre>\n\n<p>当执行完这条语句之后，ticket表中的结果就发生了相应的变化，如下：</p>\n\n<p><img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_trigger_v2.PNG" alt="" title="" /></p>\n\n<p>这就说明，我们的触发器起了作用。</p>\n\n<p>现在假设出现了一些情况，这个订单的买票的内容要发生变化，在我们的生活中比较常见，变化可能有如下两种情况：</p>\n\n<p>1、退几张票，不退完。</p>\n\n<p>2、撤销订单。</p>\n\n<p>面对这两种情况，应该怎么来写触发器呢？？</p>\n\n<p><font color="red" size="5">先看第一种情况</font></p>\n\n<p>触发器的四要素如下：</p>\n\n<p>监视地点：ordersintrain</p>\n\n<p>监视事件：update</p>\n\n<p>触发时间：after</p>\n\n<p>触发事件：更新ticket表</p>\n\n<p>对于update，被修改的行，修改前的数据用old 表示，old.列名引用被修改前行的数据，修改后的数据用 new 表示，new.列名引用被修改后行的数据。</p>\n\n<p>触发器的创建如下：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql">DELIMITER $$\n<span class="hljs-operator"><span class="hljs-keyword">CREATE</span>\n <span class="hljs-keyword">TRIGGER</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`tg_ticket_update`</span> <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">UPDATE</span>\n <span class="hljs-keyword">ON</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`ordersintrain`</span>\n <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">BEGIN</span>\n\t<span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=remainderNum+old.buyTicketNum-new.buyTicketNum <span class="hljs-keyword">WHERE</span> trainID=old.trainID/new.trainID;</span> <span class="hljs-comment">-- 先把旧的数据恢复，然后减去新的数据。</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span>$$\nDELIMITER ;</span></code></pre>\n\n<p>当执行如下的操作后：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> ordersInTrain <span class="hljs-keyword">SET</span> buyTicketNum=<span class="hljs-number">3</span> <span class="hljs-keyword">WHERE</span> trainID=<span class="hljs-number">424</span>;</span></code></pre>\n\n<p>里面上执行上面的操作之后，会触发<code>tg_ticket_update</code>触发器，但是，实验表明：并没有触发该触发器。查找原因，原因如下：</p>\n\n<p><font color="red">触发事件不能这样写：</font></p>\n\n<p>UPDATE ticket SET remainderNum=(remainderNum+old.buyTicketNum-new.buyTicketNum) WHERE trainID= <font color="red"> old.trainID/ new.trainID ;(注意红色标注的这里)</font> ；<font color="blue" size="5">但是参考博客中这样写居然是Ok的，这就不能而知了，在实验过程中，是不能这样写的。</font></p>\n\n<p>应该这样写，将一句代码分成两步来做：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"> <span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=(remainderNum+old.buyTicketNum) <span class="hljs-keyword">WHERE</span> trainID=old.trainID ;</span> <span class="hljs-comment">-- 先加入旧的数据</span>\n <span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=(remainderNum-new.buyTicketNum) <span class="hljs-keyword">WHERE</span> trainID=new.trainID ;</span> <span class="hljs-comment">-- 再减去新的数据</span></code></pre>\n\n<p>这种改写之后，此触发器在执行下面这条语句之后就能够被触发了，触发后ticket表中trainID=424的票数为97 张了。</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> ordersInTrain <span class="hljs-keyword">SET</span> buyTicketNum=<span class="hljs-number">3</span> <span class="hljs-keyword">WHERE</span> trainID=<span class="hljs-number">424</span>;</span></code></pre>\n\n<p><font color="red" size="5">第二种情况：撤销订单</font></p>\n\n<p>这种情况的触发器的四要素如下。</p>\n\n<p>监视地点：ordersintrain</p>\n\n<p>监视事件：delete</p>\n\n<p>触发时间：after</p>\n\n<p>触发事件：更新ticket表</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql">DELIMITER $$\n<span class="hljs-operator"><span class="hljs-keyword">CREATE</span>\n <span class="hljs-keyword">TRIGGER</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`tg_ticket_delete`</span> <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">DELETE</span>\n <span class="hljs-keyword">ON</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`ordersintrain`</span>\n <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">BEGIN</span>\n\t<span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=remainderNum+old.buyTicketNum <span class="hljs-keyword">WHERE</span> trainID=old.trainID;</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span>$$\nDELIMITER ;</span></code></pre>\n\n<p>为方便观察结果，将上面进行的操作全部还原。即在初始状态下，每个trainID对应的车票为100，经过如下的插入语句：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> ordersInTrain(trainID,buyTicketNum) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">424</span>,<span class="hljs-number">5</span>);</span></code></pre>\n\n<p>之后，触发了insert插入器，trainID=424的余票变为了95张，即少了5张。</p>\n\n<p>接着执行如下的语句：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> ordersintrain <span class="hljs-keyword">WHERE</span> trainID=<span class="hljs-number">424</span>;</span></code></pre>\n\n<p>根据结果发现，trainID=424的余票变为了原来的100张。这就说明delete触发器起了作用。</p>\n\n\n\n<h2 id="before与after的区别">before与after的区别</h2>\n\n<p>上面的例子中讲解了3中触发器，分别为: (insert/update/delete)+after.除了这3种，还有如下的3中触发器： <br />\n(insert/update/delete)+<font color="red" size="4">before </font>.</p>\n\n<p><font color="red">下面主要介绍after和before关键字的区别。</font></p>\n\n<p>after ：是先完成数据的增删改，再触发，触发的语句晚于监视的增删改操作，无法影响前面的增删改；</p>\n\n<p>before ：是先完成触发，再完成监视事件的增删改，即触发的语句先于监视的增删改，因此，我们就有机会对监视事件的增删改进行检查，例如，检查插入的数据是否有效(例如：一张火车票的价格不能是1000000000元呀)，格式是否正确等。</p>\n\n<p>还是以上面的例子为例进行讲解。</p>\n\n<p>现在，ticket表中的内容如下：</p>\n\n<p><img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_trigger_v1.PNG" alt="" title="" /></p>\n\n<p><strong>还是建立一个after insert 触发器</strong>。</p>\n\n<pre class="prettyprint"><code class=" hljs sql">DELIMITER $$\n\n<span class="hljs-operator"><span class="hljs-keyword">CREATE</span>\n <span class="hljs-keyword">TRIGGER</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`tg_ticket`</span> <span class="hljs-keyword">after</span> <span class="hljs-keyword">INSERT</span>\n <span class="hljs-keyword">ON</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`ordersintrain`</span>\n <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">BEGIN</span>\n <span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=remainderNum-new.buyTicketNum <span class="hljs-keyword">WHERE</span> trainID=new.trainID;</span> <span class="hljs-comment">-- new.trainID 指的是ordersintrain表中的trainID</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span>$$\n\nDELIMITER ;</span></code></pre>\n\n<p>即在插入之后进行触发。当执行如下的语句时，会出现什么样的结果呢？？？</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> ordersintrain(trainID,buyTicketNum) <span class="hljs-keyword">values</span>(<span class="hljs-number">424</span>,<span class="hljs-number">200</span>);</span> <span class="hljs-comment">-- 一个买200张票的订单</span></code></pre>\n\n<p>从语句中可以看出，这是一个订单为200张票的订单，如果是 after insert触发器。则结果如下： <br />\n<img src="http://7xknzt.com1.z0.glb.clouddn.com/MySQL_trigger_v3.PNG" alt="" title="" /> <br />\n<font color="red">从结果可以看出，由于after insert对监视事件的插入数据没有进行有效性检查，因此出现的负数</font></p>\n\n<p>如果创建一个before insert触发器，则可以在插入之前进行检查，避免这样的事情发生。</p>\n\n<pre class="prettyprint"><code class=" hljs sql">DELIMITER $$\n\n<span class="hljs-operator"><span class="hljs-keyword">CREATE</span>\n <span class="hljs-keyword">TRIGGER</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`tg_ticket_before`</span> <span class="hljs-keyword">BEFORE</span> <span class="hljs-keyword">INSERT</span>\n <span class="hljs-keyword">ON</span> <span class="hljs-string">`test`</span>.<span class="hljs-string">`ordersintrain`</span>\n <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">BEGIN</span>\n\n <span class="hljs-keyword">IF</span> new.buyTicketNum&gt;<span class="hljs-number">100</span> <span class="hljs-keyword">THEN</span>\n <span class="hljs-keyword">SET</span> new.buyTicketNum=<span class="hljs-number">100</span>;</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span> ;</span>\n <span class="hljs-operator"><span class="hljs-keyword">UPDATE</span> ticket <span class="hljs-keyword">SET</span> remainderNum=remainderNum-new.buyTicketNum <span class="hljs-keyword">WHERE</span> trainID=new.trainID;</span>\n <span class="hljs-operator"><span class="hljs-keyword">END</span>$$\n\nDELIMITER ;</span></code></pre>\n\n<p>则订单插入只会插入100，且ticket 的余票也不会变为负数。</p>\n\n<h2 id="参考资料">参考资料</h2>\n\n<p>1、《MySQL必知必会》</p>\n\n<p>2、blog：<a href="http://www.cnblogs.com/zzwlovegfj/archive/2012/07/04/2576989.html">http://www.cnblogs.com/zzwlovegfj/archive/2012/07/04/2576989.html</a></p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
