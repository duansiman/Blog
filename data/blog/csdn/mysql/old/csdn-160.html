\n\n<p>有过MySQL运维的人应该都清楚，线上的MySQL一般都采用源码编译，因为这样才可以根据企业的各自需要选择要编译的功能，虽然MySQL的源码编译挺简单的，但是试想一下，如果你有几百台服务器同时要安装MySQL，难道你还一台台去手动编译、编写配置文件吗？这显然太低效了，本文讨论MySQL的自动化安装部署。</p>&#13;\n<h2>1、制作符合自己需求的RPM包</h2>&#13;\n<div>我们要根据MySQL的源码编译符合企业需求的RPM包，源码获取命令如下：</div>&#13;\n<div><pre code_snippet_id="1690617" snippet_file_name="blog_20160520_1_5991361" name="code" class="plain">wget http://downloads.mysql.com/archives/get/file/mysql-5.6.16.tar.gz\ntar -zxvf mysql-5.6.16.tar.gz\ncd mysql-5.6.16\nmkdir rpm\ncd rpm\n</pre>在上面我们获取了源码，并在源码主目录下创建rpm目录，接着我们在该目录下创建mysql.spec文件：</div>&#13;\n<div><pre code_snippet_id="1690617" snippet_file_name="blog_20160520_2_1989391" name="code" class="plain">Name: mysql\nVersion:5.6.16\nRelease: guahao\nLicense: GPL\nURL: http://downloads.mysql.com/archives/get/file/mysql-5.6.16.tar.gz\nGroup: applications/database\nBuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root \nBuildRequires: cmake\nPackager: zhuxj@guahao.com\nAutoreq: no\nprefix: /opt/mysql\nSummary: MySQL 5.6.16\n\n%description \nThe MySQL(TM) software delivers a very fast, multi-threaded, multi-user,\nand robust SQL (Structured Query Language) database server. MySQL Server\nis intended for mission-critical, heavy-load production systems as well\nas for embedding into mass-deployed software.\n\n%define MYSQL_USER mysql\n%define MYSQL_GROUP mysql\n%define __os_install_post %{nil}\n\n%build\ncd $OLDPWD/../\nCFLAGS="-O3 -g -fno-exceptions -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing"\nCXX=g++\nCXXFLAGS="-O3 -g -fno-exceptions -fno-rtti -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing"\nexport CFLAGS CXX CXXFLAGS\n\ncmake . \\\n -DSYSCONFDIR:PATH=%{prefix} \\\n -DCMAKE_INSTALL_PREFIX:PATH=%{prefix} \\\n -DCMAKE_BUILD_TYPE:STRING=Release \\\n -DENABLE_PROFILING:BOOL=ON \\\n -DWITH_DEBUG:BOOL=OFF \\\n -DWITH_VALGRIND:BOOL=OFF \\\n -DENABLE_DEBUG_SYNC:BOOL=OFF \\\n -DWITH_EXTRA_CHARSETS:STRING=all \\\n -DWITH_SSL:STRING=bundled \\\n -DWITH_UNIT_TESTS:BOOL=OFF \\\n -DWITH_ZLIB:STRING=bundled \\\n -DWITH_PARTITION_STORAGE_ENGINE:BOOL=ON \\\n -DWITH_INNOBASE_STORAGE_ENGINE:BOOL=ON \\\n -DWITH_ARCHIVE_STORAGE_ENGINE:BOOL=ON \\\n -DWITH_BLACKHOLE_STORAGE_ENGINE:BOOL=ON \\\n -DWITH_PERFSCHEMA_STORAGE_ENGINE:BOOL=ON \\\n -DDEFAULT_CHARSET=utf8 \\\n -DDEFAULT_COLLATION=utf8_general_ci \\\n -DWITH_EXTRA_CHARSETS=all \\\n -DENABLED_LOCAL_INFILE:BOOL=ON \\\n -DWITH_EMBEDDED_SERVER=0 \\\n -DINSTALL_LAYOUT:STRING=STANDALONE \\\n -DCOMMUNITY_BUILD:BOOL=ON \\\n -DMYSQL_SERVER_SUFFIX='-r5436';\n\nmake -j `cat /proc/cpuinfo | grep processor| wc -l`\n\n%install\ncd $OLDPWD/../\nmake DESTDIR=$RPM_BUILD_ROOT install\n\n%clean\nrm -rf $RPM_BUILD_ROOT\n\n%files\n%defattr(-, %{MYSQL_USER}, %{MYSQL_GROUP})\n%attr(755, %{MYSQL_USER}, %{MYSQL_GROUP}) %{prefix}/*\n\n%pre\n\n%post\nln -s %{prefix}/lib %{prefix}/lib64\n\n%preun\n\n%changelog\n</pre>有了这个spec文件之后，就可以执行如下命令生成我们自己的RPM包：</div>&#13;\n<div><pre code_snippet_id="1690617" snippet_file_name="blog_20160520_3_9448898" name="code" class="plain">rpmbuild -bb ./mysql.spec</pre>&#13;\n<h2>2、编写my.cnf模板</h2>&#13;\n<div>my.cnf模板如下：</div>&#13;\n<div><pre code_snippet_id="1690617" snippet_file_name="blog_20160520_4_3145633" name="code" class="plain">[mysqld_safe]\npid-file=/opt/mysql/run/mysqld.pid\n\n[mysql]\nprompt=\\\\u@\\\\d \\\\r:\\\\m:\\\\s&gt;\ndefault-character-set=gbk\nno-auto-rehash\n\n[client]\nsocket=/opt/mysql/run/mysql.sock\n\n[mysqld]\n#dir\nbasedir=/opt/mysql\ndatadir=/data/mysql/data\ntmpdir=/data/mysql/tmp\nlog-error=/data/mysql/log/alert.log\nslow_query_log_file=/data/mysql/log/slow.log\ngeneral_log_file=/data/mysql/log/general.log\nsocket=/opt/mysql/run/mysql.sock\n\n#innodb\ninnodb_data_home_dir=/data/mysql/data\ninnodb_log_group_home_dir=/data/mysql/data\ninnodb_data_file_path=ibdata1:2G;ibdata2:16M:autoextend\ninnodb_buffer_pool_size=10G\ninnodb_buffer_pool_instances=4\ninnodb_log_files_in_group=4\ninnodb_log_file_size=1G\ninnodb_log_buffer_size=200M\ninnodb_flush_log_at_trx_commit=1\ninnodb_additional_mem_pool_size=20M\ninnodb_max_dirty_pages_pct=60\ninnodb_io_capacity=200\ninnodb_thread_concurrency=32\ninnodb_read_io_threads=8\ninnodb_write_io_threads=8\ninnodb_open_files=60000\ninnodb_file_format=Barracuda\ninnodb_file_per_table=1\ninnodb_flush_method=O_DIRECT\ninnodb_change_buffering=all\ninnodb_adaptive_flushing=1\ninnodb_old_blocks_time=1000\ninnodb_stats_on_metadata=0\ninnodb_read_ahead=0\ninnodb_use_native_aio=0\ninnodb_lock_wait_timeout=50\ninnodb_rollback_on_timeout=0\ninnodb_purge_threads=1\ninnodb_strict_mode=1\ntransaction-isolation=READ-COMMITTED\n\n#myisam\nkey_buffer_size=100M\nmyisam_sort_buffer_size=64M\nconcurrent_insert=2\ndelayed_insert_timeout=300\n\n#replication\nmaster-info-file=/data/mysql/log/master.info\nrelay-log=/data/mysql/log/mysql-relay\nrelay_log_info_file=/data/mysql/log/mysql-relay.info\nrelay-log-index=/data/mysql/log/mysql-relay.index\nslave_load_tmpdir=/data/mysql/tmp\nslave_type_conversions="ALL_NON_LOSSY"\nslave_net_timeout=4\nskip-slave-start\nsync_master_info=1000\nsync_relay_log_info=1000\n\n#binlog\nlog-bin=/data/mysql/log/mysql-bin\nserver_id=2552763370\nbinlog_cache_size=32K\nmax_binlog_cache_size=2G\nmax_binlog_size=500M\nbinlog_format=ROW\nsync_binlog=1000\nlog-slave-updates=1\nexpire_logs_days=0\n\n#server\ndefault-storage-engine=INNODB\ncharacter-set-server=gbk\nlower_case_table_names=1\nskip-external-locking\nopen_files_limit=65536\nsafe-user-create\nlocal-infile=1\nperformance_schema=0\n\nlog_slow_admin_statements=1\nlog_warnings=1\nlong_query_time=1\nslow_query_log=1\ngeneral_log=0\n\nquery_cache_type=0\nquery_cache_limit=1M\nquery_cache_min_res_unit=1K\n\ntable_definition_cache=65536\n\nthread_stack=512K\nthread_cache_size=256\nread_rnd_buffer_size=128K\nsort_buffer_size=256K\njoin_buffer_size=128K\nread_buffer_size=128K\n\nport=3306\nskip-name-resolve\nskip-ssl\nmax_connections=4500\nmax_user_connections=4000\nmax_connect_errors=65536\nmax_allowed_packet=128M\nconnect_timeout=8\nnet_read_timeout=30\nnet_write_timeout=60\nback_log=1024\n\n#server id\n</pre>细心的读者应该会注意在，在my.cnf的末尾在server id上留了空白，在后面的shell脚本会动态加上，这是因为在一个企业内部的所有MySQL的server id必须保持全局一致性，这样在主备复制时才不会导致混乱。</div>&#13;\n<div>其实如果想把这个脚本写的更通用，完全可以把更多的参数留白，如port、datadir、内存相关参数等，这里我只是以server id为例，抛砖引玉。</div>&#13;\n<div>&#13;\n<h2>3、准备MySQL数据目录模板</h2>&#13;\n<div>你得事先准备一台MySQL，可以根据自己的需求，把通用性的东西放在上面（如账户等），下面是一个最简单的已安装好的MySQL的数据目录结构：</div>&#13;\n<div><pre code_snippet_id="1690617" snippet_file_name="blog_20160520_5_3287337" name="code" class="plain">[root@lx25 mysql]# ls -l\ntotal 12\ndrwxr-xr-x 5 mysql mysql 4096 Jul 2 09:26 data\ndrwxr-xr-x 2 mysql mysql 4096 Jul 1 18:21 log\ndrwxr-xr-x 2 mysql mysql 4096 Jul 2 09:26 tmp\n[root@lx25 mysql]# cd data\n[root@lx25 data]# ls -l\ntotal 6314044\ndrwx------ 2 mysql mysql 4096 Jul 1 17:17 mysql\ndrwx------ 2 mysql mysql 4096 Jul 1 17:17 performance_schema\ndrwx------ 2 mysql mysql 4096 Jul 1 17:17 test\n</pre>把该目录用tar打包（命名为data.tar），然后以这个为模板解压至新装MySQL实例的数据目录下即可。</div>&#13;\n<h2>4、编写自动化安装部署脚本</h2>&#13;\n<div>在运行这个脚本之前，我们必须得把前面几部制作的rpm包、my.cnf模板和数据目录模板放到一个固定的地方，本例中是放在企业内部的ftp上。</div>&#13;\n<div>MySQL自动化安装部署脚本（命名为：mysql_install.sh）如下：</div>&#13;\n<div><pre code_snippet_id="1690617" snippet_file_name="blog_20160520_6_8968938" name="code" class="plain">#!/bin/sh\n\n#Step 1: Prepare\nyum install cmake gcc g++ bison ncurses-devel zlib \n\ngroupadd mysql\nuseradd -g mysql mysql\n\n#Step 2: Get Source\nftp -n&lt;&lt;EOF\nopen **\nuser csdn-100.html csdn-101.html csdn-102.html csdn-103.html csdn-104.html csdn-105.html csdn-106.html csdn-107.html csdn-108.html csdn-109.html csdn-10.html csdn-110.html csdn-111.html csdn-112.html csdn-113.html csdn-114.html csdn-115.html csdn-116.html csdn-117.html csdn-118.html csdn-119.html csdn-11.html csdn-120.html csdn-121.html csdn-122.html csdn-123.html csdn-124.html csdn-125.html csdn-126.html csdn-127.html csdn-128.html csdn-129.html csdn-12.html csdn-130.html csdn-131.html csdn-132.html csdn-133.html csdn-134.html csdn-135.html csdn-136.html csdn-137.html csdn-138.html csdn-139.html csdn-13.html csdn-140.html csdn-141.html csdn-142.html csdn-143.html csdn-144.html csdn-145.html csdn-146.html csdn-147.html csdn-148.html csdn-149.html csdn-14.html csdn-150.html csdn-151.html csdn-152.html csdn-153.html csdn-154.html csdn-155.html csdn-156.html csdn-157.html csdn-158.html csdn-159.html csdn-15.html csdn-16.html csdn-17.html csdn-18.html csdn-19.html csdn-1.html csdn-20.html csdn-21.html csdn-22.html csdn-23.html csdn-24.html csdn-25.html csdn-26.html csdn-27.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-49.html csdn-4.html csdn-50.html csdn-51.html csdn-52.html csdn-53.html csdn-54.html csdn-55.html csdn-56.html csdn-57.html csdn-58.html csdn-59.html csdn-5.html csdn-60.html csdn-61.html csdn-62.html csdn-63.html csdn-64.html csdn-65.html csdn-66.html csdn-67.html csdn-68.html csdn-69.html csdn-6.html csdn-70.html csdn-71.html csdn-72.html csdn-73.html csdn-74.html csdn-75.html csdn-76.html csdn-77.html csdn-78.html csdn-79.html csdn-7.html csdn-80.html csdn-81.html csdn-82.html csdn-83.html csdn-84.html csdn-85.html csdn-86.html csdn-87.html csdn-88.html csdn-89.html csdn-8.html csdn-90.html csdn-91.html csdn-92.html csdn-93.html csdn-94.html csdn-95.html csdn-96.html csdn-97.html csdn-98.html csdn-99.html csdn-9.html mysql.sh **\nbinary\ncd mysql\nprompt\nmget *\nEOF\n\n#Step 3: Install\nunique_id=`date "+%Y%m%d%M%S"`\necho 'server_id='$unique_id &gt;&gt; my.cnf\nrpm -ivh mysql-5.6.16-guahao.x86_64.rpm\ncp my.cnf /opt/mysql\nchown -R mysql:mysql /opt/mysql\n\ntar xvf data.tar -C /data\nchown -R mysql:mysql /data/mysql\n\n#step 4: Start MySQL\ncp /opt/mysql/support-files/mysql.server /etc/rc.d/init.d/mysqld\nchmod 755 /etc/init.d/mysqld\nchkconfig mysqld on\n\n/etc/init.d/mysqld start</pre><br />&#13;\n<br />&#13;\n</div>&#13;\n</div>&#13;\n</div>&#13;\n &#13;\n
