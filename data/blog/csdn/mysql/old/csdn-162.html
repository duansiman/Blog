\n\n<p>前一篇讲到的创建主备复制是假设主备库都为刚刚安装好的数据库，也就是说两台服务器上的数据相同，这不是典型的案例，大多数情况下有一个已经运行了一段时间的主库，然后用一台新安装的备库与之同步，本文讲述在这种情况下该如何配置。</p>&#13;\n<p>1、在备库的主机上安装MySQL，注意备库的版本不能低于主库。</p>&#13;\n<p>2、备份主库，复制备份文件到备库，并在备库上恢复。</p>&#13;\n<p>可以有很多种方法实现上述过程，我这里介绍的是利用innobackupex在线备份主库，这样就不需要停主库（注意：innobackupex只适用于MyISAM和innodb引擎）。</p>&#13;\n<p>首先，在主库上执行如下语句进行全备：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_1_7457160" name="code" class="plain">innobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=*** /backup/mysql/data </pre>然后把备份文件全部拷贝至备库相同目录下，接着执行如下语句进行恢复（注意：恢复之前需保证MySQL服务器已关闭，且原来的数据和日志已删除）：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_2_9648987" name="code" class="plain">innobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=***--use-memory=4G --apply-log /data/mysql/backup/2013-11-27_18-18-51\ninnobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=***--copy-back /data/mysql/backup/2013-11-27_18-18-51</pre>恢复完成后，启动MySQL服务器：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_3_2854571" name="code" class="plain">service mysqld start</pre>3、启动复制&#13;\n<p></p>&#13;\n<p>在备库启动复制之前，我们需要在主库上创建备份账号：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_4_204613" name="code" class="sql">GRANT REPLICATION SLAVE ON csdn-100.html csdn-101.html csdn-102.html csdn-103.html csdn-104.html csdn-105.html csdn-106.html csdn-107.html csdn-108.html csdn-109.html csdn-10.html csdn-110.html csdn-111.html csdn-112.html csdn-113.html csdn-114.html csdn-115.html csdn-116.html csdn-117.html csdn-118.html csdn-119.html csdn-11.html csdn-120.html csdn-121.html csdn-122.html csdn-123.html csdn-124.html csdn-125.html csdn-126.html csdn-127.html csdn-128.html csdn-129.html csdn-12.html csdn-130.html csdn-131.html csdn-132.html csdn-133.html csdn-134.html csdn-135.html csdn-136.html csdn-137.html csdn-138.html csdn-139.html csdn-13.html csdn-140.html csdn-141.html csdn-142.html csdn-143.html csdn-144.html csdn-145.html csdn-146.html csdn-147.html csdn-148.html csdn-149.html csdn-14.html csdn-150.html csdn-151.html csdn-152.html csdn-153.html csdn-154.html csdn-155.html csdn-156.html csdn-157.html csdn-158.html csdn-159.html csdn-15.html csdn-160.html csdn-161.html csdn-16.html csdn-17.html csdn-18.html csdn-19.html csdn-1.html csdn-20.html csdn-21.html csdn-22.html csdn-23.html csdn-24.html csdn-25.html csdn-26.html csdn-27.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-49.html csdn-4.html csdn-50.html csdn-51.html csdn-52.html csdn-53.html csdn-54.html csdn-55.html csdn-56.html csdn-57.html csdn-58.html csdn-59.html csdn-5.html csdn-60.html csdn-61.html csdn-62.html csdn-63.html csdn-64.html csdn-65.html csdn-66.html csdn-67.html csdn-68.html csdn-69.html csdn-6.html csdn-70.html csdn-71.html csdn-72.html csdn-73.html csdn-74.html csdn-75.html csdn-76.html csdn-77.html csdn-78.html csdn-79.html csdn-7.html csdn-80.html csdn-81.html csdn-82.html csdn-83.html csdn-84.html csdn-85.html csdn-86.html csdn-87.html csdn-88.html csdn-89.html csdn-8.html csdn-90.html csdn-91.html csdn-92.html csdn-93.html csdn-94.html csdn-95.html csdn-96.html csdn-97.html csdn-98.html csdn-99.html csdn-9.html mysql.sh TO repluser@'192.168.1.%' IDENTIFIED BY 'replpwd';</pre>然后，我们要确定主库的日志及其偏移量。这里要特别注意，我们不能通过show master status获得，因为在之前备份和复制的过程中，主库一直有新的日志产生，为了不造成数据丢失，我们必须从备份日志里获得。&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_5_8983113" name="code" class="plain">[mysql@lx16 2013-11-27_18-18-51]$ cat xtrabackup_binlog_info\nmysql-bin.000149 69191646</pre>从上面的备份日志里我们就能获得备份时主库的日志及其偏移量，这样我们就可以通过如下语句在备库启动复制了：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_6_7761614" name="code" class="plain">change master to \n master_host='192.168.1.15', \n master_user='repluser', \n master_password='replpwd', \n master_log_file='mysql-bin.000149', \n master_log_pos=69191646; \n\nstart slave;</pre>启动复制后，备库的状态如下：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="88365" snippet_file_name="blog_20131129_7_1731348" name="code" class="sql">root@(none) 03:43:47&gt;show slave status\\G\n*************************** 1. row ***************************\n Slave_IO_State: Waiting for master to send event\n Master_Host: 192.168.1.15\n Master_User: repluser\n Master_Port: 3306\n Connect_Retry: 60\n Master_Log_File: mysql-bin.000149\n Read_Master_Log_Pos: 194385112\n Relay_Log_File: mysqld-relay-bin.000002\n Relay_Log_Pos: 125193719\n Relay_Master_Log_File: mysql-bin.000149\n Slave_IO_Running: Yes\n Slave_SQL_Running: Yes\n Replicate_Do_DB: \n Replicate_Ignore_DB: \n Replicate_Do_Table: \n Replicate_Ignore_Table: \n Replicate_Wild_Do_Table: \n Replicate_Wild_Ignore_Table: \n Last_Errno: 0\n Last_Error: \n Skip_Counter: 0\n Exec_Master_Log_Pos: 194385112\n Relay_Log_Space: 125193876\n Until_Condition: None\n Until_Log_File: \n Until_Log_Pos: 0\n Master_SSL_Allowed: No\n Master_SSL_CA_File: \n Master_SSL_CA_Path: \n Master_SSL_Cert: \n Master_SSL_Cipher: \n Master_SSL_Key: \n Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n Last_IO_Errno: 0\n Last_IO_Error: \n Last_SQL_Errno: 0\n Last_SQL_Error: \n Replicate_Ignore_Server_Ids: \n Master_Server_Id: 10\n1 row in set (0.00 sec)</pre>&#13;\n<p></p>&#13;\n &#13;\n
