\n\n<p>MySQL不像Oracle本身就支持表的在线重定义，但我们可以通过开源软件percona-toolkit中的工具pt-online-schema-change进行在线重定义。</p>&#13;\n<p>官方文档：http://www.percona.com/doc/percona-toolkit/2.2/pt-online-schema-change.html#pt-online-schema-change</p>&#13;\n<p>pt-online-schema-change包含在percona-toolkit中，所以我们得先下载安装：<br />&#13;\n</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="155975" snippet_file_name="blog_20140114_1_4018409" name="code" class="plain">wget percona.com/get/percona-toolkit.tar.gz\ntar -zxvf percona-toolkit-2.2.6.tar.gz</pre>&#13;\n<p></p><pre code_snippet_id="155975" snippet_file_name="blog_20141008_2_5032433" name="code" class="plain"> perl Makefile.PL\n make\n make test\n make install</pre>&#13;\n<p>通过上诉步骤之后，把./percona-toolkit-2.2.6/bin下的可执行文件加入到$PATH中即可。</p>&#13;\n<p><br />&#13;\n好了，安装完成之后，就可以利用该工具进行在线重定义了。主要用到两个参数：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="155975" snippet_file_name="blog_20140114_2_6461407" name="code" class="plain">--dry-run\nCreate and alter the new table, but do not create triggers, copy data, or replace the original table.\n\n--execute\nIndicate that you have read the documentation and want to alter the table. You must specify this option to alter the table. If you do not, then the tool will only perform some safety checks and exit. This helps ensure that you have read the documentation and understand how to use this tool. If you have not read the documentation, then do not specify this option.</pre>&#13;\n<p></p>&#13;\n<p>首先，我们用--dry-run验证是否可以执行修改：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="155975" snippet_file_name="blog_20140114_3_7475163" name="code" class="plain">pt-online-schema-change --alter "modify treatment_afterday INT(4) NULL" D=portal,t=comment_expert -uroot -p*** --dry-run\nOperation, tries, wait:\n copy_rows, 10, 0.25\n create_triggers, 10, 1\n drop_triggers, 10, 1\n swap_tables, 10, 1\n update_foreign_keys, 10, 1\nStarting a dry run. `portal`.`comment_expert` will not be altered. Specify --execute instead of --dry-run to alter the table.\nCreating new table...\nCreated new table portal._comment_expert_new OK.\nAltering new table...\nAltered `portal`.`_comment_expert_new` OK.\nNot creating triggers because this is a dry run.\nNot copying rows because this is a dry run.\nNot swapping tables because this is a dry run.\nNot dropping old table because this is a dry run.\nNot dropping triggers because this is a dry run.\n2014-01-14T13:59:08 Dropping new table...\n2014-01-14T13:59:08 Dropped new table OK.</pre>&#13;\n<p></p>&#13;\n<p>确认无误之后，再用--execute真正执行：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="155975" snippet_file_name="blog_20140114_4_5349375" name="code" class="plain">pt-online-schema-change --alter "modify treatment_afterday INT(4) NULL" D=portal,t=comment_expert -uroot -pzhujie1986 --execute\nFound 1 slaves:\n lx203\nWill check slave lag on:\n lx203\nOperation, tries, wait:\n copy_rows, 10, 0.25\n create_triggers, 10, 1\n drop_triggers, 10, 1\n swap_tables, 10, 1\n update_foreign_keys, 10, 1\nAltering `portal`.`comment_expert`...\nCreating new table...\nCreated new table portal._comment_expert_new OK.\nAltering new table...\nAltered `portal`.`_comment_expert_new` OK.\n2014-01-14T13:59:20 Creating triggers...\n2014-01-14T13:59:20 Created triggers OK.\n2014-01-14T13:59:20 Copying approximately 1165430 rows...\nCopying `portal`.`comment_expert`: 19% 02:03 remain\nCopying `portal`.`comment_expert`: 38% 01:37 remain\nCopying `portal`.`comment_expert`: 55% 01:12 remain\nCopying `portal`.`comment_expert`: 73% 00:44 remain\nCopying `portal`.`comment_expert`: 90% 00:15 remain\n2014-01-14T14:02:08 Copied rows OK.\n2014-01-14T14:02:08 Swapping tables...\n2014-01-14T14:02:08 Swapped original and new tables OK.\n2014-01-14T14:02:08 Dropping old table...\n2014-01-14T14:02:10 Dropped old table `portal`.`_comment_expert_old` OK.\n2014-01-14T14:02:10 Dropping triggers...\n2014-01-14T14:02:10 Dropped triggers OK.\nSuccessfully altered `portal`.`comment_expert`.</pre><br />&#13;\n除了修改表结构之外，在大表上建索引也可以利用这种方法防止锁表。&#13;\n<p></p>&#13;\n<p><br />&#13;\n</p>&#13;\n &#13;\n
