\n\n<p>Xtrabackup是由percona开发的一个开源软件，它是innodb热备工具ibbackup（收费的商业软件）的一个开源替代品。Xtrabackup由个部分组成:xtrabackup和innobackupex，其中xtrabackup工具用于备份innodb和 xtraDB引擎的表；而innobackupex工具用于备份myisam和innodb引擎的表，本文将介绍如何用innobackupex工具做全量和增量备份。<br />&#13;\n</p>&#13;\n<p>官网：<span style="word-wrap:break-word; color:rgb(102,102,102); font-family:宋体,Arial; line-height:26px"><span lang="EN-US" style="word-wrap:break-word; color:blue" xml:lang="EN-US"><a target="_blank" href="http://www.percona.com/docs/wiki/percona-xtrabackup:start" style="word-wrap:break-word; text-decoration:none; color:rgb(25,89,155)">http://www.percona.com/docs/wiki/percona-xtrabackup:start</a></span></span></p>&#13;\n<h2>安装</h2>&#13;\n<p>声明：以下操作最好以mysql用户执行。</p>&#13;\n<p>首先，通过wget下载源码tar包：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_1_9765630" name="code" class="plain">wget http://www.percona.com/redir/downloads/XtraBackup/LATEST/source/percona-xtrabackup-2.1.5.tar.gz</pre>安装依赖包：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_2_1467091" name="code" class="plain">yum install cmake gcc gcc-c++ libaio libaio-devel automake autoconf bzr bison libtool ncurses-devel zlib-devel</pre>解压缩tar：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_3_6624521" name="code" class="plain">tar -zxvf percona-xtrabackup-2.1.5.tar.gz\ncd percona-xtrabackup-2.1.5\n</pre>&#13;\n<p></p>&#13;\n<p>utils/build.sh脚本会根据指定的引擎版本，自动解压缩适当的MySQL源码包并进行编译，这是最简单的安装方式。当你在命令行下不带任何参数执行该脚本时，出现如下提示：<br />&#13;\n</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_4_3451175" name="code" class="plain">[mysql@epay100 ~/software/percona-xtrabackup-2.1.5 ]$ ./utils/build.sh\nBuild an xtrabackup binary against the specified InnoDB flavor.\n\nUsage: build.sh CODEBASE\nwhere CODEBASE can be one of the following values or aliases:\n innodb51 | plugin build against InnoDB plugin in MySQL 5.1\n innodb55 | 5.5 build against InnoDB in MySQL 5.5\n innodb56 | 5.6,xtradb56, build against InnoDB in MySQL 5.6\n | mariadb100\n xtradb51 | xtradb,mariadb51 build against Percona Server with XtraDB 5.1\n | mariadb52,mariadb53\n xtradb55 | galera55,mariadb55 build against Percona Server with XtraDB 5.5</pre>根据上面提示和你使用的存储引擎及版本，选择相应的参数即可。因为我用的是MySQL 5.6，所以执行如下语句安装：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_5_244809" name="code" class="plain">./utils/build.sh innodb56</pre>以上语句执行成功后，表示安装完成。最后，把生成的二进制文件拷贝到一个自定义目录下（本例中为/home/mysql/admin/bin/percona-xtrabackup-2.1.5），并把该目录放到环境变量PATH中。&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_6_7594849" name="code" class="plain">cp ./innobackupex /home/mysql/admin/bin/percona-xtrabackup-2.1.5\ncp ./src/xtrabackup_56 ./src/xbstream /home/mysql/admin/bin/percona-xtrabackup-2.1.5 </pre>&#13;\n<p></p>&#13;\n<h2>全备及其恢复</h2>&#13;\n<div><strong>全备：</strong></div>&#13;\n<div>执行如下语句进行全备：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_7_4977911" name="code" class="plain">innobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=*** /backup/mysql/data</pre>该语句将拷贝数据文件（由my.cnf里的变量datadir指定）至备份目录下（/backup/mysql/data），注意：如果不指定--defaults-file，默认值为/etc/my.cnf。</div>&#13;\n<div>备份成功后，将在备份目录下创建一个时间戳目录（本例创建的目录为/backup/mysql/data/2013-10-29_09-05-25），在该目录下存放备份文件。</div>&#13;\n<div><br />&#13;\n</div>&#13;\n<div><strong>恢复：</strong></div>&#13;\n<div>恢复之前，要先关闭数据库，并且删除数据文件和日志文件。</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_8_691749" name="code" class="plain">innobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=*** --use-memory=4G --apply-log /backup/mysql/data/2013-10-29_09-05-25\ninnobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=*** --copy-back /backup/mysql/data/2013-10-29_09-05-25</pre></div>&#13;\n<div>从什么可以看出，恢复分为两个步骤，第1步是apply-log，为了加快速度，一般建议设置--use-memory，这个步骤完成之后，目录/backup/mysql/data/2013-10-29_09-05-25下的备份文件已经准备就绪。</div>&#13;\n<div>第2步是copy-back，即把备份文件拷贝至原数据目录下。</div>&#13;\n<div>恢复完成之后，一定要记得检查数据目录的所有者和权限是否正确。</div>&#13;\n<div><br />&#13;\n</div>&#13;\n<h2>增量备份及其恢复</h2>&#13;\n<div>注意：innobackupex 增量备份仅针对InnoDB这类支持事务的引擎，对于MyISAM等引擎，则仍然是全备。</div>&#13;\n<div><br />&#13;\n</div>&#13;\n<div><strong>增量备份：</strong></div>&#13;\n<div>增量备份需要基于全备，先假设我们已经有了一个全备（/backup/mysql/data/2013-10-29_09-05-25），我们需要在该全备的基础上做增量备份。</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_9_1978505" name="code" class="plain">innobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=*** --incremental-basedir=/backup/mysql/data/2013-10-29_09-05-25 --incremental /backup/mysql/data</pre>其中--incremental-basedir指向全备目录，--incremental指向增量备份的目录。</div>&#13;\n<div>上面语句执行成功之后，会在--incremental执行的目录下创建一个时间戳子目录（本例中为：/backup/mysql/data/2013-10-29_09-52-37），在该目录下存放着增量备份的所有文件。</div>&#13;\n<div>在备份目录下，有一个文件xtrabackup_checkpoints记录着备份信息，全备的信息如下：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_10_2360189" name="code" class="plain">backup_type = full-backuped\nfrom_lsn = 0\nto_lsn = 563759005914\nlast_lsn = 563759005914</pre>基于该全备的增量备份的信息如下：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_11_790026" name="code" class="plain">backup_type = incremental\nfrom_lsn = 563759005914\nto_lsn = 574765133284\nlast_lsn = 574765133284</pre>从上面可以看出，增量备份的from_lsn正好等于全备的to_lsn。<br />&#13;\n那么，我们是否可以在增量备份的基础上再做增量备份呢？答案是肯定的，只要把--incremental-basedir执行上一次增量备份的目录即可，如下所示：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_12_9568526" name="code" class="plain">innobackupex --defaults-file=/opt/mysql/my.cnf --user=root --password=*** --incremental-basedir=/backup/mysql/data/2013-10-29_09-52-37 --incremental /backup/mysql/data</pre>它的xtrabackup_checkpoints记录着备份信息如下：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_13_9219079" name="code" class="plain">backup_type = incremental\nfrom_lsn = 574765133284\nto_lsn = 574770200380\nlast_lsn = 574770200950</pre>可以看到，该增量备份的from_lsn是从上一次增量备份的to_lsn开始的。</div>&#13;\n<div><br />&#13;\n</div>&#13;\n<div><strong>恢复：</strong></div>&#13;\n<div><br />&#13;\n</div>&#13;\n<div>增量备份的恢复比全备要复杂很多，第一步是在所有备份目录下重做已提交的日志，如：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_14_2109018" name="code" class="plain">innobackupex --apply-log --redo-only BASE-DIR\ninnobackupex --apply-log --redo-only BASE-DIR --incremental-dir=INCREMENTAL-DIR-1\ninnobackupex --apply-log BASE-DIR --incremental-dir=INCREMENTAL-DIR-2</pre>其中BASE-DIR是指全备目录，INCREMENTAL-DIR-1是指第一次的增量备份，INCREMENTAL-DIR-2是指第二次的增量备份，以此类推。</div>&#13;\n<div>这里要注意的是：最后一步的增量备份并没有--redo-only选项！还有，可以使用--use_memory提高性能。</div>&#13;\n<div>以上语句执行成功之后，最终数据在BASE-DIR（即全备目录）下。</div>&#13;\n<div>第一步完成之后，我们开始第二步：回滚未完成的日志：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_15_5347621" name="code" class="plain">innobackupex --apply-log BASE-DIR</pre>上面执行完之后，BASE-DIR里的备份文件已完全准备就绪，最后一步是拷贝：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_16_3569715" name="code" class="plain">innobackupex --copy-back BASE-DIR</pre>同样地，拷贝结束之后，记得检查下数据目录的权限是否正确。<br />&#13;\n<br />&#13;\n</div>&#13;\n<h2>常见错误及解决方法</h2>&#13;\n<div>错误：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_17_396368" name="code" class="plain">131028 17:45:57 innobackupex: Connecting to MySQL server with DSN 'dbi:mysql:;mysql_read_default_group=xtrabackup' (using password: NO).\ninnobackupex: Error: Failed to connect to MySQL server as DBD::mysql module is not installed at /home/mysql/admin/bin/percona-xtrabackup-2.1.5/innobackupex line 2913.</pre>解决方法：</div>&#13;\n<div><pre code_snippet_id="87892" snippet_file_name="blog_20131129_18_7746409" name="code" class="plain">yum -y install perl-DBD-MySQL.x86_64</pre><br />&#13;\n</div>&#13;\n<p>错误：</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_19_8128093" name="code" class="plain">sh: xtrabackup_55: command not found\ninnobackupex: Error: no 'mysqld' group in MySQL options at /home/mysql/admin/bin/percona-xtrabackup-2.1.6/innobackupex line 4341.</pre>解决方法：&#13;\n<p></p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="87892" snippet_file_name="blog_20131129_20_3841932" name="code" class="plain">cp xtrabackup_innodb55 xtrabackup_55</pre><br />&#13;\n<p></p>&#13;\n &#13;\n
