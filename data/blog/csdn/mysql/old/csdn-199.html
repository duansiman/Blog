\n\n<p><a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/60326337">转载请注明出处：http://blog.csdn.net/l1028386804/article/details/60326337</a><br />&#13;\n</p>&#13;\n<h3>一、使用场景</h3>&#13;\n<ul>&#13;\n<li>MySQL数据库每日零点自动全备</li></ul>&#13;\n<ul>&#13;\n<li>某天上午9点，张三不小心drop了一个数据库</li></ul>&#13;\n<ul>&#13;\n<li>我们需要通过全备的数据文件，以及增量的binlog文件进行数据恢复<br />&#13;\n</li></ul>&#13;\n<h3>二、主要思想与原理<br />&#13;\n</h3>&#13;\n<ul>&#13;\n<li>利用全备的sql文件中记录的CHANGE MASTER语句，binlog文件及其位置点信息，找出binlog文件增量的部分</li><li>用mysqlbinlog命令将上述的binlog文件导出为sql文件，并剔除其中的drop语句</li><li>通过全备文件和增量binlog文件的导出sql文件，就可以恢复到完整的数据</li></ul>&#13;\n<h3>三、过程示意图</h3>&#13;\n<p><img src="http://img.blog.csdn.net/20170304145705262?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbDEwMjgzODY4MDQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<h3>四、操作过程</h3>&#13;\n<h4>1、模拟数据</h4>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2242240" snippet_file_name="blog_20170304_1_6802" name="code" class="sql">CREATE TABLE `student` (\n `id` int(11) NOT NULL AUTO_INCREMENT,\n `name` char(20) NOT NULL,\n `age` tinyint(2) NOT NULL DEFAULT '0',\n PRIMARY KEY (`id`),\n KEY `index_name` (`name`)\n) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8 \n\nmysql&gt; insert student values(1,'zhangsan',20); \nmysql&gt; insert student values(2,'lisi',21); \nmysql&gt; insert student values(3,'wangwu',22);</pre>&#13;\n<p></p>&#13;\n<h4>2、全备命令</h4>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2242240" snippet_file_name="blog_20170304_2_9559861" name="code" class="sql"># mysqldump -uroot -p -B -F -R -x --master-data=2 test|gzip &gt;/server/backup/test_$(date +%F).sql.gz\n\n参数说明：\n-B 指定数据库\n-F 刷新日志\n-R 备份存储过程等\n-x 锁表\n--master-data 在备份语句里添加CHANGE MASTER语句以及binlog文件及位置点信息</pre>&#13;\n<p></p>&#13;\n<h4>3、继续插入数据并删库</h4>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2242240" snippet_file_name="blog_20170304_3_4161667" name="code" class="sql">mysql&gt; insert student values(6,'xiaoming',20);\n \nmysql&gt; insert student values(6,'xiaohong',20); \n\n此时误操作，删除了test数据库\nmysql&gt; drop database test;</pre>此时，全备之后到误操作时刻之间，用户写入的数据在binlog中，需要恢复出来<br />&#13;\n<p></p>&#13;\n<h4>4.查看全备之后新增的binlog文件</h4>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2242240" snippet_file_name="blog_20170304_4_8971216" name="code" class="sql"># cd /server/backup/\n# ls\ntest_2017-03-04.sql.gz\n# gzip -d test_2017-03-04.sql.gz \n# grep CHANGE test_2017-03-04.sql \n-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000003', MASTER_LOG_POS=107;</pre>这是全备时刻的binlog文件位置，即mysql-bin.000003的107行，因此在该文件之前的binlog文件中的数据都已经包含在这个全备的sql文件中了<br />&#13;\n<p></p>&#13;\n<h4>5. 移动binlog文件，并读取sql，剔除其中的drop语句</h4>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2242240" snippet_file_name="blog_20170304_5_9669328" name="code" class="sql"># cp /data/3306/mysql-bin.000003 /server/backup/\n# mysqlbinlog -d test mysql-bin.000003 &gt;003bin.sql\n# 用vim编辑文件，剔除drop语句</pre><strong>在恢复全备数据之前必须将该binlog文件移出，否则恢复过程中，会继续写入语句到binlog，最终导致增量恢复数据部分变得比较混乱</strong><br />&#13;\n<p></p>&#13;\n<h4>6. 恢复数据</h4>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2242240" snippet_file_name="blog_20170304_6_8938980" name="code" class="sql"># mysql -uroot -p &lt;test_2017-03-04.sql \n# mysql -uroot -p -e "select csdn-100.html csdn-101.html csdn-102.html csdn-103.html csdn-104.html csdn-105.html csdn-106.html csdn-107.html csdn-108.html csdn-109.html csdn-10.html csdn-110.html csdn-111.html csdn-112.html csdn-113.html csdn-114.html csdn-115.html csdn-116.html csdn-117.html csdn-118.html csdn-119.html csdn-11.html csdn-120.html csdn-121.html csdn-122.html csdn-123.html csdn-124.html csdn-125.html csdn-126.html csdn-127.html csdn-128.html csdn-129.html csdn-12.html csdn-130.html csdn-131.html csdn-132.html csdn-133.html csdn-134.html csdn-135.html csdn-136.html csdn-137.html csdn-138.html csdn-139.html csdn-13.html csdn-140.html csdn-141.html csdn-142.html csdn-143.html csdn-144.html csdn-145.html csdn-146.html csdn-147.html csdn-148.html csdn-149.html csdn-14.html csdn-150.html csdn-151.html csdn-152.html csdn-153.html csdn-154.html csdn-155.html csdn-156.html csdn-157.html csdn-158.html csdn-159.html csdn-15.html csdn-160.html csdn-161.html csdn-162.html csdn-163.html csdn-164.html csdn-165.html csdn-166.html csdn-167.html csdn-168.html csdn-169.html csdn-16.html csdn-170.html csdn-171.html csdn-172.html csdn-173.html csdn-174.html csdn-175.html csdn-176.html csdn-177.html csdn-178.html csdn-179.html csdn-17.html csdn-180.html csdn-181.html csdn-182.html csdn-183.html csdn-184.html csdn-185.html csdn-186.html csdn-187.html csdn-188.html csdn-189.html csdn-18.html csdn-190.html csdn-191.html csdn-192.html csdn-193.html csdn-194.html csdn-195.html csdn-196.html csdn-197.html csdn-198.html csdn-19.html csdn-1.html csdn-20.html csdn-21.html csdn-22.html csdn-23.html csdn-24.html csdn-25.html csdn-26.html csdn-27.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-49.html csdn-4.html csdn-50.html csdn-51.html csdn-52.html csdn-53.html csdn-54.html csdn-55.html csdn-56.html csdn-57.html csdn-58.html csdn-59.html csdn-5.html csdn-60.html csdn-61.html csdn-62.html csdn-63.html csdn-64.html csdn-65.html csdn-66.html csdn-67.html csdn-68.html csdn-69.html csdn-6.html csdn-70.html csdn-71.html csdn-72.html csdn-73.html csdn-74.html csdn-75.html csdn-76.html csdn-77.html csdn-78.html csdn-79.html csdn-7.html csdn-80.html csdn-81.html csdn-82.html csdn-83.html csdn-84.html csdn-85.html csdn-86.html csdn-87.html csdn-88.html csdn-89.html csdn-8.html csdn-90.html csdn-91.html csdn-92.html csdn-93.html csdn-94.html csdn-95.html csdn-96.html csdn-97.html csdn-98.html csdn-99.html csdn-9.html mysql.sh from test.student;"\n+----+----------+-----+\n| id | name | age |\n+----+----------+-----+\n| 1 | zhangsan | 20 |\n| 2 | lisi | 21 |\n| 3 | wangwu | 22 |\n+----+----------+-----+\n//此时恢复了全备时刻的数据\n//然后使用003bin.sql文件恢复全备时刻到删除数据库之间，新增的数据\n# mysql -uroot -p test&lt;003bin.sql &lt;span style="color: #3366ff;" data-mce-style="color: #3366ff;"&gt;&lt;-需要指定恢复的数据库\n&lt;/span&gt;# mysql -uroot -p -e "select csdn-100.html csdn-101.html csdn-102.html csdn-103.html csdn-104.html csdn-105.html csdn-106.html csdn-107.html csdn-108.html csdn-109.html csdn-10.html csdn-110.html csdn-111.html csdn-112.html csdn-113.html csdn-114.html csdn-115.html csdn-116.html csdn-117.html csdn-118.html csdn-119.html csdn-11.html csdn-120.html csdn-121.html csdn-122.html csdn-123.html csdn-124.html csdn-125.html csdn-126.html csdn-127.html csdn-128.html csdn-129.html csdn-12.html csdn-130.html csdn-131.html csdn-132.html csdn-133.html csdn-134.html csdn-135.html csdn-136.html csdn-137.html csdn-138.html csdn-139.html csdn-13.html csdn-140.html csdn-141.html csdn-142.html csdn-143.html csdn-144.html csdn-145.html csdn-146.html csdn-147.html csdn-148.html csdn-149.html csdn-14.html csdn-150.html csdn-151.html csdn-152.html csdn-153.html csdn-154.html csdn-155.html csdn-156.html csdn-157.html csdn-158.html csdn-159.html csdn-15.html csdn-160.html csdn-161.html csdn-162.html csdn-163.html csdn-164.html csdn-165.html csdn-166.html csdn-167.html csdn-168.html csdn-169.html csdn-16.html csdn-170.html csdn-171.html csdn-172.html csdn-173.html csdn-174.html csdn-175.html csdn-176.html csdn-177.html csdn-178.html csdn-179.html csdn-17.html csdn-180.html csdn-181.html csdn-182.html csdn-183.html csdn-184.html csdn-185.html csdn-186.html csdn-187.html csdn-188.html csdn-189.html csdn-18.html csdn-190.html csdn-191.html csdn-192.html csdn-193.html csdn-194.html csdn-195.html csdn-196.html csdn-197.html csdn-198.html csdn-19.html csdn-1.html csdn-20.html csdn-21.html csdn-22.html csdn-23.html csdn-24.html csdn-25.html csdn-26.html csdn-27.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-49.html csdn-4.html csdn-50.html csdn-51.html csdn-52.html csdn-53.html csdn-54.html csdn-55.html csdn-56.html csdn-57.html csdn-58.html csdn-59.html csdn-5.html csdn-60.html csdn-61.html csdn-62.html csdn-63.html csdn-64.html csdn-65.html csdn-66.html csdn-67.html csdn-68.html csdn-69.html csdn-6.html csdn-70.html csdn-71.html csdn-72.html csdn-73.html csdn-74.html csdn-75.html csdn-76.html csdn-77.html csdn-78.html csdn-79.html csdn-7.html csdn-80.html csdn-81.html csdn-82.html csdn-83.html csdn-84.html csdn-85.html csdn-86.html csdn-87.html csdn-88.html csdn-89.html csdn-8.html csdn-90.html csdn-91.html csdn-92.html csdn-93.html csdn-94.html csdn-95.html csdn-96.html csdn-97.html csdn-98.html csdn-99.html csdn-9.html mysql.sh from test.student;"\n+----+----------+-----+\n| id | name | age |\n+----+----------+-----+\n| 1 | zhangsan | 20 |\n| 2 | lisi | 20 |\n| 3 | wangwu | 20 |\n| 4 | xiaoming | 20 | \n| 5 | xiaohong | 20 |\n+----+----------+-----+\n完成</pre>&#13;\n<p></p>&#13;\n<h3>五、总结</h3>&#13;\n<p></p>&#13;\n<ul>&#13;\n<li style="text-align:justify">适合人为SQL语句造成的误操作或者没有主从复制等的热备情况宕机时的修复</li><li style="text-align:justify">恢复条件要全备和增量的所有数据</li><li style="text-align:justify">恢复时建议对外停止更新，即禁止更新数据库</li><li style="text-align:justify">先恢复全量，然后把全备时刻点以后的增量日志，按顺序恢复成SQL文件，然后把文件中有问题的SQL语句删除（也可通过时间和位置点），再恢复到数据库</li></ul>&#13;\n<br />&#13;\n<p></p>&#13;\n &#13;\n
