\n\n<p><a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/54653691">转载请注明出处：http://blog.csdn.net/l1028386804/article/details/54653691</a><br />&#13;\n</p>&#13;\n<p>MySQL主从复制一般情况下我们会设置需要同步的数据库，使用参数配置选项，binlog-do-db，可以在master上指定需要同步的数据库，replicate-do-db在从数据看上指定需要同步的数据库。（一般只设定master上的binlog-do-db即可，不需要两个同时设定。以防万一，在slave也可以加上replicate-ignore-db）。<br />&#13;\n今天，我遇到的问题是，在master上面新增了一个数据库，这个时候如何把新加的这个数据库添加到MySQL的主从复制链里？（即不重新复制整个库的情况下，重新设置主从复制）。<br />&#13;\n</p>&#13;\n<p>首先，我们列举一下主从复制的基本步骤，（MySQL主从首先需要在各自服务器配置好）。<br />&#13;\n</p>&#13;\n<h3>1. 复制数据库</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_1_1139095" name="code" class="plain">mysqldump --master-data --single-transaction -R --databases [db_name] | gzip -9 - | pv &gt; all-db-with-master-data.sql.gz</pre>注意：innodb用 –single-transaction, myisam需要用 –lock-all-tables。<br />&#13;\n<p></p>&#13;\n<h3>2. 复制，导入数据</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_2_3221456" name="code" class="plain">pv &lt; all-db-with-master-data.sql.gz | zcat | mysql</pre>&#13;\n<p></p>&#13;\n<h3>3. 启动slave数据库。</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_3_1334082" name="code" class="plain">slave start</pre>注意：切换到主的语句已经在导出的sql语句里面了，注意查看。change master to master_log_file=’(binlog name in relay_master_log_file)’, master_log_pos=(exec_master_log_pos number)。<br />&#13;\n那么，在现有的主从复制结构中，如何增加一个新的数据库进去？比如我们要增加一个数据库在master服务器上，比如，名为newdb的数据库。具体操作如下：<br />&#13;\n<p></p>&#13;\n<h3>1. 从服务上，停掉slave数据库。</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_4_4670962" name="code" class="plain">stop slave;</pre>&#13;\n<p></p>&#13;\n<h3>2. 主服务器上，导出新数据库。</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_5_8356505" name="code" class="plain">mysqldump --master-data --single-transaction -R --databases newdb &gt; newdb.sql</pre>&#13;\n<p></p>&#13;\n<h3>3. 修改主服务器my.cnf文件</h3>&#13;\n<p>主服务器上，修改my.cnf文件，添加新库到binlog-do-db参数，重启mysql。<br />&#13;\n</p>&#13;\n<h3>4. 查找当前的日志文件以及位置</h3>&#13;\n<p>在导出的newdb.sql里面查找当前的日志文件以及位置（change master to …)<br />&#13;\n然后让slave服务器执行到这个位置。<br />&#13;\n</p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_6_2390714" name="code" class="plain">start slave until MASTER_LOG_FILE="mysql-bin.000001", MASTER_LOG_POS=1222220;</pre>其中MASTER_LOG_FILE以及MASTER_LOG_POS在导出的数据库newdb.sql顶部位置查找。<br />&#13;\n<p></p>&#13;\n<h3>5. 导入新库到从服务器上。</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_7_333815" name="code" class="plain">mysql &lt; newdb.sql</pre>&#13;\n<p></p>&#13;\n<h3>6. 启动从服务器</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2144190" snippet_file_name="blog_20170121_8_6178166" name="code" class="plain">start slave</pre>其中比较重要的是在主服务器上导出新库时的日志位置（position A），这个点很重要，以这个点做为分界线，导入新库。<br />&#13;\n这种方法也同样适用于某个数据库或者某个数据表不同步的情况，比如主从数据库有一个表由于某些原因数据不一致，那么上面的方法只需要去掉重启数据库一步，其他的操作基本都是相同的<br />&#13;\n<br />&#13;\n<p></p>&#13;\n &#13;\n
