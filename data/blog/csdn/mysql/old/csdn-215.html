\n\n<p><a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/54578505">转载请注明出处：http://blog.csdn.net/l1028386804/article/details/54578505</a><br />&#13;\n</p>&#13;\n<p>最近，项目中经常遇到MySQL连接丢失的问题，研究了下解决方法，现共享出来，大家可以参考一下，下面我们就进入正题。</p>&#13;\n<h3>1、错误日志</h3>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2132034" snippet_file_name="blog_20170116_1_6457738" name="code" class="plain">Caused by: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 20,820,001 milliseconds ago. The last packet sent successfully to the server was 20,820,002 milliseconds ago. is longer than the server configured value of 'wait_timeout'. You should consider either expiring and/or testing connection validity before use in your application, increasing the server configured values for client timeouts, or using the Connector/J connection property 'autoReconnect=true' to avoid this problem.\n at sun.reflect.GeneratedConstructorAccessor29.newInstance(Unknown Source) ~[na:na]\n at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) ~[na:1.7.0_51]\n at java.lang.reflect.Constructor.newInstance(Constructor.java:526) ~[na:1.7.0_51]\n at com.mysql.jdbc.Util.handleNewInstance(Util.java:411) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mysql.jdbc.SQLError.createCommunicationsException(SQLError.java:1129) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mysql.jdbc.MysqlIO.send(MysqlIO.java:3988) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2598) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2778) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2828) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mysql.jdbc.ConnectionImpl.setAutoCommit(ConnectionImpl.java:5372) ~[mysql-connector-java-5.1.29.jar:na]\n at com.mchange.v2.c3p0.impl.NewProxyConnection.setAutoCommit(NewProxyConnection.java:881) ~[c3p0-0.9.1.1.jar:0.9.1.1]\n at org.quartz.impl.jdbcjobstore.AttributeRestoringConnectionInvocationHandler.setAutoCommit(AttributeRestoringConnectionInvocationHandler.java:98) ~[quartz-2.2.1.jar:na]</pre>&#13;\n<p></p>&#13;\n<h3>2、解决办法</h3>&#13;\n<p>- 如果使用的是JDBC，在JDBC URL上添加?autoReconnect=true，如：<br />&#13;\n</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="2132034" snippet_file_name="blog_20170116_2_3523589" name="code" class="plain">jdbc:mysql://127.0.0.1:3306/mydb?autoReconnect=true</pre>- 如果是在Spring中使用DBCP连接池，在定义datasource增加属性validationQuery和testOnBorrow，如：<br />&#13;\n<pre code_snippet_id="2132034" snippet_file_name="blog_20170116_3_6096318" name="code" class="html">&lt;bean id="vrsRankDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close"&gt;\n &lt;property name="driverClassName" value="${jdbc.driverClassName}" /&gt;\n &lt;property name="url" value="${countNew.jdbc.url}" /&gt;\n &lt;property name="username" value="${countNew.jdbc.user}" /&gt;\n &lt;property name="password" value="${countNew.jdbc.pwd}" /&gt;\n &lt;property name="validationQuery" value="SELECT 1" /&gt;\n &lt;property name="testOnBorrow" value="true"/&gt;\n&lt;/bean&gt;</pre>- 如果是在Spring中使用c3p0连接池，则在定义datasource的时候，添加属性testConnectionOnCheckin和testConnectionOnCheckout，如：<br />&#13;\n<pre code_snippet_id="2132034" snippet_file_name="blog_20170116_4_4416687" name="code" class="html">&lt;bean name="cacheCloudDB" class="com.mchange.v2.c3p0.ComboPooledDataSource"&gt;\n &lt;property name="driverClass" value="${jdbc.driver}"/&gt;\n &lt;property name="jdbcUrl" value="${cache.url}"/&gt;\n &lt;property name="user" value="${cache.user}"/&gt;\n &lt;property name="password" value="${cache.password}"/&gt;\n &lt;property name="initialPoolSize" value="10"/&gt;\n &lt;property name="maxPoolSize" value="${cache.maxPoolSize}"/&gt;\n &lt;property name="testConnectionOnCheckin" value="false"/&gt;\n &lt;property name="testConnectionOnCheckout" value="true"/&gt;\n &lt;property name="preferredTestQuery" value="SELECT 1"/&gt;\n&lt;/bean&gt;</pre><br />&#13;\n<p></p>&#13;\n &#13;\n
