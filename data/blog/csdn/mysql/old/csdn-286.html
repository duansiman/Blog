\n <div class="markdown_views"><h1 id="查询高速缓冲概述">查询高速缓冲概述</h1>\n\n<p>查询缓存存储SELECT查询的文本以及发送给客户端的相应结果。如果随后收到一个相同的查询，服务器从查询缓存中重新得到查询结果，而不再需要解析和执行查询。如果你有一个不经常改变的表并且服务器收到该表的大量相同查询，查询缓存在这样的应用环境中十分有用。对于许多Web服务器来说存在这种典型情况，它根据数据库内容生成大量的动态页面。 <br />\n备注1.查询缓存不返回旧的数据。当表更改后（如INSERT、UPDATE、DELETE、TRUNCATE、ALTER TABLE、DROP TABLE或DROP DATABASE操作），查询缓存值的相关条目被清空。2.如果你有许多mysqld服务器更新相同的MyISAM表，在这种情况下查询缓存不起作用。3.查询缓存不适用于服务器方编写的语句。如果正在使用服务器方编写的语句，要考虑到这些语句将不会应用查询缓存.</p>\n\n\n\n<h1 id="查询高速缓冲如何工作">查询高速缓冲如何工作</h1>\n\n<p>当MySQL服务器收到一个查询请求的时候,MySQL服务器首先检查用户对所有相关数据库和表的SELECT权限，如权限通过，然后以该SQL文本作为key来从查询缓存中检索是否有相同的key（因为数据缓存都是以SQL文本作为key来保存的），如果从查询缓冲中找到对应的key值，就返回一个对应的查询结果，服务器把Qcache_hits状态变量的值加一，而不需要解析器对sql语句进行解析，如果查找不到对应的key值，然后执行sql的解析，然后查询，可以参考下图。 <br />\n<img src="http://img.blog.csdn.net/20160529191659266" alt="这里写图片描述" title="" /> <br />\n备注： <br />\n1.作为key值的sql语句是区分大小写的，即<code>SELECT csdn-100.html csdn-101.html csdn-102.html csdn-103.html csdn-104.html csdn-105.html csdn-106.html csdn-107.html csdn-108.html csdn-109.html csdn-10.html csdn-110.html csdn-111.html csdn-112.html csdn-113.html csdn-114.html csdn-115.html csdn-116.html csdn-117.html csdn-118.html csdn-119.html csdn-11.html csdn-120.html csdn-121.html csdn-122.html csdn-123.html csdn-124.html csdn-125.html csdn-126.html csdn-127.html csdn-128.html csdn-129.html csdn-12.html csdn-130.html csdn-131.html csdn-132.html csdn-133.html csdn-134.html csdn-135.html csdn-136.html csdn-137.html csdn-138.html csdn-139.html csdn-13.html csdn-140.html csdn-141.html csdn-142.html csdn-143.html csdn-144.html csdn-145.html csdn-146.html csdn-147.html csdn-148.html csdn-149.html csdn-14.html csdn-150.html csdn-151.html csdn-152.html csdn-153.html csdn-154.html csdn-155.html csdn-156.html csdn-157.html csdn-158.html csdn-159.html csdn-15.html csdn-160.html csdn-161.html csdn-162.html csdn-163.html csdn-164.html csdn-165.html csdn-166.html csdn-167.html csdn-168.html csdn-169.html csdn-16.html csdn-170.html csdn-171.html csdn-172.html csdn-173.html csdn-174.html csdn-175.html csdn-176.html csdn-177.html csdn-178.html csdn-179.html csdn-17.html csdn-180.html csdn-181.html csdn-182.html csdn-183.html csdn-184.html csdn-185.html csdn-186.html csdn-187.html csdn-188.html csdn-189.html csdn-18.html csdn-190.html csdn-191.html csdn-192.html csdn-193.html csdn-194.html csdn-195.html csdn-196.html csdn-197.html csdn-198.html csdn-199.html csdn-19.html csdn-1.html csdn-200.html csdn-201.html csdn-202.html csdn-203.html csdn-204.html csdn-205.html csdn-206.html csdn-207.html csdn-208.html csdn-209.html csdn-20.html csdn-210.html csdn-211.html csdn-212.html csdn-213.html csdn-214.html csdn-215.html csdn-216.html csdn-217.html csdn-218.html csdn-219.html csdn-21.html csdn-220.html csdn-221.html csdn-222.html csdn-223.html csdn-224.html csdn-225.html csdn-226.html csdn-227.html csdn-228.html csdn-229.html csdn-22.html csdn-230.html csdn-231.html csdn-232.html csdn-233.html csdn-234.html csdn-235.html csdn-236.html csdn-237.html csdn-238.html csdn-239.html csdn-23.html csdn-240.html csdn-241.html csdn-242.html csdn-243.html csdn-244.html csdn-245.html csdn-246.html csdn-247.html csdn-248.html csdn-249.html csdn-24.html csdn-250.html csdn-251.html csdn-252.html csdn-253.html csdn-254.html csdn-255.html csdn-256.html csdn-257.html csdn-258.html csdn-259.html csdn-25.html csdn-260.html csdn-261.html csdn-262.html csdn-263.html csdn-264.html csdn-265.html csdn-266.html csdn-267.html csdn-268.html csdn-269.html csdn-26.html csdn-270.html csdn-271.html csdn-272.html csdn-273.html csdn-274.html csdn-275.html csdn-276.html csdn-277.html csdn-278.html csdn-279.html csdn-27.html csdn-280.html csdn-281.html csdn-282.html csdn-283.html csdn-284.html csdn-285.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-49.html csdn-4.html csdn-50.html csdn-51.html csdn-52.html csdn-53.html csdn-54.html csdn-55.html csdn-56.html csdn-57.html csdn-58.html csdn-59.html csdn-5.html csdn-60.html csdn-61.html csdn-62.html csdn-63.html csdn-64.html csdn-65.html csdn-66.html csdn-67.html csdn-68.html csdn-69.html csdn-6.html csdn-70.html csdn-71.html csdn-72.html csdn-73.html csdn-74.html csdn-75.html csdn-76.html csdn-77.html csdn-78.html csdn-79.html csdn-7.html csdn-80.html csdn-81.html csdn-82.html csdn-83.html csdn-84.html csdn-85.html csdn-86.html csdn-87.html csdn-88.html csdn-89.html csdn-8.html csdn-90.html csdn-91.html csdn-92.html csdn-93.html csdn-94.html csdn-95.html csdn-96.html csdn-97.html csdn-98.html csdn-99.html csdn-9.html mysql.sh FROM t1</code>与<code>select csdn-100.html csdn-101.html csdn-102.html csdn-103.html csdn-104.html csdn-105.html csdn-106.html csdn-107.html csdn-108.html csdn-109.html csdn-10.html csdn-110.html csdn-111.html csdn-112.html csdn-113.html csdn-114.html csdn-115.html csdn-116.html csdn-117.html csdn-118.html csdn-119.html csdn-11.html csdn-120.html csdn-121.html csdn-122.html csdn-123.html csdn-124.html csdn-125.html csdn-126.html csdn-127.html csdn-128.html csdn-129.html csdn-12.html csdn-130.html csdn-131.html csdn-132.html csdn-133.html csdn-134.html csdn-135.html csdn-136.html csdn-137.html csdn-138.html csdn-139.html csdn-13.html csdn-140.html csdn-141.html csdn-142.html csdn-143.html csdn-144.html csdn-145.html csdn-146.html csdn-147.html csdn-148.html csdn-149.html csdn-14.html csdn-150.html csdn-151.html csdn-152.html csdn-153.html csdn-154.html csdn-155.html csdn-156.html csdn-157.html csdn-158.html csdn-159.html csdn-15.html csdn-160.html csdn-161.html csdn-162.html csdn-163.html csdn-164.html csdn-165.html csdn-166.html csdn-167.html csdn-168.html csdn-169.html csdn-16.html csdn-170.html csdn-171.html csdn-172.html csdn-173.html csdn-174.html csdn-175.html csdn-176.html csdn-177.html csdn-178.html csdn-179.html csdn-17.html csdn-180.html csdn-181.html csdn-182.html csdn-183.html csdn-184.html csdn-185.html csdn-186.html csdn-187.html csdn-188.html csdn-189.html csdn-18.html csdn-190.html csdn-191.html csdn-192.html csdn-193.html csdn-194.html csdn-195.html csdn-196.html csdn-197.html csdn-198.html csdn-199.html csdn-19.html csdn-1.html csdn-200.html csdn-201.html csdn-202.html csdn-203.html csdn-204.html csdn-205.html csdn-206.html csdn-207.html csdn-208.html csdn-209.html csdn-20.html csdn-210.html csdn-211.html csdn-212.html csdn-213.html csdn-214.html csdn-215.html csdn-216.html csdn-217.html csdn-218.html csdn-219.html csdn-21.html csdn-220.html csdn-221.html csdn-222.html csdn-223.html csdn-224.html csdn-225.html csdn-226.html csdn-227.html csdn-228.html csdn-229.html csdn-22.html csdn-230.html csdn-231.html csdn-232.html csdn-233.html csdn-234.html csdn-235.html csdn-236.html csdn-237.html csdn-238.html csdn-239.html csdn-23.html csdn-240.html csdn-241.html csdn-242.html csdn-243.html csdn-244.html csdn-245.html csdn-246.html csdn-247.html csdn-248.html csdn-249.html csdn-24.html csdn-250.html csdn-251.html csdn-252.html csdn-253.html csdn-254.html csdn-255.html csdn-256.html csdn-257.html csdn-258.html csdn-259.html csdn-25.html csdn-260.html csdn-261.html csdn-262.html csdn-263.html csdn-264.html csdn-265.html csdn-266.html csdn-267.html csdn-268.html csdn-269.html csdn-26.html csdn-270.html csdn-271.html csdn-272.html csdn-273.html csdn-274.html csdn-275.html csdn-276.html csdn-277.html csdn-278.html csdn-279.html csdn-27.html csdn-280.html csdn-281.html csdn-282.html csdn-283.html csdn-284.html csdn-285.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-49.html csdn-4.html csdn-50.html csdn-51.html csdn-52.html csdn-53.html csdn-54.html csdn-55.html csdn-56.html csdn-57.html csdn-58.html csdn-59.html csdn-5.html csdn-60.html csdn-61.html csdn-62.html csdn-63.html csdn-64.html csdn-65.html csdn-66.html csdn-67.html csdn-68.html csdn-69.html csdn-6.html csdn-70.html csdn-71.html csdn-72.html csdn-73.html csdn-74.html csdn-75.html csdn-76.html csdn-77.html csdn-78.html csdn-79.html csdn-7.html csdn-80.html csdn-81.html csdn-82.html csdn-83.html csdn-84.html csdn-85.html csdn-86.html csdn-87.html csdn-88.html csdn-89.html csdn-8.html csdn-90.html csdn-91.html csdn-92.html csdn-93.html csdn-94.html csdn-95.html csdn-96.html csdn-97.html csdn-98.html csdn-99.html csdn-9.html mysql.sh from t1</code>对应的key值是不一样的。所以，如果开启了查询缓冲，在写SQL语句的时候，应注意这点。 <br />\n2.如果一个表被更改了，那么使用那个表的所有缓冲查询将不再有效，并且从缓冲区中移出，这样保证了数据的一致性（即表中数据和缓冲中数据一致性）。</p>\n\n\n\n<h1 id="查询高速缓冲配置">查询高速缓冲配置</h1>\n\n<p>1.查看查询缓冲是否可以 <br />\nMySQL中，可以通过have_query_cache服务器系统变量指示查询缓存是否可用。即使禁用查询缓存，当使用标准 MySQL二进制时，这个值总是YES。 <br />\n<img src="http://img.blog.csdn.net/20160529192802177" alt="这里写图片描述" title="" /> <br />\n2.其他重要配置参数 <br />\n查询缓存系统变量名以query_cache_ 开头，如下图，我们将逐一说明。 <br />\n<img src="http://img.blog.csdn.net/20160529193401208" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>having_query_cache <br />\n就不在细说了，主要是控制查询缓冲的开启与否。</li>\n<li>query_cache_limit <br />\n单个查询可以被缓存的具体查询结果的最大值。</li>\n<li>query_cache_min_res_unit <br />\n该参数是控制存储查询缓冲时候，分配的内存块大小。当查询进行的时候，但如果要保存的结果比较大，超过query_cache_min_res_unit的值 ，这时候mysql将一边检索结果，一边进行保存结果，所以，有时候并不是把所有结果全部得到后再进行一次性保存，而是每次分配一块 query_cache_min_res_unit 大小的内存空间保存结果集，使用完后，接着再分配一个这样的块，如果还不不够，接着再分配一个块，依此类推，也就是说，有可能在一次查询中，mysql要进行多次内存分配的操作。query_cache_min_res_unit默认值是4KB。 如果你有大量返回小结果数据的查询，默认数据块大小可能会导致内存碎片，显示为大量空闲内存块。由于缺少内存，内存碎片会强制查询缓存从缓存内存中修整（删除）查询。这时，你应该减少query_cache_min_res_unit变量的值，空闲块和由于修整而移出的查询的数量通过Qcache_free_blocks和Qcache_lowmem_prunes变量的值给出。当然 如果大量查询返回大结果（检查 Qcache_total_blocks和Qcache_queries_in_cache状态变量），你可以通过增加query_cache_min_res_unit变量的值来提高性。</li>\n<li><p>query_cache_size <br />\n查询缓存大小，设置为0表示禁用查询缓存。 默认缓存大小设置为0；也就是禁用查询缓存。当设置query_cache_size变量为非零值时，应记住查询缓存至少大约需要40KB来分配其数据结构。(具体大小取决于系统结构）。如果你把该值设置的太小，将会得到一个警告，且会将query_cache_size值设置为0。 <br />\n<img src="http://img.blog.csdn.net/20160529211655422" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20160529211835065" alt="这里写图片描述" title="" /></p></li>\n<li>query_cache_type <br />\n该参数主要是控制缓存行为的。query_cache_type变量的GLOBAL值将决定更改后所有连接客户端的缓存行为。在linux下，可在my.cnf（在win下，可在my.ini）中进行配置。具体客户端可以通过设置query_cache_type变量的会话值控制它们本身连接的缓存行为。例如，一个客户可以禁用自己的查询缓存。 该参数有三种值如下 <br />\n<ul><li>0或OFF <br />\n将阻止缓存或查询缓存结果</li>\n<li>1或ON <br />\n将允许缓存，以SELECT SQL_NO_CACHE开始的查询语句除外。</li>\n<li>2或DEMAND <br />\n仅对以SELECT SQL_CACHE开始的那些查询语句启用缓存</li></ul></li>\n</ul>\n\n\n\n<h1 id="查询高速缓冲维护">查询高速缓冲维护</h1>\n\n\n\n<h2 id="碎片的清理">碎片的清理</h2>\n\n<p>在前面，我们可以得知，使用缓存，不可避免内存碎片，我们可以使用FLUSH QUERY CACHE语句来清理查询缓存碎片，以提高内存使用性能。该语句不从缓存中移出任何查询。RESET QUERY CACHE语句从查询缓存中移出所有查询。FLUSH TABLES语句也执行同样的工作，区别optimize table tableName，关于optimize可以参考（<a href="http://blog.csdn.net/hsd2012/article/details/51485250">http://blog.csdn.net/hsd2012/article/details/51485250</a>）。</p>\n\n\n\n<h2 id="查询缓存性能监控">查询缓存性能监控</h2>\n\n<p>为了监视查询缓存性能，使用SHOW STATUS查看缓存状态变量： <br />\n<img src="http://img.blog.csdn.net/20160529213532040" alt="这里写图片描述" title="" /> <br />\nQcache_free_blocks：缓存中相邻内存块的个数。数目大说明可能有碎片。执行FLUSH QUERY CACHE会对缓存中的碎片进行整理，只保留一个空闲块。 <br />\nQcache_free_memory：缓存中的空闲内存。 <br />\nQcache_hits：每次查询在缓存中命中时就增大 <br />\nQcache_inserts：每次插入一个查询时就增大。命中次数除以插入次数就是不中比率。 <br />\nQcache_lowmem_prunes：缓存出现内存不足，并且必须为了缓存新的查询，而从查询缓冲区中移出到自由内存中的查询的数目。这个数字最好长时间来看;如果这个 数字在不断增长，就表示可能碎片非常严重，或者内存很少。(上面的 Qcache_free_blocks和Qcache_free_memory可以告诉您属于哪种情况) 。从查询缓冲区移除查询缓冲，使用最近最少使用(LRU)策略。 <br />\nQcache_not_cached：不适合进行缓存的查询的数量，通常是由于这些查询不是 SELECT 语句或者用了now()之类的函数。 <br />\nQcache_queries_in_cache：当前缓存的查询(和响应)的数量。 <br />\nQcache_total_blocks：缓存中块的数量。 <br />\nQcache_total_blocks和Qcache_free_blocks可以显示查询缓存内存碎片。</p>\n\n<p>备注 <br />\n以上叙述，主要参考mysql手册。</p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
