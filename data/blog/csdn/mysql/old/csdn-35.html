\n\n<h1 style="text-align:center">mysql <span style="font-family:宋体">批量更新与批量更新多条记录的不同值实现方法</span></h1>&#13;\n<blockquote style="margin:0 0 0 40px; border:none; padding:0px">&#13;\n<p>在<span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">中批量更新我们可能使用</span><span style="font-family:Times New Roman">update,replace into</span><span style="font-family:宋体">来操作，下面详细介绍</span><span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">批量更新与性能</span>。</p>&#13;\n</blockquote>&#13;\n<h2>批量更新</h2>&#13;\n<p>mysql<span style="font-family:宋体">更新语句很简单，更新一条数据的某个字段，一般这样写：</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">UPDATE mytable SET myfield = 'value' WHERE other_field = 'other_value';</span></p>&#13;\n<p>如果更新同一字段为同一个值，<span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">也很简单，修改下</span><span style="font-family:Times New Roman">where</span><span style="font-family:宋体">即可：</span></p>&#13;\n<p><span style="color:rgb(0,0,255)"> UPDATE mytable SET myfield = 'value' WHERE other_field in ('other_values');</span></p>&#13;\n<p>这里注意‘<span style="font-family:Times New Roman">other_values' </span><span style="font-family:宋体">是一个逗号（，）分隔的字符串，如：</span><span style="font-family:Times New Roman">1,2,3</span></p>&#13;\n<p>那如果更新多条数据为不同的值，可能很多人会这样写：</p>&#13;\n<p><span style="color:rgb(0,0,255)">foreach ($display_order as $id =&gt; $ordinal) { </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    $sql = "UPDATE categories SET display_order = $ordinal WHERE id = $id"; </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    mysql_query($sql); </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">}</span></p>&#13;\n<p>即是循环一条一条的更新记录。一条记录<span style="font-family:Times New Roman">update</span><span style="font-family:宋体">一次，这样性能很差，也很容易造成阻塞。</span></p>&#13;\n<p>那么能不能一条<span style="font-family:Times New Roman">sql</span><span style="font-family:宋体">语句实现批量更新呢？</span><span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">并没有提供直接的方法来实现批量更新，但是可以用点小技巧来实现。</span></p>&#13;\n<p>UPDATE mytable </p>&#13;\n<p>    SET myfield = CASE id </p>&#13;\n<p>        WHEN 1 THEN 'value'</p>&#13;\n<p>        WHEN 2 THEN 'value'</p>&#13;\n<p>        WHEN 3 THEN 'value'</p>&#13;\n<p>    END</p>&#13;\n<p>WHERE id IN (1,2,3)</p>&#13;\n<p>这里使用了<span style="font-family:Times New Roman">case when </span><span style="font-family:宋体">这个小技巧来实现批量更新。</span></p>&#13;\n<h2>举个例子：</h2>&#13;\n<p><span style="color:rgb(0,0,255)">UPDATE categories </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    SET display_order = CASE id </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 1 THEN 3 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 2 THEN 4 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 3 THEN 5 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    END</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">WHERE id IN (1,2,3)</span></p>&#13;\n<p>这句<span style="font-family:Times New Roman">sql</span><span style="font-family:宋体">的意思是，更新</span><span style="font-family:Times New Roman">display_order </span><span style="font-family:宋体">字段，如果</span><span style="font-family:Times New Roman">id=1 </span><span style="font-family:宋体">则</span><span style="font-family:Times New Roman">display_order </span><span style="font-family:宋体">的值为</span><span style="font-family:Times New Roman">3</span><span style="font-family:宋体">，如果</span><span style="font-family:Times New Roman">id=2 </span><span style="font-family:宋体">则 </span><span style="font-family:Times New Roman">display_order </span><span style="font-family:宋体">的值为</span><span style="font-family:Times New Roman">4</span><span style="font-family:宋体">，如果</span><span style="font-family:Times New Roman">id=3 </span><span style="font-family:宋体">则 </span><span style="font-family:Times New Roman">display_order </span><span style="font-family:宋体">的值为</span><span style="font-family:Times New Roman">5</span><span style="font-family:宋体">。</span></p>&#13;\n<p>即是将条件语句写在了一起。</p>&#13;\n<p>这里的<span style="font-family:Times New Roman">where</span><span style="font-family:宋体">部分不影响代码的执行，但是会提高</span><span style="font-family:Times New Roman">sql</span><span style="font-family:宋体">执行的效率。确保</span><span style="font-family:Times New Roman">sql</span><span style="font-family:宋体">语句仅执行需要修改的行数，这里只有</span><span style="font-family:Times New Roman">3</span><span style="font-family:宋体">条数据进行更新，而</span><span style="font-family:Times New Roman">where</span><span style="font-family:宋体">子句确保只有</span><span style="font-family:Times New Roman">3</span><span style="font-family:宋体">行数据执行。</span></p>&#13;\n<p>如果更新多个值的话，只需要稍加修改：</p>&#13;\n<p><span style="color:rgb(0,0,255)">UPDATE categories </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    SET display_order = CASE id </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 1 THEN 3 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 2 THEN 4 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 3 THEN 5 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    END, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    title = CASE id </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 1 THEN 'New Title 1'</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 2 THEN 'New Title 2'</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">        WHEN 3 THEN 'New Title 3'</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    END</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">WHERE id IN (1,2,3)</span></p>&#13;\n<p>到这里，已经完成一条<span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">语句更新多条记录了。</span></p>&#13;\n<p>但是要在业务中运用，需要结合服务端语言，这里以<span style="font-family:Times New Roman">php</span><span style="font-family:宋体">为例，构造这条</span><span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">语句：</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">$display_order = array( </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    1 =&gt; 4, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    2 =&gt; 1, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    3 =&gt; 2, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    4 =&gt; 3, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    5 =&gt; 9, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    6 =&gt; 5, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    7 =&gt; 8, </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    8 =&gt; 9 </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">); </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">$ids = implode(',', array_keys($display_order)); </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">$sql = "UPDATE categories SET display_order = CASE id "; </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">foreach ($display_order as $id =&gt; $ordinal) { </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">    $sql .= sprintf("WHEN %d THEN %d ", $id, $ordinal); </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">} </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">$sql .= "END WHERE id IN ($ids)"; </span></p>&#13;\n<p><span style="color:rgb(0,0,255)">echo $sql;</span></p>&#13;\n<p>这个例子，有<span style="font-family:Times New Roman">8</span><span style="font-family:宋体">条记录进行更新。代码也很容易理解，你学会了吗</span></p>&#13;\n<h2>性能分析</h2>&#13;\n<p>当我使用上万条记录利用<span style="font-family:Times New Roman">mysql</span><span style="font-family:宋体">批量更新，发现使用最原始的批量</span><span style="font-family:Times New Roman">update</span><span style="font-family:宋体">发现性能很差，将网上看到的总结一下一共有以下三种办法：</span></p>&#13;\n<p>1.<span style="font-family:宋体">批量</span><span style="font-family:Times New Roman">update</span><span style="font-family:宋体">，一条记录</span><span style="font-family:Times New Roman">update</span><span style="font-family:宋体">一次，性能很差</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">update test_tbl set dr='2' where id=1;</span></p>&#13;\n<p>2.replace into <span style="font-family:宋体">或者</span><span style="font-family:Times New Roman">insert into ...on duplicate key update</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">replace into test_tbl (id,dr) values (1,'2'),(2,'3'),...(x,'y');</span></p>&#13;\n<p>或者使用</p>&#13;\n<p><span style="color:rgb(0,0,255)">insert into test_tbl (id,dr) values  (1,'2'),(2,'3'),...(x,'y') on duplicate key update dr=values(dr);</span></p>&#13;\n<p>3.<span style="font-family:宋体">创建临时表，先更新临时表，然后从临时表中</span><span style="font-family:Times New Roman">update</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">create temporary table tmp(id int(4) primary key,dr varchar(50));</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">insert into tmp values  (0,'gone'), (1,'xx'),...(m,'yy');</span></p>&#13;\n<p><span style="color:rgb(0,0,255)">update test_tbl, tmp set test_tbl.dr=tmp.dr where test_tbl.id=tmp.id;</span></p>&#13;\n<p>注意：这种方法需要用户有<span style="font-family:Times New Roman">temporary </span><span style="font-family:宋体">表的</span><span style="font-family:Times New Roman">create </span><span style="font-family:宋体">权限。</span></p>&#13;\n<p>下面是上述方法<span style="font-family:Times New Roman">update 100000</span><span style="font-family:宋体">条数据的性能测试结果：</span></p>&#13;\n<p>逐条<span style="font-family:Times New Roman">update</span></p>&#13;\n<p>real    0m15.557s</p>&#13;\n<p>user    0m1.684s</p>&#13;\n<p>sys    0m1.372s</p>&#13;\n<p>replace into</p>&#13;\n<p>real    0m1.394s</p>&#13;\n<p>user    0m0.060s</p>&#13;\n<p>sys    0m0.012s</p>&#13;\n<p>insert into on duplicate key update</p>&#13;\n<p>real    0m1.474s</p>&#13;\n<p>user    0m0.052s</p>&#13;\n<p>sys    0m0.008s</p>&#13;\n<p>create temporary table and update:</p>&#13;\n<p>real    0m0.643s</p>&#13;\n<p>user    0m0.064s</p>&#13;\n<p>sys    0m0.004s</p>&#13;\n<p>就测试结果来看，测试当时使用<span style="font-family:Times New Roman">replace into</span><span style="font-family:宋体">性能较好。</span></p>&#13;\n<p>replace into  <span style="font-family:宋体">和</span><span style="font-family:Times New Roman">insert into on duplicate key update</span><span style="font-family:宋体">的不同在于：</span></p>&#13;\n<p>replace into<span style="font-family:宋体">　操作本质是对重复的记录先</span><span style="font-family:Times New Roman">delete </span><span style="font-family:宋体">后</span><span style="font-family:Times New Roman">insert</span><span style="font-family:宋体">，如果更新的字段不全会将缺失的字段置为缺省值</span></p>&#13;\n<p>insert into <span style="font-family:宋体">则是只</span><span style="font-family:Times New Roman">update</span><span style="font-family:宋体">重复记录，不会改变其它字段。</span></p>&#13;\n<h2><span style="color:rgb(0,0,255)">QUESTION:</span></h2>&#13;\n<p>Error Code: 1175. You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column To disable safe mode, toggle the option in Preferences -&gt; SQL Queries and reconnect.</p>&#13;\n<h2><span style="color:rgb(0,0,255)">SOLVE:</span></h2>&#13;\n<p>原因是在<span style="font-family:Times New Roman">safe mode</span><span style="font-family:宋体">下</span><span style="font-family:Times New Roman">,</span><span style="font-family:宋体">要强制安全点</span><span style="font-family:Times New Roman">,update</span><span style="font-family:宋体">只能跟</span><span style="font-family:Times New Roman">where</span><span style="font-family:宋体">了</span><span style="font-family:Times New Roman">, </span><span style="font-family:宋体">要取消这个限制</span><span style="font-family:Times New Roman">,</span><span style="font-family:宋体">可以</span><span style="font-family:Times New Roman">:</span></p>&#13;\n<p>    SET SQL_SAFE_UPDATES=0;</p>&#13;\n &#13;\n
