\n\n<pre><a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/48346333">转载请注明出处:http://blog.csdn.net/l1028386804/article/details/48346333</a>\n</pre>&#13;\n<p>近期开发的系统中使用MySql作为数据库，由于数据涉及到Money，所以不得不慎重。同时，用户对最大访问量也提出了要求。为了避免Mysql成为性能瓶颈并具备很好的容错能力，特此实现主从热备和读写分离。在此简做纪要,以备日后所用！</p>&#13;\n<h3>一、配置主从</h3>&#13;\n<p>条件：两台PC，IP分别为192.168.168.253,192.168.168.251。两台PC上的Mysql版本为5.0。253上的Mysql为Master，251上的Mysql为Slave。</p>&#13;\n<p>1、主数据库服务器配置</p>&#13;\n<p>进入主数据库服务器安装目录,打开my.ini,在文件末尾增加如下配置：</p>&#13;\n<p></p>&#13;\n<pre name="code" class="sql">#数据库ID号， 为1时表示为Master,其中master_id必须为1到232–1之间的一个正整数值; \nserver-id = 1\n#启用二进制日志；\nlog-bin=mysql-bin\n#需要同步的二进制数据库名；\nbinlog-do-db=minishop\n#不同步的二进制数据库名,如果不设置可以将其注释掉;\nbinlog-ignore-db=information_schema\nbinlog-ignore-db=mysql\nbinlog-ignore-db=personalsite\nbinlog-ignore-db=test\n#设定生成的log文件名；\nlog-bin="D:/Database/materlog"\n#把更新的记录写到二进制文件中；\nlog-slave-updates</pre>保存文件。重启Mysql服务。&#13;\n<p></p>&#13;\n<p>进入从数据库服务器安装目录,打开my.ini,在文件末尾增加如下配置：</p>&#13;\n<pre name="code" class="sql">#如果需要增加Slave库则，此id往后顺延；\nserver-id = 2 \nlog-bin=mysql-bin\n#主库host\nmaster-host = 192.168.168.253\n#在主数据库服务器中建立的用于该从服务器备份使用的用户\nmaster-user = forslave\nmaster-password = ******\nmaster-port = 3306\n#如果发现主服务器断线，重新连接的时间差；\nmaster-connect-retry=60\n#不需要备份的数据库； \nreplicate-ignore-db=mysql\n#需要备份的数据库\nreplicate-do-db=minishop\nlog-slave-update\n</pre>保存文件。重启Mysql服务。&#13;\n<p>进入主数据库服务器，创建上面备份使用的用户名和密码，同时授权replication slave,super和reload</p>&#13;\n<pre name="code" class="sql">mysql&gt;grant replication slave,super,reload on minishop.* to forslave@192.168.168.251 identified by '******';</pre>进入从数据库服务器，启动Slave。<br />&#13;\n<pre name="code" class="sql">mysql&gt;slave start;\nmysql&gt;show slave status\\G;</pre>&#13;\n<p>测试：进入主数据库服务器，在Minishop中某张表中插入一条数据，然后到从数据库服务器中查看是否含有刚刚插入的数据。完毕！</p>&#13;\n<p>备注：1)运行配置后的主数据库服务器先于从数据库服务器，这样运行从数据库服务器时,主库的 File 和 Position 与 从库的上设置Master_Log_File、Read_Master_Log_Pos 就会一致。否则，可能出现不一致的情况。这也可以通过命令调整。</p>&#13;\n<p>2)如果发现主从复制失败时，可以先关闭从数据库服务器，然后删除从数据库服务器中data目录下relay-log.info,hosname-relay-bin*,master.info等文件，重启从服务器。</p>&#13;\n<h3>二、读写分离配置</h3>&#13;\n<p>本想采用Mysql Proxy来实现读写分离，奈何其使用的lua脚本着实让人头痛，最后决定采用国人开发的开源数据库代理中间件Amoeba。使用Amoeba，只需要简单的xml配置，就可以很容易地实现读写分离。</p>&#13;\n<p>Amoeba处于应用程序和数据库服务器之间，充当一个中间代理层。其支持负载均衡、高可用性、Query过滤、读写分离、可路由相关的query到目标数据库、可并发请求多台数据库合并结果。功能很强大。</p>&#13;\n<p>Amoeba默认的端口为8066，实现了Mysql协议。应用程序中只需要修改一个数据库连接就可以实现采用Amoeba来代理数据库访问。比如：java应用中，假如你原来的jdbc连接字符串为：jdbc:mysql://192.168.168.42:3306/minishop，那么现在，你想使用Amoeba作为数据库访问代理，则只需要将上面连接字符串改为如下(假如Amoeba所在机子IP为192.168.168.88)：jdbc:mysql://192.168.168.88:8066/minishop。Amoeba透明性做的很赞。</p>&#13;\n<p>主要还是配置Amoeda，但是配置也是相当的简单。基本只需要配置两个文件：conf\\dbServers.xml和conf\\amoeba.xml。配置中各项的含义，可以参考amoeda中文指南，这里不做过多解释。仅记录下配置。<br />&#13;\n</p>&#13;\n<p>dbServers.xml主要配置</p>&#13;\n<pre name="code" class="html">&lt;amoeba:dbServers xmlns:amoeba="http://amoeba.meidusa.com/"&gt;\n\n\t\t&lt;!-- \n\t\t\tEach dbServer needs to be configured into a Pool,\n\t\t\tIf you need to configure multiple dbServer with load balancing that can be simplified by the following configuration:\n\t\t\t add attribute with name virtual = "true" in dbServer, but the configuration does not allow the element with name factoryConfig\n\t\t\t such as 'multiPool' dbServer \n\t\t--&gt;\n\t\t\n\t&lt;dbServer name="abstractServer" abstractive="true"&gt;\n\t\t&lt;factoryConfig class="com.meidusa.amoeba.mysql.net.MysqlServerConnectionFactory"&gt;\n\t\t\t&lt;property name="manager"&gt;${defaultManager}&lt;/property&gt;\n\t\t\t&lt;property name="sendBufferSize"&gt;64&lt;/property&gt;\n\t\t\t&lt;property name="receiveBufferSize"&gt;128&lt;/property&gt;\n\t\t\t\t\n\t\t\t&lt;!-- mysql port --&gt;\n\t\t\t&lt;property name="port"&gt;3306&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- mysql schema --&gt;\n\t\t\t&lt;property name="schema"&gt;minishop&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- mysql user --&gt;\n\t\t\t&lt;property name="user"&gt;chenjie&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- mysql password --&gt;\n\t\t\t&lt;property name="password"&gt;chenjie&lt;/property&gt;\n\n\t\t&lt;/factoryConfig&gt;\n\n\t\t&lt;poolConfig class="com.meidusa.amoeba.net.poolable.PoolableObjectPool"&gt;\n\t\t\t&lt;property name="maxActive"&gt;500&lt;/property&gt;\n\t\t\t&lt;property name="maxIdle"&gt;500&lt;/property&gt;\n\t\t\t&lt;property name="minIdle"&gt;10&lt;/property&gt;\n\t\t\t&lt;property name="minEvictableIdleTimeMillis"&gt;600000&lt;/property&gt;\n\t\t\t&lt;property name="timeBetweenEvictionRunsMillis"&gt;600000&lt;/property&gt;\n\t\t\t&lt;property name="testOnBorrow"&gt;true&lt;/property&gt;\n\t\t\t&lt;property name="testWhileIdle"&gt;true&lt;/property&gt;\n\t\t&lt;/poolConfig&gt;\n\t&lt;/dbServer&gt;\n\n\t&lt;dbServer name="master" parent="abstractServer"&gt;\n\t\t&lt;factoryConfig&gt;\n\t\t\t&lt;!-- mysql ip --&gt;\n\t\t\t&lt;property name="ipAddress"&gt;192.168.168.253&lt;/property&gt;\n\t\t&lt;/factoryConfig&gt;\n\t&lt;/dbServer&gt;\n\n\t&lt;dbServer name="slave1" parent="abstractServer"&gt;\n\t\t&lt;factoryConfig&gt;\n\t\t\t&lt;!-- mysql ip --&gt;\n\t\t\t&lt;property name="ipAddress"&gt;192.168.168.119&lt;/property&gt;\n\t\t&lt;/factoryConfig&gt;\n\t&lt;/dbServer&gt;\n\n\t&lt;dbServer name="slave2" parent="abstractServer"&gt;\n\t\t&lt;factoryConfig&gt;\n\t\t\t&lt;!-- mysql ip --&gt;\n\t\t\t&lt;property name="ipAddress"&gt;192.168.168.251&lt;/property&gt;\n\n\t\t&lt;/factoryConfig&gt;\n\t&lt;/dbServer&gt;\n\t\n\t&lt;dbServer name="multiPool" virtual="true"&gt;\n\t\t&lt;poolConfig class="com.meidusa.amoeba.server.MultipleServerPool"&gt;\n\t\t\t&lt;!-- Load balancing strategy: 1=ROUNDROBIN , 2=WEIGHTBASED , 3=HA--&gt;\n\t\t\t&lt;property name="loadbalance"&gt;1&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- Separated by commas,such as: server1,server2,server1 --&gt;\n\t\t\t&lt;property name="poolNames"&gt;slave1,slave2&lt;/property&gt;\n\t\t&lt;/poolConfig&gt;\n\t&lt;/dbServer&gt;\n\t\t\n&lt;/amoeba:dbServers&gt;</pre>amoeba.xml配置：<br />&#13;\n<pre name="code" class="html">&lt;amoeba:configuration xmlns:amoeba="http://amoeba.meidusa.com/"&gt;\n\n\t&lt;proxy&gt;\n\t\n\t\t&lt;!-- service class must implements com.meidusa.amoeba.service.Service --&gt;\n\t\t&lt;service name="Amoeba for Mysql" class="com.meidusa.amoeba.net.ServerableConnectionManager"&gt;\n\t\t\t&lt;!-- port --&gt;\n\t\t\t&lt;property name="port"&gt;8066&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- bind ipAddress --&gt;\n\n\t\t\t&lt;property name="ipAddress"&gt;192.168.168.253&lt;/property&gt;\n\n\t\t\t\n\t\t\t&lt;property name="manager"&gt;${clientConnectioneManager}&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;property name="connectionFactory"&gt;\n\t\t\t\t&lt;bean class="com.meidusa.amoeba.mysql.net.MysqlClientConnectionFactory"&gt;\n\t\t\t\t\t&lt;property name="sendBufferSize"&gt;128&lt;/property&gt;\n\t\t\t\t\t&lt;property name="receiveBufferSize"&gt;64&lt;/property&gt;\n\t\t\t\t&lt;/bean&gt;\n\t\t\t&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;property name="authenticator"&gt;\n\t\t\t\t&lt;bean class="com.meidusa.amoeba.mysql.server.MysqlClientAuthenticator"&gt;\n\t\t\t\t\t\n\t\t\t\t\t&lt;property name="user"&gt;chenjie&lt;/property&gt;\n\t\t\t\t\t\n\t\t\t\t\t&lt;property name="password"&gt;chenjie&lt;/property&gt;\n\t\t\t\t\t\n\t\t\t\t\t&lt;property name="filter"&gt;\n\t\t\t\t\t\t&lt;bean class="com.meidusa.amoeba.server.IPAccessController"&gt;\n\t\t\t\t\t\t\t&lt;property name="ipFile"&gt;${amoeba.home}/conf/access_list.conf&lt;/property&gt;\n\t\t\t\t\t\t&lt;/bean&gt;\n\t\t\t\t\t&lt;/property&gt;\n\t\t\t\t&lt;/bean&gt;\n\t\t\t&lt;/property&gt;\n\t\t\t\n\t\t&lt;/service&gt;\n\t\t\n\t\t&lt;!-- server class must implements com.meidusa.amoeba.service.Service --&gt;\n\t\t&lt;service name="Amoeba Monitor Server" class="com.meidusa.amoeba.monitor.MonitorServer"&gt;\n\t\t\t&lt;!-- port --&gt;\n\t\t\t&lt;!-- default value: random number\n\t\t\t&lt;property name="port"&gt;9066&lt;/property&gt;\n\t\t\t--&gt;\n\t\t\t&lt;!-- bind ipAddress --&gt;\n\t\t\t&lt;property name="ipAddress"&gt;127.0.0.1&lt;/property&gt;\n\t\t\t&lt;property name="daemon"&gt;true&lt;/property&gt;\n\t\t\t&lt;property name="manager"&gt;${clientConnectioneManager}&lt;/property&gt;\n\t\t\t&lt;property name="connectionFactory"&gt;\n\t\t\t\t&lt;bean class="com.meidusa.amoeba.monitor.net.MonitorClientConnectionFactory"&gt;&lt;/bean&gt;\n\t\t\t&lt;/property&gt;\n\t\t\t\n\t\t&lt;/service&gt;\n\t\t\n\t\t&lt;runtime class="com.meidusa.amoeba.mysql.context.MysqlRuntimeContext"&gt;\n\t\t\t&lt;!-- proxy server net IO Read thread size --&gt;\n\t\t\t&lt;property name="readThreadPoolSize"&gt;20&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- proxy server client process thread size --&gt;\n\t\t\t&lt;property name="clientSideThreadPoolSize"&gt;30&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- mysql server data packet process thread size --&gt;\n\t\t\t&lt;property name="serverSideThreadPoolSize"&gt;30&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- per connection cache prepared statement size --&gt;\n\t\t\t&lt;property name="statementCacheSize"&gt;500&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- query timeout( default: 60 second , TimeUnit:second) --&gt;\n\t\t\t&lt;property name="queryTimeout"&gt;60&lt;/property&gt;\n\t\t&lt;/runtime&gt;\n\t\t\n\t&lt;/proxy&gt;\n\t\n\t&lt;!-- \n\t\tEach ConnectionManager will start as thread\n\t\tmanager responsible for the Connection IO read , Death Detection\n\t--&gt;\n\t&lt;connectionManagerList&gt;\n\t\t&lt;connectionManager name="clientConnectioneManager" class="com.meidusa.amoeba.net.MultiConnectionManagerWrapper"&gt;\n\t\t\t&lt;property name="subManagerClassName"&gt;com.meidusa.amoeba.net.ConnectionManager&lt;/property&gt;\n\t\t\t&lt;!-- \n\t\t\t default value is avaliable Processors \n\t\t\t&lt;property name="processors"&gt;5&lt;/property&gt;\n\t\t\t --&gt;\n\t\t&lt;/connectionManager&gt;\n\t\t&lt;connectionManager name="defaultManager" class="com.meidusa.amoeba.net.MultiConnectionManagerWrapper"&gt;\n\t\t\t&lt;property name="subManagerClassName"&gt;com.meidusa.amoeba.net.AuthingableConnectionManager&lt;/property&gt;\n\t\t\t\n\t\t\t&lt;!-- \n\t\t\t default value is avaliable Processors \n\t\t\t&lt;property name="processors"&gt;5&lt;/property&gt;\n\t\t\t --&gt;\n\t\t&lt;/connectionManager&gt;\n\t&lt;/connectionManagerList&gt;\n\t\n\t\t&lt;!-- default using file loader --&gt;\n\t&lt;dbServerLoader class="com.meidusa.amoeba.context.DBServerConfigFileLoader"&gt;\n\t\t&lt;property name="configFile"&gt;${amoeba.home}/conf/dbServers.xml&lt;/property&gt;\n\t&lt;/dbServerLoader&gt;\n\t\n\t&lt;queryRouter class="com.meidusa.amoeba.mysql.parser.MysqlQueryRouter"&gt;\n\t\t&lt;property name="ruleLoader"&gt;\n\t\t\t&lt;bean class="com.meidusa.amoeba.route.TableRuleFileLoader"&gt;\n\t\t\t\t&lt;property name="ruleFile"&gt;${amoeba.home}/conf/rule.xml&lt;/property&gt;\n\t\t\t\t&lt;property name="functionFile"&gt;${amoeba.home}/conf/ruleFunctionMap.xml&lt;/property&gt;\n\t\t\t&lt;/bean&gt;\n\t\t&lt;/property&gt;\n\t\t&lt;property name="sqlFunctionFile"&gt;${amoeba.home}/conf/functionMap.xml&lt;/property&gt;\n\t\t&lt;property name="LRUMapSize"&gt;1500&lt;/property&gt;\n\n\t\t&lt;property name="defaultPool"&gt;master&lt;/property&gt;\n\t\t\n\n\t\t&lt;property name="writePool"&gt;master&lt;/property&gt;\n\t\t&lt;property name="readPool"&gt;multiPool&lt;/property&gt;\n\n\t\t&lt;property name="needParse"&gt;true&lt;/property&gt;\n\t&lt;/queryRouter&gt;\n&lt;/amoeba:configuration&gt;</pre>至此，Mysql主从热备和读写分离配置完毕。但是，具体应用到生产环境究竟如何，还有待测试和考察。后来测试一主多从，又加入了一台Mysql从数据库服务器，这就是为什么上面amoeba配置中多了一个IP为119的原因。<br />&#13;\n &#13;\n
