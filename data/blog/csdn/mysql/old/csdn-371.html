\n\n<p><a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/52810936">转载请注明出处：http://blog.csdn.net/l1028386804/article/details/52810936</a><br />&#13;\n</p>&#13;\n<p>今天，我们继续MySQL的话题，今天为大家带来一篇基于Amoeba实现MySQL读写分离的方案文章，好我们直接进入今天的正题吧。</p>&#13;\n<h2>一、服务器规划</h2>&#13;\n<p>&#13;\n</p><table width="200" cellspacing="1" cellpadding="1" border="1">&#13;\n<tbody>&#13;\n<tr>&#13;\n<td>主机名</td>&#13;\n<td>IP地址</td>&#13;\n<td>节点</td>&#13;\n</tr>&#13;\n<tr>&#13;\n<td>liuyazhuang152</td>&#13;\n<td>192.168.0.152</td>&#13;\n<td>amoeba</td>&#13;\n</tr>&#13;\n<tr>&#13;\n<td>liuyazhuang153</td>&#13;\n<td>192.168.0.153</td>&#13;\n<td>写库</td>&#13;\n</tr>&#13;\n<tr>&#13;\n<td>liuyazhuang154</td>&#13;\n<td>192.168.0.154</td>&#13;\n<td>读库</td>&#13;\n</tr>&#13;\n</tbody>&#13;\n</table>&#13;\n&#13;\n<h2>二、测试方案</h2>&#13;\n<p>我们在192.168.0.152上安装amoeba，在192.168.0.153和192.168.0.154上安装mysql，这两台mysql服务器无任何交集，通过配置amoeba，将192.168.0.153上的mysql配置成写库，将192.168.0.154上的MySQL配置成读库；我们客户端连接到amoeba，由amoeba操作数据库，我们通过amoeba向相应数据库中写入数据，通过查询：192.168.0.153服务器MySQL中有插入的相关数据，192.168.0.154上的MySQL服务器则没有；那么，我们就认为amoeba帮我们的程序完成了读写分离功能；</p>&#13;\n<h2>三、安装MySQL</h2>&#13;\n<p>请参见博文《<a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/52181103">MySQL之——CentOS6.5 编译安装MySQL5.6.16</a>》<br />&#13;\n</p>&#13;\n<h2>四、安装并配置Amoeba</h2>&#13;\n<h3>1、下载Amoeba<br />&#13;\n</h3>&#13;\n<p>我们可以到<a target="_blank" href="https://sourceforge.net/projects/amoeba/">https://sourceforge.net/projects/amoeba/</a>下载Amoeba,我这里下载的是amoeba-mysql-binary-2.2.0.tar.gz<br />&#13;\n</p>&#13;\n<h3>2、安装Amoeba</h3>&#13;\n<p>Amoeba是Java写的，所以，需要我们的服务器配置java运行环境，这里我就不讲如何配置Java运行环境了，大家可以参考博文《<a target="_blank" href="http://blog.csdn.net/l1028386804/article/details/45704569">Linux CentOS下搭建JAVA运行环境</a>》</p>&#13;\n<p>由于Amoeba解压后直接没有文件了，所以我们要提前建立好文件夹，我这里在/usr/local下建立文件夹：amoeba-mysql-binary-2.2.0</p>&#13;\n<p>然后在命令行输入如下命令</p>&#13;\n<pre code_snippet_id="1928172" snippet_file_name="blog_20161014_1_2263936" name="code" class="plain">tar -zxvf amoeba-mysql-binary-2.2.0.tar.gz -C /usr/local/amoeba-mysql-binary-2.2.0</pre><br />&#13;\n将Amoeba解压到/usr/local/amoeba-mysql-binary-2.2.0 目录下，此时，我们完成了安装。&#13;\n<p></p>&#13;\n<h3>3、配置Amoeba</h3>&#13;\n<p>我们到Amoeba的conf目录下可以看到如下配置文件：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013230954821?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p>这里我们重点关注amoeba.xml和dbServers.xml文件。</p>&#13;\n<h4>3.1配置amoeba.xml<br />&#13;\n</h4>&#13;\n<p>我们打开amoeba.xml文件，找到如下代码：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013231455171?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>我们配置好用户名和密码，其中8066是Amoeba默认端口，配置好的效果如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013231618727?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p><br />&#13;\n</p>&#13;\n<p>找到如下代码：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013232115742?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p>将注释去掉，效果如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013232203962?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>这就配置好了amoeba文件，当我们配置好后，我们访问mysql时，需要访问amoeba.xml文件中配置的端口和用户名、密码，通过Amoeba来链接MySQL。</p>&#13;\n<h4>3.2配置dbServers.xml<br />&#13;\n</h4>&#13;\n<p>在dbServers.xml文件中找到如下代码：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013232345621?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p>我们在这里进行相关数据库的配置，要注意：这些数据库的配置指定要读写分离的数据库、用户名、密码，其中用户名和密码是配置成在终端访问Amoeba的用户名和密码。我修改后的效果如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013232610797?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p>此时的用户名和密码需要MySQL服务器授权给Amoeba服务器，使其能够登录到MySQL服务器。<br />&#13;\n</p>&#13;\n<p><br />&#13;\n</p>&#13;\n<p>然后我们找到如下代码：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013232800049?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>将其修改为两台MySQL服务器所在的IP地址，如下图：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013232901280?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>至此，我们配置好了基于Amoeba的读写分离。</p>&#13;\n<p></p>&#13;\n<h3>4、在MySQL中为Amoeba访问授权</h3>&#13;\n<p></p>&#13;\n<p>分别登陆两台MySQL服务器，执行以下命令为Amoeba授权</p>&#13;\n<pre code_snippet_id="1928172" snippet_file_name="blog_20161014_2_2852581" name="code" class="sql"> grant all on lyz.* to lyz@192.168.0.152 identified by 'lyz';</pre>其中这里的用户名和密码是我们在dbServers.xml文件中配置的用户名和密码。此时完成了MySQL的授权<br />&#13;\n<br />&#13;\n<h3>5、运行Amoeba<br />&#13;\n</h3>&#13;\n<p>我们进入到Amoeba的bin目录在命令行输入如下命令运行Amoeba</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="1928172" snippet_file_name="blog_20161014_4_1314654" name="code" class="plain">./amoeba start &amp;</pre>其中，&amp;代表在后台运行，此时我们发现启动失败：信息如下：&#13;\n<p></p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013233208172?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>这个是说配置的Java stack太小了，最少要228K，此时我们打开bin目录下的amoeba脚本文件，找到如下代码：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013233353407?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p>将上图的128K改为256K(你可以根据你的实际情况修改)，如下图：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013233451012?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>此时我们重新输入命令 </p>&#13;\n<pre code_snippet_id="1928172" snippet_file_name="blog_20161014_4_1314654" name="code" class="plain">./amoeba start &amp;</pre><img src="http://img.blog.csdn.net/20161013233623283?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n启动成功&#13;\n<p></p>&#13;\n<h3>6、测试</h3>&#13;\n<h4>6.1 查询数据</h4>&#13;\n<p>我们先分别查询MySQL数据库表上的相关数据，未通过Amoeba操作数据库的时候，我们是新建的数据库lyz和表t1,此时192.168.0.153和192.168.0.154上MySQL数据表都应该为空，如下图：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013234511584?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013234603600?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<h4>6.2登录Amoeba</h4>&#13;\n<p>我们在192.168.0.152上输入如下命令登录Amoeba，通过Amoeba访问数据库</p>&#13;\n<p></p>&#13;\n<pre code_snippet_id="1928172" snippet_file_name="blog_20161014_5_4237613" name="code" class="plain">mysql -h192.168.0.152 -uroot -proot -P 8066</pre>注意：我们这里输入的端口是8066，此端口是Amoeba配置的端口，我们需要登录Amoeba而不是直接登录MySQL&#13;\n<p></p>&#13;\n<p>登录成功如下图所示：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013234957304?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<h4>6.3测试<br />&#13;\n</h4>&#13;\n<p>  此时我们在终端查询数据表数据，显示为空，如下图：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013235145301?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>我们在Amoeba服务器终端插入一条数据，如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013235312099?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>同时，我们在Amoeba上查询数据如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013235414025?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>数据为空。</p>&#13;\n<p>我们登录192.168.0.153数据库，查看表数据如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013235519869?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</p>&#13;\n<p>如图，说明Amoeba向192.168.0.153库插入了数据。</p>&#13;\n<p>我们在登录192.168.0.154数据库查看数据信息，如下：</p>&#13;\n<p><img src="http://img.blog.csdn.net/20161013235648416?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /></p>&#13;\n<p>说明Amoeba没有向192.168.0.154库插入数据，并从192.168.0.154库读取数据。</p>&#13;\n<p>至此，基于Amoeba实现MySQL读写分离全部配置完成。</p>&#13;\n<h2>五、附录<br />&#13;\n</h2>&#13;\n<p></p>&#13;\n<pre code_snippet_id="1928172" snippet_file_name="blog_20161014_6_8871655" name="code" class="plain">./amoeba start &amp; 启动amoeba\n./amoeba stop 关闭amoeba</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n &#13;\n
