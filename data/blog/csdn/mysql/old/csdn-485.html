\n <div class="markdown_views"><h1 id="mysql学习笔记自定义函数">MySQL学习笔记—自定义函数</h1>\n\n<hr />\n\n\n\n<h3 id="注释语法">注释语法：</h3>\n\n<p>MySQL服务器支持3种注释风格：</p>\n\n<ul>\n<li><p>从‘#’字符从行尾。</p></li>\n<li><p>从‘– ’序列到行尾。请注意‘– ’(双破折号)注释风格要求第2个破折号后面至少跟一个空格符(例如空格、tab、换行符等等)。该语法与标准SQL注释语法稍有不同。</p></li>\n<li><p>从/<em>序列到后面的</em>/序列。结束序列不一定在同一行中，因此该语法允许注释跨越多行。</p></li>\n</ul>\n\n<p>下面的例子显示了3种风格的注释：</p>\n\n<pre class="prettyprint"><code class="language-mysql hljs vbnet">mysql&gt; <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+<span class="hljs-number">1</span>; <span class="hljs-preprocessor"># This comment continues to the <span class="hljs-keyword">end</span> of line</span>\nmysql&gt; <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+<span class="hljs-number">1</span>; -- This comment continues <span class="hljs-keyword">to</span> the <span class="hljs-keyword">end</span> <span class="hljs-keyword">of</span> line\nmysql&gt; <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> /appex /bin /boot /dev /etc /home /initrd.img /lib /lib64 /lost+found /media /mnt /opt /proc /root /run /sbin /serverspeeder /srv /sys /tmp /usr /var /vmlinuz this <span class="hljs-keyword">is</span> an <span class="hljs-keyword">in</span>-line comment */ + <span class="hljs-number">1</span>;\nmysql&gt; <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+\n/*\nthis <span class="hljs-keyword">is</span> a\nmultiple-line comment\n*/\n<span class="hljs-number">1</span>;</code></pre>\n\n<hr />\n\n\n\n<h3 id="自定义用户变量">自定义用户变量:</h3>\n\n<ul>\n<li><p>可以先在用户变量中保存值然后在以后引用它；这样可以将值从一个语句传递到另一个语句。用户变量与连接有关。也就是说，一个客户端定义的变量不能被其它客户端看到或使用。当客户端退出时，该客户端连接的所有变量将自动释放。</p></li>\n<li><p>用户变量的形式为@var_name，其中变量名var_name可以由当前字符集的文字数字字符、‘.’、‘_’和‘$’组成。 默认字符集是cp1252 (Latin1)。可以用mysqld的–default-character-set选项更改字符集。用户变量名对大小写不敏感。 <br />\n设置用户变量的一个途径是执行SET语句：</p></li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs r">SET @var_name = expr [, @var_name = expr] <span class="hljs-keyword">...</span></code></pre>\n\n<p>对于SET，可以使用=或:=作为分配符。分配给每个变量的expr可以为整数、实数、字符串或者NULL值。</p>\n\n<p>也可以用语句select代替SET来为用户变量分配一个值。在这种情况下，分配符必须为:=而不能用=，因为在非SET语句中=被视为一个比较 操作符：</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs ruby">mysql&gt; <span class="hljs-constant">SET</span> <span class="hljs-variable">@t1</span>=<span class="hljs-number">0</span>, <span class="hljs-variable">@t2</span>=<span class="hljs-number">0</span>, <span class="hljs-variable">@t3</span>=<span class="hljs-number">0</span>;\nmysql&gt; <span class="hljs-constant">SELECT</span> <span class="hljs-variable">@t1</span><span class="hljs-symbol">:</span>=(<span class="hljs-variable">@t2</span><span class="hljs-symbol">:</span>=<span class="hljs-number">1</span>)+<span class="hljs-variable">@t3</span><span class="hljs-symbol">:</span>=<span class="hljs-number">4</span>,<span class="hljs-variable">@t1</span>,<span class="hljs-variable">@t2</span>,<span class="hljs-variable">@t3</span>;</code></pre>\n\n<hr />\n\n<h3 id="自定义函数基本方式">自定义函数基本方式</h3>\n\n<ul>\n<li><p>1.自定义函数 <br />\n用户自定义函数(user-defined function, UDF)是一种对MySQL扩展的途径, 其用法与内置函数相同。 <br />\n自定义函数的两个必要条件:</p>\n\n<ul><li>a.参数</li>\n<li>b.返回值</li></ul>\n\n<p>函数可以返回任意类型的值,同样可以接受这些类型的参数； <br />\n函数的参数与返回值之间，没有必然的联系。</p></li>\n<li><p>2.创建自定义函数 <br />\nCREATE FUNCTION function_name ([func_parameter[,…]]) <br />\nRETURNS {STRING|INTEGER|REAL|DECIMAL|…} <br />\nroutine_body - 函数体</p>\n\n<p>默认地，子程序与当前数据库关联。要明确地把子程序与一个给定数据库关联起来，可以在创建子程序的时候指定其名字为db_name.function_name。 <br />\n如果子程序名和内建的SQL函数名一样，定义子程序时，你需要在这个名字和随后括号中间插入一个空格，否则发生语法错误。当你随后调用子程序的时候也要插入。 <br />\nRETURNS字句只能对FUNCTION做指定，对函数而言这是强制的。它用来指定函数的返回类型，而且函数体必须包含一个RETURN value语句</p></li>\n<li><p>3.关于函数体</p>\n\n<ul><li>函数体由合法的SQL语法构成;</li>\n<li>函数体可以是简单的SELECT或INSERT语句;</li>\n<li>函数体如果为复合结构则使用BEGIN…END语句；</li>\n<li>复合结构可以包括声明，循环，控制结构。</li></ul></li>\n</ul>\n\n<hr />\n\n\n\n<h4 id="例子">例子</h4>\n\n<ul>\n<li>创建一个不带参数的自定义函数： <br />\n该函数将系统的时间按照设定的格式返回</li>\n</ul>\n\n<pre class="prettyprint"><code class="language-mysql hljs php">CREATE <span class="hljs-function"><span class="hljs-keyword">FUNCTION</span> <span class="hljs-title">myTime</span><span class="hljs-params">()</span>\n<span class="hljs-title">RETURNS</span> <span class="hljs-title">VARCHAR</span><span class="hljs-params">(<span class="hljs-number">30</span>)</span>\n<span class="hljs-title">RETURN</span> <span class="hljs-title">DATE_FORMAT</span><span class="hljs-params">(NOW<span class="hljs-params">()</span>,<span class="hljs-string">'%Y年%m月%d日 %H点%i分%s秒'</span>)</span>;</span></code></pre>\n\n<ul>\n<li>创建一个带有参数的自定义函数： <br />\n该函数可计算两个传入参数的平均值</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs sql"><span class="hljs-operator"><span class="hljs-keyword">CREATE</span> FUNCTION <span class="hljs-aggregate">avg</span>(num1 <span class="hljs-keyword">SMALLINT</span> UNSIGNED ,num2 <span class="hljs-keyword">SMALLINT</span> UNSIGNED)\nRETURNS <span class="hljs-keyword">FLOAT</span>(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>) \nRETURN (num1+num2)/<span class="hljs-number">2</span>;</span></code></pre>\n\n<hr />\n\n<h3 id="begin-end复合语句">BEGIN … END复合语句</h3>\n\n<p>BEGIN … END复合语句格式：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs css"><span class="hljs-attr_selector">[begin_label:]</span> <span class="hljs-tag">BEGIN</span>\n <span class="hljs-attr_selector">[statement_list]</span>\n<span class="hljs-tag">END</span> <span class="hljs-attr_selector">[end_label]</span></code></pre>\n\n<p>存储子程序可以使用BEGIN … END复合语句来包含多个语句。statement_list 代表一个或多个语句的列表。statement_list之内每个语句都必须用分号（;）来结尾。 </p>\n\n<p>复合语句可以被标记。除非begin_label存在,否则end_label不能被给出,并且如果二者都存在,他们必须是同样的。 </p>\n\n<p>使用多重语句需要客户端能发送包含语句定界符;的查询字符串。这个符号在命令行客户端被用delimiter命令来处理。改变查询结尾定界符 “ ;” （比如改变为“//”）使得; 可被用在子程序体中。 <br />\n例如在mysql中执行以下命令：</p>\n\n<pre class="prettyprint"><code class=" hljs cs">delimiter <span class="hljs-comment">//</span></code></pre>\n\n<p>则以后命令结尾的符号就变成 “ // ”而不是“ ；”</p>\n\n<p>以下例子创建了一个函数，用于向tb1表中插入数据（数据包括username，age），并返回age最大的那一条数据：</p>\n\n<ul>\n<li>先执行：</li>\n</ul>\n\n<pre class="prettyprint"><code class="language-mysql hljs cs">delimiter <span class="hljs-comment">//</span></code></pre>\n\n<ul>\n<li>再输入函数：</li>\n</ul>\n\n<pre class="prettyprint"><code class="language-mysql hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addUser</span><span class="hljs-params">(username varchar(20)</span>,<span class="hljs-title">age</span> <span class="hljs-title">tinyint</span><span class="hljs-params">(3)</span> <span class="hljs-title">unsigned</span>)\n<span class="hljs-title">returns</span> <span class="hljs-title">tinyint</span><span class="hljs-params">(3)</span> <span class="hljs-title">unsigned</span>\n<span class="hljs-title">begin</span>\n<span class="hljs-title">insert</span> <span class="hljs-title">tb1</span><span class="hljs-params">(username,age)</span> <span class="hljs-title">values</span><span class="hljs-params">(username,age)</span>;</span>\nreturn (<span class="hljs-keyword">select</span> max(age) <span class="hljs-keyword">from</span> tb1);\n<span class="hljs-keyword">end</span> <span class="hljs-comment">//</span></code></pre>\n\n<ul>\n<li>改回结尾定界符：</li>\n</ul>\n\n<pre class="prettyprint"><code class="language-mysql hljs ">delimiter ;</code></pre>\n\n<ul>\n<li>执行函数：</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs sql"><span class="hljs-operator"><span class="hljs-keyword">select</span> addUser(<span class="hljs-string">'chenjs'</span>,<span class="hljs-number">20</span>);</span></code></pre>\n\n<hr />\n\n\n\n<h3 id="删除函数的语句">删除函数的语句</h3>\n\n<p>删除函数的语句</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs php">drop <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">function_name</span>;</span></code></pre>\n\n<p>此处只需写上函数名即可，函数的参数可以不用写出来。 <br />\n例如删除上面创建的函数 addUser(username varchar(20),age tinyint(3) unsigned)，可以直接用以下语句删除：</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs php">drop <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addUser</span>;</span></code></pre>\n\n<hr />\n\n\n\n<h2 id="流控制构造">流控制构造</h2>\n\n<hr />\n\n\n\n<h4 id="if语句">IF语句</h4>\n\n<pre class="prettyprint"><code class="language-mysql hljs r">IF search_condition THEN statement_list\n [ELSEIF search_condition THEN statement_list] <span class="hljs-keyword">...</span>\n [ELSE statement_list]\nEND IF</code></pre>\n\n<p>IF实现了一个基本的条件构造。如果search_condition求值为真，相应的SQL语句列表被执行。如果没有search_condition匹配，在ELSE子句里的语句列表被执行。statement_list可以包括一个或多个语句。 <br />\n 请注意，也有一个IF() 函数，它不同于这里描述的IF语句： <br />\nIF(expr1,expr2,expr3) <br />\n如果 expr1 是TRUE (expr1 不等于 0 且 expr1 不等于 NULL)，则 IF()的返回值为expr2; 否则返回值则为 expr3。IF() 的返回值为数字值或字符串值，具体情况视其所在语境而定。 <br />\n例如： <br />\n<img src="http://img.blog.csdn.net/20160414204202871" alt="这里写图片描述" title="" /></p>\n\n<p>返回2，并将2赋给变量@m。</p>\n\n<hr />\n\n\n\n<h4 id="case语句">CASE语句</h4>\n\n<p>CASE语句</p>\n\n<pre class="prettyprint"><code class="language-mysql hljs r">CASE case_value\n WHEN when_value THEN statement_list\n [WHEN when_value THEN statement_list] <span class="hljs-keyword">...</span>\n [ELSE statement_list]\nEND CASE</code></pre>\n\n<p>或: </p>\n\n<pre class="prettyprint"><code class="language-mysql hljs r">CASE\n WHEN search_condition THEN statement_list\n [WHEN search_condition THEN statement_list] <span class="hljs-keyword">...</span>\n [ELSE statement_list]\nEND CASE</code></pre>\n\n<p>存储程序的CASE语句实现一个复杂的条件构造。如果search_condition 求值为真，相应的SQL被执行。如果没有搜索条件匹配，在ELSE子句里的语句被执行。</p>\n\n<ul>\n<li>例子 <br />\n该例子根据传入一个表示函数名称的字符串与一个待处理的数字，对出入的数字执行不同的操作（在此之前已将结尾定界符改为”//”）</li>\n</ul>\n\n<pre class="prettyprint"><code class="language-mysql hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">caseTest</span><span class="hljs-params">(str varchar(5)</span>,<span class="hljs-title">num</span> <span class="hljs-title">int</span>)\n<span class="hljs-title">returns</span> <span class="hljs-title">int</span> \n<span class="hljs-title">begin</span> \n<span class="hljs-title">case</span> <span class="hljs-title">str</span>\n<span class="hljs-title">when</span> '<span class="hljs-title">power</span>' <span class="hljs-title">then</span> <span class="hljs-title">set</span> @<span class="hljs-title">result</span>=<span class="hljs-title">power</span><span class="hljs-params">(num,2)</span>;</span>\nwhen <span class="hljs-string">'ceil'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">set</span> @<span class="hljs-keyword">result</span>=ceil(num);\nwhen <span class="hljs-string">'floor'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">set</span> @<span class="hljs-keyword">result</span>=floor(num);\nwhen <span class="hljs-string">'round'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">set</span> @<span class="hljs-keyword">result</span>=round(num);\n<span class="hljs-keyword">else</span> <span class="hljs-keyword">set</span> @<span class="hljs-keyword">result</span>=<span class="hljs-number">0</span>;\n<span class="hljs-keyword">end</span> <span class="hljs-keyword">case</span>;\nreturn (<span class="hljs-keyword">select</span> @<span class="hljs-keyword">result</span>);\n<span class="hljs-keyword">end</span> <span class="hljs-comment">//</span></code></pre>\n\n<p>测试截图如下： <br />\n <img src="http://img.blog.csdn.net/20160414211938250" alt="这里写图片描述" title="" /></p>\n\n<hr />\n\n<h4 id="loop语句">LOOP语句</h4>\n\n<p>LOOP语句格式</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs vbnet">[begin_label:] <span class="hljs-keyword">LOOP</span>\n statement_list\n<span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span> [end_label]</code></pre>\n\n<p>LOOP允许某特定语句或语句群的重复执行，实现一个简单的循环构造。在循环内的语句一直重复直到循环被退出，退出通常伴随着一个LEAVE 语句。</p>\n\n<p>LOOP语句可以被标注。除非begin_label存在，否则end_label不能被给出，并且如果两者都出现，它们必须是同样的。 </p>\n\n<ul>\n<li>LEAVE语句 <br />\n格式</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class=" hljs ruleslanguage"><span class="hljs-keyword">LEAVE</span> label</code></pre>\n\n<p>这个语句被用来退出任何被标注的流程控制构造。它和BEGIN … END或循环一起被使用。</p>\n\n<ul>\n<li>ITERATE语句 <br />\n格式</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class=" hljs vhdl">ITERATE <span class="hljs-keyword">label</span></code></pre>\n\n<p>ITERATE只可以出现在LOOP, REPEAT, 和WHILE语句内。ITERATE意思为：“再次循环。” </p>\n\n<p>例如，其创建方式使用的是create procedure而不是create function，这是因为procedure不需要returns 与return字段，而function必须有returns与return字段：</p>\n\n<pre class="prettyprint"><code class="language-mysql hljs oxygene"><span class="hljs-keyword">CREATE</span> <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title">doiterate</span><span class="hljs-params">(p1 INT)</span>\n<span class="hljs-title">BEGIN</span>\n <span class="hljs-title">label1</span>:</span> <span class="hljs-keyword">LOOP</span>\n <span class="hljs-keyword">SET</span> p1 = p1 + <span class="hljs-number">1</span>;\n <span class="hljs-keyword">IF</span> p1 &lt; <span class="hljs-number">10</span> <span class="hljs-keyword">THEN</span> ITERATE label1; \n <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;\n LEAVE label1;\n <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span> label1;\n <span class="hljs-keyword">SET</span> @x = p1;\n<span class="hljs-keyword">END</span></code></pre>\n\n<hr />\n\n<h4 id="repeat语句">REPEAT语句</h4>\n\n<p>REPEAT语句格式</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs delphi">[begin_label:] <span class="hljs-keyword">REPEAT</span>\n statement_list\n<span class="hljs-keyword">UNTIL</span> search_condition\n<span class="hljs-keyword">END</span> <span class="hljs-keyword">REPEAT</span> [end_label]</code></pre>\n\n<p>REPEAT语句内的语句或语句群被重复，直至search_condition 为真。</p>\n\n<p>REPEAT 语句可以被标注。 除非begin_label也存在，end_label才能被用，如果两者都存在，它们必须是一样的。</p>\n\n<p>使用repeat来实现上面的程序，程序如下：</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs lua">create <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doRepeat</span><span class="hljs-params">(p1 int)</span></span>\nreturns int\nbegin\n <span class="hljs-keyword">repeat</span> set p1 = p1 + <span class="hljs-number">1</span>;\n <span class="hljs-keyword">until</span> p1&gt;<span class="hljs-number">10</span> \n <span class="hljs-keyword">end</span> <span class="hljs-keyword">repeat</span>;\n<span class="hljs-keyword">return</span> p1;\n<span class="hljs-keyword">end</span></code></pre>\n\n<p>测试截图: <br />\n<img src="http://img.blog.csdn.net/20160414213901884" alt="这里写图片描述" title="" /></p>\n\n<hr />\n\n<h4 id="while语句">WHILE语句</h4>\n\n<p>WHILE语句格式</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs vbnet">[begin_label:] <span class="hljs-keyword">WHILE</span> search_condition <span class="hljs-keyword">DO</span>\n statement_list\n<span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span> [end_label]</code></pre>\n\n<p>WHILE语句内的语句或语句群被重复，直至search_condition 为真。</p>\n\n<p>WHILE语句可以被标注。 除非begin_label也存在，end_label才能被用，如果两者都存在，它们必须是一样的。</p>\n\n<p>例子：</p>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs oxygene"><span class="hljs-keyword">CREATE</span> <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title">dowhile</span><span class="hljs-params">()</span>\n<span class="hljs-title">BEGIN</span>\n <span class="hljs-title">DECLARE</span> <span class="hljs-title">v1</span> <span class="hljs-title">INT</span> <span class="hljs-title">DEFAULT</span> 5;</span>\n\n <span class="hljs-keyword">WHILE</span> v1 &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">DO</span>\n <span class="hljs-keyword">SET</span> v1 = v1 - <span class="hljs-number">1</span>;\n <span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span>;\n<span class="hljs-keyword">END</span></code></pre>\n\n<ul>\n<li>DECLARE仅被用在BEGIN … END复合语句里，并且必须在复合语句的开头，在任何其它语句之前。用于声明一个局部变量，该变量在函数外不可访问，如果想要访问必须将数值返回，此时应该用create function而不可以用create procedure，因为只有create function才可以有返回值，函数更改如下：</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class="language-mysql hljs vbnet">CREATE <span class="hljs-keyword">function</span> dowhile()\nRETURNS int\nBEGIN\n <span class="hljs-keyword">DECLARE</span> v1 INT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>;\n\n <span class="hljs-keyword">WHILE</span> v1 &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">DO</span>\n <span class="hljs-keyword">SET</span> v1 = v1 - <span class="hljs-number">1</span>;\n <span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span>;\n<span class="hljs-keyword">RETURN</span> v1;\n<span class="hljs-keyword">END</span></code></pre></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
