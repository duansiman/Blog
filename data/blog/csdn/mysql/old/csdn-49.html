\n <div class="markdown_views"><p>自定义函数：</p>\n\n<blockquote>\n <p>用户自定义函数（user-defined function，UDF）是一种对MySQL扩展的途经，其用法与内置函数相同。</p>\n</blockquote>\n\n<p>自定义函数有两个必要条件： <br />\n1. 参数 <br />\n2. 返回值</p>\n\n<p>函数可以返回任意类型的值，同样可以接收这些类型的参数。</p>\n\n<p>函数的参数和返回值之间没有必然的内在的联系。</p>\n\n<p>示例1： <br />\n创建一个无参数的函数，返回当前时间的，年月日 时分秒。 <br />\n例如：</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> NOW();</span>\n+<span class="hljs-comment">---------------------+</span>\n| NOW() |\n+<span class="hljs-comment">---------------------+</span>\n| 2016-09-08 21:17:17 |\n+<span class="hljs-comment">---------------------+</span>\n1 row in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)\n\nmysql&gt; <span class="hljs-keyword">SELECT</span> DATE_FORMAT(NOW(),<span class="hljs-string">'%Y年%m月%d日 %H点:%i分:%s秒'</span>);</span>\n+<span class="hljs-comment">--------------------------------------------------+</span>\n| DATE_FORMAT(NOW(),'%Y年%m月%d日 %H点:%i分:%s秒') |\n+<span class="hljs-comment">--------------------------------------------------+</span>\n| 2016年09月08日 21点:19分:54秒 |\n+<span class="hljs-comment">--------------------------------------------------+</span>\n1 row in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.01</span> sec)\n</span></code></pre>\n\n<p>对上述过程经行封装：</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">CREATE</span> FUNCTION f1() RETURNS <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">30</span>)\n -&gt; RETURN DATE_FORMAT(NOW(),<span class="hljs-string">'%Y年%m月%d日 %H点:%i分:%s秒'</span>);</span>\nQuery OK, 0 rows affected (0.08 sec)\n\nmysql&gt; <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> f1();</span>\n+<span class="hljs-comment">-------------------------------+</span>\n| f1() |\n+<span class="hljs-comment">-------------------------------+</span>\n| 2016年09月08日 21点:21分:25秒 |\n+<span class="hljs-comment">-------------------------------+</span>\n1 row in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.02</span> sec)</span></code></pre>\n\n<p>注：returns后面的为返回值类型，return后面的为返回值。</p>\n\n<p>示例2： <br />\n创建有参数的函数，例如求两个数的平均值。</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">CREATE</span> FUNCTION f2(num1 <span class="hljs-keyword">SMALLINT</span> UNSIGNED, num2 <span class="hljs-keyword">SMALLINT</span> UNSIGNED)\n -&gt; RETURNS <span class="hljs-keyword">FLOAT</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) UNSIGNED\n -&gt; RETURN (num1+num2)/<span class="hljs-number">2</span>;</span>\nQuery OK, 0 rows affected (0.00 sec)</code></pre>\n\n<p>调用：</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> f2(<span class="hljs-number">4</span>,<span class="hljs-number">6</span>);</span>\n+<span class="hljs-comment">---------+</span>\n| f2(4,6) |\n+<span class="hljs-comment">---------+</span>\n| 5.00 |\n+<span class="hljs-comment">---------+</span>\n1 row in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.02</span> sec)</span></code></pre>\n\n<p>如果要删除上面所创建的两个自定义函数：</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">DROP</span> FUNCTION f2;</span>\nQuery OK, 0 rows affected (0.11 sec)\n\nmysql&gt; <span class="hljs-operator"><span class="hljs-keyword">DROP</span> FUNCTION f1;</span>\nQuery OK, 0 rows affected (0.00 sec)</code></pre>\n\n<p>创建具有复合结构函数体的自定义函数</p>\n\n<p>例如：创建一个函数向表中插入数据，并返回所插入数据的id。</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; DESC tdb_test;\n+<span class="hljs-comment">------------+------------------+------+-----+---------+----------------+</span>\n| Field | Type | Null | Key | Default | Extra |\n+<span class="hljs-comment">------------+------------------+------+-----+---------+----------------+</span>\n| id | int(10) unsigned | NO | PRI | NULL | auto_increment |\n| first_name | varchar(20) | NO | | NULL | |\n| last_name | varchar(20) | NO | | NULL | |\n+<span class="hljs-comment">------------+------------------+------+-----+---------+----------------+</span>\n3 rows in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)\n\nmysql&gt; <span class="hljs-keyword">CREATE</span> FUNCTION adduser(first_name <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">20</span>),last_name <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">20</span>))\n -&gt; RETURNS <span class="hljs-keyword">INT</span> UNSIGNED\n -&gt; RETURN\n -&gt; <span class="hljs-keyword">INSERT</span> tdb_test(first_name,last_name) <span class="hljs-keyword">VALUES</span>(first_name,last_name);</span>\nERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'tdb_test(first_name,last_name) VALUES(first_name,last_name)' at line 4</code></pre>\n\n<p>这时我们发现，在输入要执行的sql语句后，后面的分号为当前默认的分隔符，导致函数无法再继续输入。因此需要修改默认的分隔符。</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; DELIMITER //</code></pre>\n\n<p>意思是用//结束</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">CREATE</span> FUNCTION adduser(first_name <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">20</span>),last_name <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">20</span>))\n -&gt; RETURNS <span class="hljs-keyword">INT</span> UNSIGNED\n -&gt; RETURN\n -&gt; <span class="hljs-keyword">INSERT</span> tdb_test(first_name,last_name) <span class="hljs-keyword">VALUES</span>(first_name,last_name);</span>\n -&gt; LAST_INSERT_ID();\n -&gt; //\nERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'tdb_test(first_name,last_name) VALUES(first_name,last_name);\nLAST_INSERT_ID()' at line 4</code></pre>\n\n<p>同样返回错误，因为，返回有两个语句要执行，需放入begin和end构成一个聚合体，下面来看正确的做法。</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">CREATE</span> FUNCTION adduser(first_name <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">20</span>),last_name <span class="hljs-keyword">VARCHAR</span>(<span class="hljs-number">20</span>))\n -&gt; RETURNS <span class="hljs-keyword">INT</span> UNSIGNED\n -&gt; <span class="hljs-keyword">BEGIN</span>\n -&gt; <span class="hljs-keyword">INSERT</span> tdb_test(first_name,last_name) <span class="hljs-keyword">VALUES</span>(first_name,last_name);</span>\n -&gt; RETURN LAST_INSERT_ID();\n -&gt; <span class="hljs-operator"><span class="hljs-keyword">END</span>\n -&gt; //\nQuery OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)</span></code></pre>\n\n<p>再将分隔符改回来</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; DELIMITER ;</code></pre>\n\n<p>测试结果如下：</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs ">mysql&gt; <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> adduser(<span class="hljs-string">"ttt"</span>,<span class="hljs-string">"ddd"</span>);</span>\n+<span class="hljs-comment">----------------------+</span>\n| adduser("ttt","ddd") |\n+<span class="hljs-comment">----------------------+</span>\n| 5 |\n+<span class="hljs-comment">----------------------+</span>\n1 row in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.11</span> sec)\n\nmysql&gt; <span class="hljs-keyword">SELECT</span> csdn-10.html csdn-11.html csdn-12.html csdn-13.html csdn-14.html csdn-15.html csdn-16.html csdn-17.html csdn-18.html csdn-19.html csdn-1.html csdn-20.html csdn-21.html csdn-22.html csdn-23.html csdn-24.html csdn-25.html csdn-26.html csdn-27.html csdn-28.html csdn-29.html csdn-2.html csdn-30.html csdn-31.html csdn-32.html csdn-33.html csdn-34.html csdn-35.html csdn-36.html csdn-37.html csdn-38.html csdn-39.html csdn-3.html csdn-40.html csdn-41.html csdn-42.html csdn-43.html csdn-44.html csdn-45.html csdn-46.html csdn-47.html csdn-48.html csdn-4.html csdn-5.html csdn-6.html csdn-7.html csdn-8.html csdn-9.html mysql.sh <span class="hljs-keyword">FROM</span> tdb_test;</span>\n+<span class="hljs-comment">----+------------+-----------+</span>\n| id | first_name | last_name |\n+<span class="hljs-comment">----+------------+-----------+</span>\n| 1 | A | B |\n| 2 | Jack | Bob |\n| 3 | tom% | 123 |\n| 4 | 11 | 22 |\n| 5 | ttt | ddd |\n+<span class="hljs-comment">----+------------+-----------+</span>\n5 rows in <span class="hljs-operator"><span class="hljs-keyword">set</span> (<span class="hljs-number">0.00</span> sec)\n</span></code></pre>\n\n<p>关于函数体</p>\n\n<ul>\n<li>函数体由合法的sql语句构成；</li>\n<li>函数体可以是简单的SELECT或INSERT语句；</li>\n<li>函数体如果为复合结构则使用BEGIN…END语句；</li>\n<li>复合结构可以包含声明，循环，控制结构；</li>\n</ul>\n\n<p>删除函数：</p>\n\n\n\n<pre class="prettyprint"><code class="language-sql hljs "><span class="hljs-operator"><span class="hljs-keyword">DROP</span> FUNCTION [<span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span>] function_name</span></code></pre></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
