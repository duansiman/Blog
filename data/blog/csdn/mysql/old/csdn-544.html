\n <div class="markdown_views"><h3 id="dbcp数据库连接池">DBCP数据库连接池</h3>\n\n<ul>\n<li><p>DBCP 是 Apache 软件基金组织下的开源连接池实现，使用DBCP数据源，应用程序应在系统中增加如下两个 jar 文件： <br />\nCommons-dbcp.jar：连接池的实现 Commons-pool.jar：连接池实现的依赖库 Tomcat <br />\n的连接池正是采用该连接池来实现的。该数据库连接池既可以与应用服务器整合使用，也可由应用程序独立使用。</p></li>\n<li><p>核心代码</p></li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class=" hljs fsharp"><span class="hljs-keyword">static</span>{\n InputStream <span class="hljs-keyword">in</span> = JdbcUtil.<span class="hljs-keyword">class</span>.getClassLoader().\n getResourceAsStream(<span class="hljs-string">"dbcpconfig.properties"</span>);\n Properties prop = <span class="hljs-keyword">new</span> Properties();\n prop.load(<span class="hljs-keyword">in</span>);\n\n BasicDataSourceFactory factory = <span class="hljs-keyword">new</span> BasicDataSourceFactory();\n dataSource = factory.createDataSource(prop);\n}\n</code></pre>\n\n<ul>\n<li>我的代码示例</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">package dpcpPoolUse<span class="hljs-comment">;</span>\n\nimport java<span class="hljs-preprocessor">.sql</span><span class="hljs-preprocessor">.Connection</span><span class="hljs-comment">;</span>\nimport java<span class="hljs-preprocessor">.sql</span><span class="hljs-preprocessor">.SQLException</span><span class="hljs-comment">;</span>\nimport java<span class="hljs-preprocessor">.util</span><span class="hljs-preprocessor">.Properties</span><span class="hljs-comment">;</span>\n\nimport javax<span class="hljs-preprocessor">.sql</span><span class="hljs-preprocessor">.DataSource</span><span class="hljs-comment">;</span>\n\nimport org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.commons</span><span class="hljs-preprocessor">.dbcp</span><span class="hljs-preprocessor">.BasicDataSource</span><span class="hljs-comment">;</span>\nimport org<span class="hljs-preprocessor">.apache</span><span class="hljs-preprocessor">.commons</span><span class="hljs-preprocessor">.dbcp</span><span class="hljs-preprocessor">.BasicDataSourceFactory</span><span class="hljs-comment">;</span>\nimport org<span class="hljs-preprocessor">.junit</span><span class="hljs-preprocessor">.Test</span><span class="hljs-comment">;</span>\n\npublic class DbcpPoolDemo {\n\n @Test\n public void testDbcp() throws SQLException, InterruptedException{\n // DataSource pool=new BasicDataSource()<span class="hljs-comment">;//不能用DataSource，因为里面没有set。。函数</span>\n BasicDataSource pool=new BasicDataSource()<span class="hljs-comment">;//创建一个池对象</span>\n pool<span class="hljs-preprocessor">.setDriverClassName</span>(<span class="hljs-string">"com.mysql.jdbc.Driver"</span>)<span class="hljs-comment">;</span>\n pool<span class="hljs-preprocessor">.setUrl</span>(<span class="hljs-string">"jdbc:mysql://127.0.0.1:3306/sstud?useUnicode=true&amp;characterEncoding=utf-8"</span>)<span class="hljs-comment">;</span>\n pool<span class="hljs-preprocessor">.setUsername</span>(<span class="hljs-string">"root"</span>)<span class="hljs-comment">;</span>\n pool<span class="hljs-preprocessor">.setPassword</span>(<span class="hljs-string">"1234"</span>)<span class="hljs-comment">;</span>\n\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(pool<span class="hljs-preprocessor">.getDefaultCatalog</span>())<span class="hljs-comment">;//获取默认参数</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(pool<span class="hljs-preprocessor">.getInitialSize</span>())<span class="hljs-comment">;//获取连接池初始化大小</span>\n // System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(pool<span class="hljs-preprocessor">.getLoginTimeout</span>())<span class="hljs-comment">;//登录限制时间</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(pool<span class="hljs-preprocessor">.getMaxWait</span>())<span class="hljs-comment">;//pool最长等待时间（-1）</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(pool<span class="hljs-preprocessor">.getMaxIdle</span>())<span class="hljs-comment">;////最大空闲时间。如果一个用户获取一个连接，不用，多长时间会被强行收回</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(pool<span class="hljs-preprocessor">.getMaxActive</span>())<span class="hljs-comment">;//pool最多获得数</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(<span class="hljs-string">"__________________"</span>)<span class="hljs-comment">;</span>\n //自己设置参数\n // pool<span class="hljs-preprocessor">.setMaxWait</span>(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>\n // pool<span class="hljs-preprocessor">.setMaxIdle</span>(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>\n pool<span class="hljs-preprocessor">.setMaxActive</span>(<span class="hljs-number">20</span>)<span class="hljs-comment">;</span>\n for(int i=<span class="hljs-number">0</span><span class="hljs-comment">;i&lt;20;i++){</span>\n // Thread<span class="hljs-preprocessor">.sleep</span>(<span class="hljs-number">1100</span>)<span class="hljs-comment">;</span>\n Connection con=pool<span class="hljs-preprocessor">.getConnection</span>()<span class="hljs-comment">;//优先拿到刚刚使用过得</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(i+<span class="hljs-string">":::::::::::"</span>+con<span class="hljs-preprocessor">.hashCode</span>())<span class="hljs-comment">;</span>\n // con<span class="hljs-preprocessor">.close</span>()<span class="hljs-comment">;</span>\n }\n }\n //通过配置文件 读取\n @Test\n public void testPropertyFile() throws Exception{\n Properties p=new Properties()<span class="hljs-comment">;</span>\n // p<span class="hljs-preprocessor">.load</span>(ClassLoader<span class="hljs-preprocessor">.getSystemClassLoader</span>()<span class="hljs-preprocessor">.getSystemResourceAsStream</span>(<span class="hljs-string">"dpcp.properities"</span>))<span class="hljs-comment">;//配置文件要放在src(bin)的根目录---classpath的根</span>\n p<span class="hljs-preprocessor">.load</span>(DbcpPoolDemo<span class="hljs-preprocessor">.class</span><span class="hljs-preprocessor">.getResourceAsStream</span>(<span class="hljs-string">"dbcp.properities"</span>))<span class="hljs-comment">;//配置文件和当前类的class放在一起</span>\n DataSource pool=BasicDataSourceFactory<span class="hljs-preprocessor">.createDataSource</span>(p)<span class="hljs-comment">;//DataSource要通过配置文件读取</span>\n //DataSource 不能进行常规设置\n //从它的池中获取连接(<span class="hljs-number">8</span>个)\n for(int i=<span class="hljs-number">0</span><span class="hljs-comment">;i&lt;10;i++){</span>\n Connection con=pool<span class="hljs-preprocessor">.getConnection</span>()<span class="hljs-comment">;</span>\n System<span class="hljs-preprocessor">.out</span><span class="hljs-preprocessor">.println</span>(i+<span class="hljs-string">":::::"</span>+con<span class="hljs-preprocessor">.hashCode</span>())<span class="hljs-comment">;</span>\n if((i&amp;<span class="hljs-number">1</span>)==<span class="hljs-number">0</span>){\n con<span class="hljs-preprocessor">.close</span>()<span class="hljs-comment">;</span>\n }\n }\n }\n}</code></pre>\n\n<ul>\n<li>连接池DbcpUtil工具</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class=" hljs cs">package dpcpPoolUse;\n\nimport java.io.IOException;\nimport java.sql.Connection;\nimport java.sql.SQLException;\nimport java.util.Properties;\n\nimport javax.sql.DataSource;\n\nimport org.apache.commons.dbcp.BasicDataSourceFactory;\n\n<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> DbcpUtil {\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource pool=<span class="hljs-keyword">null</span>;\n<span class="hljs-comment">// static BasicDataSource pool=new BasicDataSource();//创建一个池对象</span>\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; tl=<span class="hljs-keyword">new</span> ThreadLocal&lt;Connection&gt;();\n <span class="hljs-keyword">static</span>{\n Properties p=<span class="hljs-keyword">new</span> Properties();\n <span class="hljs-keyword">try</span> { \n<span class="hljs-comment">// pool.setDriverClassName("com.mysql.jdbc.Driver");</span>\n<span class="hljs-comment">// pool.setUrl("jdbc:mysql://127.0.0.1:3306/sstud?useUnicode=true&amp;characterEncoding=utf-8");</span>\n<span class="hljs-comment">// pool.setUsername("root");</span>\n<span class="hljs-comment">// pool.setPassword("1234");</span>\n Class.forName(<span class="hljs-string">"com.mysql.jdbc.Driver"</span>);<span class="hljs-comment">//需要自己写</span>\n p.load(DbcpPoolDemo.class.getResourceAsStream(<span class="hljs-string">"dbcp.properities"</span>));<span class="hljs-comment">//配置文件和当前类的class放在一起</span>\n System.<span class="hljs-keyword">out</span>.println(p);\n pool=BasicDataSourceFactory.createDataSource(p);\n } <span class="hljs-keyword">catch</span> (Exception e) {\n e.printStackTrace();\n }\n }\n <span class="hljs-comment">//返回DataSource--池</span>\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title">getDataSource</span>(){\n <span class="hljs-keyword">return</span> pool;\n }\n\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; <span class="hljs-title">getTl</span>() {\n <span class="hljs-keyword">return</span> tl;\n }\n\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTl</span>(Object <span class="hljs-keyword">object</span>) {\n DbcpUtil.tl = (ThreadLocal&lt;Connection&gt;) <span class="hljs-keyword">object</span>;\n }\n\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getCon</span>(){\n Connection con=tl.<span class="hljs-keyword">get</span>();\n <span class="hljs-keyword">if</span>(con==<span class="hljs-keyword">null</span>){\n <span class="hljs-keyword">try</span> {\n con=pool.getConnection();\n } <span class="hljs-keyword">catch</span> (SQLException e) {\n e.printStackTrace();\n }\n tl.<span class="hljs-keyword">set</span>(con);\n }\n <span class="hljs-keyword">return</span> con;\n }\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(String[] args) {\n System.<span class="hljs-keyword">out</span>.println(getCon());\n }\n\n}</code></pre>\n\n<hr />\n\n\n\n<h3 id="c3p0数据库连接池">C3P0数据库连接池</h3>\n\n<p><font color="#ff0000">注意： c3p0拿到的连接因为每次增删改都会调用con.close()方法，所有每次拿到的是不同连接</font></p>\n\n<ul>\n<li>C3P0是一个开源的JDBC连接池，它实现了数据源和JNDI绑定，支持JDBC3规范和JDBC2的标准扩展。目前使用它的开源项目有Hibernate，Spring等。</li>\n<li><p>和DPCP的区别： <br />\n 1）.dbcp没有自动回收空闲连接的功能 <br />\n 2）.c3p0有自动回收空闲连接功能</p></li>\n<li><p>C3p0需要的包和文件：c3p0-0.9.1.2.jar，没有更新 <br />\n 配置文件c3p0-config.xml</p></li>\n</ul>\n\n<p>c3p0-config.xml</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">c3p0-config</span>&gt;</span>\n <span class="hljs-comment">&lt;!-- 默认配置，如果没有指定则使用这个配置 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">default-config</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"driverClass"</span>&gt;</span>com.mysql.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"jdbcUrl"</span>&gt;</span>\n <span class="hljs-cdata">&lt;![CDATA[jdbc:mysql://127.0.0.1:3306/mydb?useUnicode=true&amp;characterEncoding=UTF-8]]&gt;</span>\n <span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"user"</span>&gt;</span>root<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"password"</span>&gt;</span>1234<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-comment">&lt;!-- 初始化池大小 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"initialPoolSize"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-comment">&lt;!-- 最大空闲时间 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"maxIdleTime"</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-comment">&lt;!-- 最多有多少个连接 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"maxPoolSize"</span>&gt;</span>10<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-comment">&lt;!-- 最少几个连接 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"minPoolSize"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-comment">&lt;!-- 每次最多可以执行多少个批处理语句 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"maxStatements"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;/<span class="hljs-title">default-config</span>&gt;</span> \n <span class="hljs-comment">&lt;!-- 命名的配置 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">named-config</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"hncu"</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"driverClass"</span>&gt;</span>com.mysql.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"jdbcUrl"</span>&gt;</span>jdbc:mysql://127.0.0.1:3306/mydb<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"user"</span>&gt;</span>root<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"password"</span>&gt;</span>1234<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"acquireIncrement"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span><span class="hljs-comment">&lt;!-- 如果池中数据连接不够时一次增长多少个 --&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"initialPoolSize"</span>&gt;</span>100<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"minPoolSize"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"maxPoolSize"</span>&gt;</span>1000<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"maxStatements"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span>\n <span class="hljs-tag">&lt;<span class="hljs-title">property</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"maxStatementsPerConnection"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-title">property</span>&gt;</span> <span class="hljs-comment">&lt;!-- he's important, but there's only one of him --&gt;</span>\n <span class="hljs-tag">&lt;/<span class="hljs-title">named-config</span>&gt;</span>\n<span class="hljs-tag">&lt;/<span class="hljs-title">c3p0-config</span>&gt;</span> \n</code></pre>\n\n<p>C3p0主要是通过配置文件来读取妻子的数据，很多框架都支持，很好用 <br />\n下面我来演示如何操作 <br />\n1.纯Java方式操作</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs java"><span class="hljs-annotation">@Test</span><span class="hljs-comment">//纯Java方法使用c3p0</span>\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">c3p0Test</span>() <span class="hljs-keyword">throws</span> SQLException, PropertyVetoException{\n ComboPooledDataSource pool=<span class="hljs-keyword">new</span> ComboPooledDataSource();<span class="hljs-comment">//空参数如果classpath下没有c3p0-config.xml配置文件需要自己设置,</span>\n pool.setUser(<span class="hljs-string">"root"</span>);\n pool.setDriverClass(<span class="hljs-string">"com.mysql.jdbc.Driver"</span>);\n pool.setPassword(<span class="hljs-string">"1234"</span>);\n pool.setJdbcUrl(<span class="hljs-string">"jdbc:mysql://127.0.0.1:3306/sstud?useUnicode=true&amp;characterEncoding=utf-8"</span>);\n <span class="hljs-comment">//设置属性可以在此调用pool.setters()方法对pool进行定制 </span>\n<span class="hljs-comment">// pool.setMaxPoolSize(20);//默认是15个，现在设置20个大小</span>\n pool.setAcquireIncrement(<span class="hljs-number">5</span>);<span class="hljs-comment">//连接池中的连接耗尽的时候c3p0一次同时获取的连接数</span>\n\n <span class="hljs-comment">//跟dbcp不同之处，连接关闭之后，内存会被释放，下次取时会重新开(内存地址不共用)</span>\n <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++){\n Connection con=pool.getConnection();<span class="hljs-comment">//不会像dbcp一样优先使用最近的连接</span>\n System.out.println(i+<span class="hljs-string">":"</span>+con.hashCode());<span class="hljs-comment">//原理和dbcp一样</span>\n <span class="hljs-keyword">if</span>((i&amp;<span class="hljs-number">2</span>)==<span class="hljs-number">1</span>){\n con.close();\n }\n }\n }</code></pre>\n\n<p>2.利用配置文件来读取 <br />\n <font color="#ff0000">注意： c3p0-config.xml配置文件需要放在项目根目录下</font></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs cs">@Test<span class="hljs-comment">//采用配置文件的方式使用c3p0</span>\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">C3p0PropertyDemo</span>() throws SQLException, PropertyVetoException{\n<span class="hljs-comment">// ComboPooledDataSource pool=new ComboPooledDataSource();</span>\n <span class="hljs-comment">//空参，自动到classpath目录下面加载“c3p0-config.xml”配置文件---配置文件的存储位置和名称必须是这样，且使用“默认配置”</span>\n <span class="hljs-comment">//加载“c3p0-config.xml”文件中定义的“hncu”这个配置元素</span>\n ComboPooledDataSource pool=<span class="hljs-keyword">new</span> ComboPooledDataSource(<span class="hljs-string">"hncu"</span>);\n System.<span class="hljs-keyword">out</span>.println(pool.getAcquireIncrement());\n <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;<span class="hljs-number">200</span>; i++) {\n Connection con = pool.getConnection();\n System.<span class="hljs-keyword">out</span>.println(i+<span class="hljs-string">":"</span>+con);\n <span class="hljs-keyword">if</span>((i%<span class="hljs-number">2</span>)==<span class="hljs-number">0</span>){\n con.close();\n }\n }\n }</code></pre>\n\n<ul>\n<li>下面是我做的c3p0Util数据库连接池（加工了）， <br />\n注意：如果是同一个客户端操作，连接关闭后要把THreadLocal设置为null也就是 tl.set(null)，这样下个客户端就拿不到你的连接了</li>\n</ul>\n\n\n\n<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> c3p0PoolUse;\n\n<span class="hljs-keyword">import</span> java.sql.Connection;\n<span class="hljs-keyword">import</span> java.sql.SQLException;\n\n<span class="hljs-keyword">import</span> javax.sql.DataSource;\n\n<span class="hljs-keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;\n\n<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C3p0Pool</span> {</span>\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource pool=<span class="hljs-keyword">new</span> ComboPooledDataSource();<span class="hljs-comment">//读取配置文件</span>\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; tl=<span class="hljs-keyword">new</span> ThreadLocal&lt;Connection&gt;();\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getCon</span>() <span class="hljs-keyword">throws</span> SQLException{\n Connection con =tl.get();\n <span class="hljs-keyword">if</span>(con==<span class="hljs-keyword">null</span>){\n con=pool.getConnection();\n tl.set(con);\n }\n <span class="hljs-keyword">return</span> con;\n }\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title">getPool</span>() {\n <span class="hljs-keyword">return</span> pool;\n }\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; <span class="hljs-title">getTl</span>() {\n <span class="hljs-keyword">return</span> tl;\n }\n\n}\n</code></pre>\n\n<p>C3p0Pool最终版</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> cn.hncu.c3p0;\n\n<span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;\n<span class="hljs-keyword">import</span> java.lang.reflect.Method;\n<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;\n<span class="hljs-keyword">import</span> java.sql.Connection;\n<span class="hljs-keyword">import</span> java.sql.SQLException;\n\n<span class="hljs-keyword">import</span> javax.sql.DataSource;\n\n\n<span class="hljs-keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;\n<span class="hljs-comment">//我们的这个包装，只是为了把c3p0池做成让每个线程(客户端)获得的是同一个连接，方便做b/s框架下的事务</span>\n<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C3p0Pool</span> {</span>\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource pool;\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;Connection&gt; t = <span class="hljs-keyword">new</span> ThreadLocal&lt;Connection&gt;();\n <span class="hljs-keyword">static</span>{\n pool = <span class="hljs-keyword">new</span> ComboPooledDataSource();\n\n }\n\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title">getDataSource</span>(){\n <span class="hljs-keyword">return</span> pool;\n }\n <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection conn=<span class="hljs-keyword">null</span>;\n <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getConnection</span>() <span class="hljs-keyword">throws</span> SQLException{\n conn = t.get();\n Connection conn2=<span class="hljs-keyword">null</span>;\n <span class="hljs-keyword">if</span>(conn==<span class="hljs-keyword">null</span>){\n conn = pool.getConnection();\n Object obj=Proxy.newProxyInstance(C3p0Pool.class.getClassLoader(), \n <span class="hljs-keyword">new</span> Class[]{Connection.class},<span class="hljs-keyword">new</span> InvocationHandler() {\n <span class="hljs-comment">//proxy是代理后的对象(等价于返回的obj), method就是类反射中的方法对象, args是执行method方法所需的参数</span>\n <span class="hljs-annotation">@Override</span>\n <span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span>(Object proxy, Method method, Object[] args)\n <span class="hljs-keyword">throws</span> Throwable {\n\n <span class="hljs-keyword">if</span>(method.getName().equalsIgnoreCase(<span class="hljs-string">"close"</span>)&amp;&amp;(args==<span class="hljs-keyword">null</span>||args.length==<span class="hljs-number">0</span>)){\n System.out.println(<span class="hljs-string">"一次close方法"</span>);\n t.set(conn);\n <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;\n }\n <span class="hljs-keyword">return</span> method.invoke(conn, args);<span class="hljs-comment">//其他方法就行放行</span>\n }\n });\n conn2=(Connection) obj;<span class="hljs-comment">//必须用两个不同对象</span>\n <span class="hljs-keyword">return</span> conn2;\n }<span class="hljs-keyword">else</span>{\n <span class="hljs-keyword">return</span> conn;\n }\n }\n\n}\n</code></pre></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
