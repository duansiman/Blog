\n <div class="markdown_views"><blockquote>\n <p>高可用性H.A.（High Availability）指的是通过尽量缩短因日常维护操作（计划）和突发的系统崩溃（非计划）所导致的停机时间，以提高系统和应用的可用性。它与被认为是不间断操作的容错技术有所不同。HA系统是目前企业防止核心计算机系统因故障停机的最有效手段。</p>\n</blockquote>\n\n<p><em>使用正常可用时间和全年时间百分比来表示高可用</em></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs perl"><span class="hljs-number">99999</span> （<span class="hljs-number">365</span><span class="hljs-variable">*24</span><span class="hljs-variable">*60</span>）<span class="hljs-variable">*（</span><span class="hljs-number">1</span>-<span class="hljs-number">0</span>.<span class="hljs-number">99999</span>） = <span class="hljs-number">5.256</span>分钟</code></pre>\n\n<ul>\n<li>严重的主从延迟</li>\n<li>主从复制中断</li>\n<li>锁引起的大量阻塞</li>\n<li>软硬件故障，服务器宕机</li>\n</ul>\n\n<p><strong>成本和高可用性呈正相关，结合业务和成本来考虑</strong> <br />\n<img src="http://img.blog.csdn.net/20170615094907064?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615095015034?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615095326226?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615095533541?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h2 id="单点故障的解决">单点故障的解决</h2>\n\n<p><img src="http://img.blog.csdn.net/20170615095617683?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>IDC机房</li>\n<li>网卡……</li>\n</ul>\n\n<p><img src="http://img.blog.csdn.net/20170615095753500?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="方法1共享存储">方法1：共享存储</h3>\n\n<ul>\n<li>缺点：共享存储本身就是一个单点，随机IO性能不理想</li>\n<li>优点：避免除存储外其他组件</li>\n</ul>\n\n\n\n<h3 id="方法2drdb磁盘推荐">方法2：DRDB磁盘（推荐）</h3>\n\n<p><img src="http://img.blog.csdn.net/20170615100044204?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>优：数据冗余</li>\n<li>缺：故障转移所需时间比较长，备用服务器不能提供服务（包括读），成本高。磁盘文件损坏，主备文件都会损坏</li>\n</ul>\n\n<p><img src="http://img.blog.csdn.net/20170615100357116?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615100415788?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>多写集群性能取决于最差的机器</li>\n<li>多写集群mysql写入性能肯定比单台性能差</li>\n<li>第二种比较完美，但是如果内存不足，NDB集群的性能就会非常差（很少使用到生产环境中）</li>\n</ul>\n\n<p><img src="http://img.blog.csdn.net/20170615100750121?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h4 id="面临的问题主服务器的单点问题">面临的问题：主服务器的单点问题</h4>\n\n<p><img src="http://img.blog.csdn.net/20170615100856474?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h2 id="mmm架构">MMM架构</h2>\n\n<p><img src="http://img.blog.csdn.net/20170615215358286?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /> <br />\n<strong>通过监控服务器MMM和各个服务器上的监控代理软件交互来完成监控和数据库迁移的</strong></p>\n\n<blockquote>\n <p>MMM（Master-Master replication manager for MySQL）是一套支持双主故障切换和双主日常管理的脚本程序。MMM使用Perl语言开发，主要用来监控和管理MySQL Master-Master（双主）复制。 <br />\n 虽然叫做双主复制，但是业务上同一时刻只允许对一个主进行写入，另一台备选主上提供部分读服务，以加速在主主切换时刻备选主的预热，可以说MMM这套脚本程序一方面实现了故障切换的功能，另一方面其内部附加的工具脚本也可以实现多个slave的read负载均衡。 <br />\n <strong>可以看上一篇我写的文章：主备模式的主主复制</strong></p>\n</blockquote>\n\n<p><img src="http://img.blog.csdn.net/20170615213916044?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<blockquote>\n <p>MMM提供了自动和手动两种方式移除一组服务器中复制延迟较高的服务器的虚拟ip，同时它还可以备份数据，实现两节点之间的数据同步等。由于MMM无法完全的保证数据一致性，所以MMM适用于对数据的一致性要求不是很高，但是又想最大程度的保证业务可用性的场景。对于那些对数据的一致性要求很高的业务，非常不建议采用MMM这种高可用架构。</p>\n</blockquote>\n\n\n\n<h3 id="mmm功能">MMM功能</h3>\n\n<p><img src="http://img.blog.csdn.net/20170615215105636?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /> <br />\n - MMM简单的找到主库的当前日志点，然后使所有的从库日志点和该日志点同步。如果在一个繁忙的系统中，很有可能对数据造成丢失的情况 <br />\n - 写虚拟IP只能在两个主服务器之间切换，读虚拟IP可以在任意服务器之间切换</p>\n\n\n\n<h3 id="mmm部署所需资源">MMM部署所需资源</h3>\n\n<p><img src="http://img.blog.csdn.net/20170615215632910?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>两个主服务器配置要尽量相同，否则会引起性能问题 <br />\n<ul><li>查看MySQL服务器配置信息 mysql&gt; show variables;</li>\n<li>查看MySQL服务器运行的各种状态值 mysql&gt; show global status;</li>\n<li>server_id肯定不一样</li></ul></li>\n<li>从服务器分担负载，但是不能太多（出现的问题会越来越大）</li>\n<li>监控服务器监控主从复制情况和复制链路情。当出现宕机或者主从延迟大于某个阈值时,虚拟IP切换。</li>\n<li>一个监控服务器可以监控多个服务器集群，最好使用独立的服务器资源</li>\n<li>每一个数据库服务器上都会有两个IP：服务器物理IP，读需IP.主服务器需要一个写需IP</li>\n</ul>\n\n\n\n<h3 id="mmm部署步骤">MMM部署步骤</h3>\n\n<p><img src="http://img.blog.csdn.net/20170615221621032?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h4 id="mmm演示拓扑图">MMM演示拓扑图</h4>\n\n<p><img src="http://img.blog.csdn.net/20170615221757659?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="mmm演示">MMM演示</h3>\n\n\n\n<h4 id="建立复制账号">建立复制账号</h4>\n\n<p><img src="http://img.blog.csdn.net/20170615222052804?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h4 id="主库备份复制到备主服务器和从服务器100">主库备份（复制到备主服务器和从服务器）100</h4>\n\n<p><img src="http://img.blog.csdn.net/20170615222141548?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="主主同步复制两个主都需要复制">主主同步复制（两个主都需要复制）</h3>\n\n\n\n<h4 id="备主服务器数据复制101">备主服务器数据复制101</h4>\n\n\n\n<pre class="prettyprint"><code class=" hljs lasso">导入数据库，mysql <span class="hljs-attribute">-uroot</span> <span class="hljs-attribute">-p</span> <span class="hljs-subst">&lt;</span> <span class="hljs-literal">all</span><span class="hljs-built_in">.</span>sql</code></pre>\n\n<p>查看主服务器二进制日志名字和时间点 all.sql</p>\n\n<p><img src="http://img.blog.csdn.net/20170615222633972?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615222707236?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615223002614?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h4 id="主服务器数据复制100">主服务器数据复制100</h4>\n\n<p><img src="http://img.blog.csdn.net/20170615223302260?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h4 id="从服务器数据复制102">从服务器数据复制102</h4>\n\n\n\n<pre class="prettyprint"><code class=" hljs lasso">导入数据库，mysql <span class="hljs-attribute">-uroot</span> <span class="hljs-attribute">-p</span> <span class="hljs-subst">&lt;</span> <span class="hljs-literal">all</span><span class="hljs-built_in">.</span>sql</code></pre>\n\n<p>查看主服务器二进制日志名字和时间点 all.sql</p>\n\n<p><img src="http://img.blog.csdn.net/20170615222633972?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615222707236?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="各个服务器优化yum源及工具安装">各个服务器优化yum源及工具安装</h3>\n\n<p><strong>下载rpm包</strong></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">wget http://mirrors<span class="hljs-preprocessor">.opencas</span><span class="hljs-preprocessor">.cn</span>/epel/epel-release-latest-<span class="hljs-number">6.</span>noarch<span class="hljs-preprocessor">.rpm</span></code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170615223914916?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><strong>安装rpm</strong></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs lasso">rpm <span class="hljs-attribute">-ivh</span> epel<span class="hljs-subst">-</span><span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>rpm\nrpm <span class="hljs-attribute">-ivh</span> remi<span class="hljs-subst">-</span><span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>rpm</code></pre>\n\n<p><strong>编辑配置文件</strong></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">vim /etc/yum<span class="hljs-preprocessor">.repos</span><span class="hljs-preprocessor">.d</span>/remi<span class="hljs-preprocessor">.repo</span></code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170615224236325?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">vim /etc/yum<span class="hljs-preprocessor">.repos</span><span class="hljs-preprocessor">.d</span>/epel<span class="hljs-preprocessor">.repo</span></code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170615224342717?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="安装监控服务">安装监控服务</h3>\n\n\n\n<pre class="prettyprint"><code class=" hljs ">yum search mmm</code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170615224529276?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs lasso">yum install mysql<span class="hljs-attribute">-mmm</span><span class="hljs-attribute">-agent</span><span class="hljs-built_in">.</span>noarch <span class="hljs-attribute">-y</span> 每个服务器都要安装的代理(<span class="hljs-number">3</span>个)</code></pre>\n\n\n\n<pre class="prettyprint"><code class=" hljs lasso">安装监控服务器包\nyum <span class="hljs-attribute">-y</span> install mysql<span class="hljs-attribute">-mmm</span><span class="hljs-subst">*</span></code></pre>\n\n\n\n<h3 id="数据账号主创建-同步到主备从服务器">数据账号主创建-&gt;同步到主备，从服务器</h3>\n\n\n\n<h4 id="监控用户">监控用户</h4>\n\n\n\n<h4 id="代理用户故障转移主从切换">代理用户（故障转移，主从切换）</h4>\n\n\n\n<h4 id="复制用户复制集群时已经创建">复制用户（复制集群时已经创建）</h4>\n\n<p><img src="http://img.blog.csdn.net/20170615225428504?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="mmm数据库节点配置">MMM数据库节点配置</h3>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">\nvim /etc/mysql-mmm/mmm_common<span class="hljs-preprocessor">.conf</span>(所有集群节点必须一致)</code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170615230050749?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615230147531?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170615230312549?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>统一网卡设备号</li>\n<li>ips 虚拟IP</li>\n</ul>\n\n<p><strong>拷贝到所有其他服务器</strong> <br />\n<img src="http://img.blog.csdn.net/20170615230447099?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">vim /etc/mysql-mmm/mmm_agent<span class="hljs-preprocessor">.conf</span> 配置各个服务器名（保证不冲突）</code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170615230630554?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="mmm数据库监控节点配置监控服务器102">MMM数据库监控节点配置（监控服务器102）</h3>\n\n\n\n<pre class="prettyprint"><code class=" hljs avrasm">vim /etc/mysql-mmm/mmm_mon<span class="hljs-preprocessor">.conf</span></code></pre>\n\n<ul>\n<li>ping_ips额外检查所需要的新IP地址,为了防止MMM切换出现脑裂，建议大家把所有的服务器ip，还有网关都写上（仲裁机制）</li>\n<li>auto_set_online 主机出现问题，恢复之后在线时间</li>\n</ul>\n\n<blockquote>\n <h3 id="what-does-split-brain-mean红帽文档的解释">What does “split-brain” mean?(红帽文档的解释)</h3>\n \n <p>“Split brain” is a condition whereby two or more computers or groups of computers lose contact with one another but still act as if the cluster were intact. This is like having two governments trying to rule the same country. If multiple computers are allowed to write to the same file system without knowledge of what the other nodes are doing, it will quickly lead to data corruption and other serious problems. <br />\n Split-brain is prevented by enforcing quorum rules (which say that no group of nodes may operate unless they are in contact with a majority of all nodes) and fencing (which makes sure nodes outside of the quorum are prevented from interfering with the cluster). <br />\n 解决方案：磁盘锁 仲裁机制 或者冗余心跳线等方式来解决</p>\n</blockquote>\n\n<p><img src="http://img.blog.csdn.net/20170616091624238?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="mmm启动">MMM启动</h3>\n\n\n\n<pre class="prettyprint"><code class=" hljs lasso">三台服务器(节点) /etc/init<span class="hljs-built_in">.</span>d/mysql<span class="hljs-attribute">-mmm</span><span class="hljs-attribute">-agent</span> start\n监控服务器启动监控服务 /etc/init<span class="hljs-built_in">.</span>d/mysql<span class="hljs-attribute">-mmm</span><span class="hljs-attribute">-monitor</span> start\n查看当前集群的状态 mmm_control show</code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170616091821381?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170616092109681?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="虚拟ip正确配置监控服务器">虚拟IP正确配置（监控服务器）</h3>\n\n<p><img src="http://img.blog.csdn.net/20170616093055171?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="测试">测试</h3>\n\n\n\n<h4 id="关闭主服务器">关闭主服务器</h4>\n\n\n\n<pre class="prettyprint"><code class=" hljs vbnet">/etc/init.d/mysqld <span class="hljs-keyword">stop</span></code></pre>\n\n\n\n<h4 id="监控服务器查看">监控服务器查看</h4>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql">mmm_control <span class="hljs-operator"><span class="hljs-keyword">show</span></span></code></pre>\n\n<p><img src="http://img.blog.csdn.net/20170616093548033?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><strong>主从关系变化（查看配置）</strong> <br />\n<strong>show slave master 用于提供有关从属服务器线程的关键参数的信息</strong> <br />\n<img src="http://img.blog.csdn.net/20170616093759832?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="mmm集群优点">MMM集群优点</h3>\n\n<ul>\n<li>可以使用Prel语言来自己定制</li>\n<li>主数据库IP变更后如何通知应用对新的主DB进行连接？-&gt;虚拟IP（读和写）。</li>\n<li>前端使用的是虚拟IP</li>\n<li>主从延迟过高，就会把延迟过高的服务器迁移到没有延迟的服务器上（避免了因数据延迟导致业务逻辑上的错误）</li>\n<li>原主和主备是主主同步的关系，故障服务器重新上线可以自动的对主进行同步</li>\n<li>可以对多个MMM集群进行监控，节约服务器成本</li>\n</ul>\n\n<p><img src="http://img.blog.csdn.net/20170616095845685?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170616100337869?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170616095301229?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<h3 id="mmm集群缺点">MMM集群缺点</h3>\n\n<p><img src="http://img.blog.csdn.net/20170616100735609?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p><img src="http://img.blog.csdn.net/20170616100751406?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzM5MzY0ODE=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<ul>\n<li>不支持gtid,多线程。</li>\n<li>主从不一致的主要原因是主是多线程的，从是单线程的。并发写压力大时，无法使用多线程同步的配置。MMM会自动把主从延迟大的从服务器读VIP迁移到其他服务器上或者主服务器上。在写并发压力大时，可能会出现读VIP全部集中到主服务器上，进而导致连接数占满或者压宕机</li>\n<li>LVS F5</li>\n<li>由于mysql是异步的，不能保证日志点都是最近的，所以容易造成事务丢失或者重复提交事务（主从切换没有对比从服务器日志同步点进而选择最新的从服务器，而是主备，就是它）</li>\n<li>需要开发MMM监控服务的监控程序</li>\n</ul></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
