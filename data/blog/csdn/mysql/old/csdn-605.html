\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;"> <span style="font-size: medium;">   </span></span></span></span><span style="font-size: medium;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">在上一篇里，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">bingxi</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">和</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">alex</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">聊了关于</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">mysql</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">内核调试方法。前</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">10</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">篇是一些基础性的内容，从本篇开始，将开始描述</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">inndob</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">的存储结构，为了便于描述的方便，会将一些细节暂时隐去，在后续说到</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">B</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">时会串起来。</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;">   </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">我们可以了解到</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">oracle</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">、</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">sqlserver</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">采用的是段、簇、页的方式进行管理。很多其他的数据库也是采用的这样的方法。本篇，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">bingxi</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">和</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">alex</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">讨论的是页的编号。</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-size: medium;">对应的文件为：</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">D:/mysql-5.1.7-beta/storage/innobase/fil/fil0fil.c</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">D:/mysql-5.1.7-beta/storage/innobase/include/fil0fil.h</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;"> </span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>Bingxi</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">：“</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">alex</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，我们的初级系列终于开始进入存储部分了。存储这边内容，包含的还是比较多。</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">Innodb</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">共享存储空间而言（独立表空间也是一样，这里我们只分析共享表空间），以固定大小划分了很多个页。假设共享存储空间只有一个文件，那么编号就是从</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">0</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">开始，默认页大小为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">16k</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">。也就是文件的大小，按照</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">16k</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">进行划分。假设是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">10M</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，那么就是划分为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">640</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页，编号从</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">0-639</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">。</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-size: medium;"><img src="http://hi.csdn.net/attachment/201008/15/0_1281856101EAwA.gif" alt="" /></span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"> </p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;">  </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">现在问题来了，如果是多个文件呢，如何编号。</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">Alex</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，你来看看。提示下，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">mysql</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">的共享表空间，只允许最后一个文件为可扩展的。</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-size: medium;">”</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>Alex</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">：“</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">ok</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，我们通过代码来看这个问题。我们先配置下</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">my.ini</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，内容如下：</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">[mysqld]</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">innodb_data_file_path = ibdata1:10M;ibdata2:10M:autoextend</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;"> </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">我们看下</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">fil_io</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">代码的实现，</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">/************************************************************************</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt; mso-outline-level: 1;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">Reads or writes data. This operation is asynchronous (aio). */</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;"> </span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">ulint</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">fil_io(</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">/*===*/</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>/* out: DB_SUCCESS, or DB_TABLESPACE_DELETED</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>if we are trying to do i/o on a tablespace</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>which does not exist */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>ulint<span style="mso-tab-count: 1;"> </span>type,<span style="mso-tab-count: 2;">              </span>/* in: OS_FILE_READ or OS_FILE_WRITE,</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>ORed to OS_FILE_LOG, if a log i/o</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>and ORed to OS_AIO_SIMULATED_WAKE_LATER</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>if simulated aio and we want to post a</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>batch of i/os; NOTE that a simulated batch</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>may introduce hidden chances of deadlocks,</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>because i/os are not actually handled until</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>all have been posted: use with great</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>caution! */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>ibool<span style="mso-tab-count: 1;">       </span>sync,<span style="mso-tab-count: 2;">              </span>/* in: TRUE if synchronous aio is desired */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>ulint<span style="mso-tab-count: 1;"> </span>space_id,<span style="mso-tab-count: 1;"> </span>/* in: space id */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>ulint<span style="mso-tab-count: 1;"> </span>block_offset,<span style="mso-tab-count: 1;">   </span>/* in: offset in number of blocks */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>ulint<span style="mso-tab-count: 1;"> </span>byte_offset,<span style="mso-tab-count: 1;">    </span>/* in: remainder of offset in bytes; in</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>aio this must be divisible by the OS block</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>size */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>ulint<span style="mso-tab-count: 1;"> </span>len,<span style="mso-tab-count: 2;">         </span>/* in: how many bytes to read or write; this</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>must not cross a file boundary; in aio this</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>must be a block size multiple */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>void*<span style="mso-tab-count: 1;">      </span>buf,<span style="mso-tab-count: 2;">        </span>/* in/out: buffer where to store read data</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>or from where to write; in aio this must be</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>appropriately aligned */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>void*<span style="mso-tab-count: 1;">      </span>message)<span style="mso-tab-count: 1;"> </span>/* in: message for aio handler if non-sync</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>aio used, else ignored */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">{</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: Times New Roman;"><span style="font-size: medium;">       </span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 1;">       </span>//1.</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">找到对应的表空间结构</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>HASH_SEARCH(hash, system-&gt;spaces, space_id, space,</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 7;">                                                 </span>space-&gt;id == space_id);</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;"> </span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-spacerun: yes;"> </span>……</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;"><span style="font-size: medium;">  </span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>//2.</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">取得第一个文件结点</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>node = UT_LIST_GET_FIRST(space-&gt;chain);</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;"> </span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>for (;;) {</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 2;">              </span>……</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">        </span>//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">文件的大小根据</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">my.ini</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">的配置而定</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt; mso-outline-level: 1;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 2;">              </span>//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">第一个文件</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">ibdata1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">10M</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，因此对应的</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">node-&gt;size</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">640</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 2;">              </span>//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">第二个文件</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">ibdata2</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">10M</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，因此对应的</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">node-&gt;size</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">640</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 2;">              </span>//3.</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">假设我们查找的文件号为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">0-639</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，则对应为第一个文件。</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 2;">              </span>if (node-&gt;size &gt; block_offset) {</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 3;">                     </span>/* Found! */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 3;">                     </span>break;</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 2;">              </span>} else {</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 3;">                     </span>//4.</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">假设我们查找的文件号</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">&gt;640</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，则查看是否在第二个文件中。</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 3;">                     </span>//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">假设是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">640</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，则在第二个文件的偏移量为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">0*16k</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">字节处开始的一页，也就是文件开始处，也可以勉强称为第二个文件的第</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">0</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页，实际上是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">640</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页。</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-tab-count: 3;">                     </span>//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">假设是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">641</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，则在第二个文件的偏移量为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">(641-640)*16k</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">字节处开始的一页，也可以勉强称为第二个文件的第</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页，实际上是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">641</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页。</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 3;">                     </span>block_offset -= node-&gt;size;</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 3;">                     </span>node = UT_LIST_GET_NEXT(chain, node);</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 2;">              </span>}</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>}<span style="mso-tab-count: 2;">            </span></span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: Times New Roman;"><span style="font-size: medium;">       </span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;"> </span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-spacerun: yes;">  </span>……</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>//5.</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">计算偏移量，见前面代码中的</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">block_offset</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>offset_high = (block_offset &gt;&gt; (32 - UNIV_PAGE_SIZE_SHIFT));</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>offset_low<span style="mso-spacerun: yes;">  </span>= ((block_offset &lt;&lt; UNIV_PAGE_SIZE_SHIFT) &amp; 0xFFFFFFFFUL)</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 3;">                     </span>+ byte_offset;</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;"> </span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-spacerun: yes;">  </span>……</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>//6.</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">进行</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">aio</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">操作，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">offset_low</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">指相对于文件头的字节偏移，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">len</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">指长度，即获得长度，通常为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">16k</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-spacerun: yes;"> </span><span style="mso-tab-count: 1;">     </span>ret = os_aio(type, mode | wake_later, node-&gt;name, node-&gt;handle, buf,</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 4;">                            </span>offset_low, offset_high, len, node, message);</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-spacerun: yes;">  </span>……</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span>return(DB_SUCCESS);</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">}</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;">  </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">因此，两个文件时的页编号在本例中如图</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">2:</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"> </p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><img src="http://hi.csdn.net/attachment/201008/15/0_1281856107bIO5.gif" alt="" /></span></span></span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;">  </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">同样，假设有</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">3</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">个文件。对应的大小分别为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">xMB</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">yMB</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">zMB</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">。则第一个文件的编号为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">0---x*1024/16-1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，第二个文件的编号为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">x*1024/16---(x+y)*1024/16-1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，第三个文件的页编号为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">(x+y)*1024/16---(x+y+z)*1024/16-1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">。最后一个文件的大小是可变的，可参考</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">fil</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">相关代码。</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>Bingxi</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，页编号就是这么回事情了。每个页会一个编号，因此在每一页的开始处，会有</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">38</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">个字节用于描述本页。定义的是相对于页头的偏移量。</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt; mso-outline-level: 1;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">/* The byte offsets on a file page for various variables */</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_SPACE_OR_CHKSUM 0<span style="mso-tab-count: 1;">    </span>/* in &lt; MySQL-4.0.14 space id the</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>page belongs to (== 0) but in later</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>versions the 'new' checksum of the</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>page */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">这里记录的是页号</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt; mso-outline-level: 1;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_OFFSET<span style="mso-tab-count: 2;">              </span>4<span style="mso-tab-count: 1;">     </span>/* page offset inside space */</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">有时候页是连在一起的，比如所引页，这里通过</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">prev</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">和</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">next</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">指向前一页，后一页。</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">需要注意的是，假设本页是第</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">n</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页，下一页不需要是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">n+1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，上一页也不需要是</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">n-1</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_PREV<span style="mso-tab-count: 2;">           </span>8<span style="mso-tab-count: 1;">     </span>/* if there is a 'natural' predecessor</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 1;">       </span><span style="mso-tab-count: 4;">                            </span>of the page, its offset */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_NEXT<span style="mso-tab-count: 2;">           </span>12<span style="mso-tab-count: 1;">    </span>/* if there is a 'natural' successor</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>of the page, its offset */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页中最新日志的日志序列号</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_LSN<span style="mso-tab-count: 2;">             </span>16<span style="mso-tab-count: 1;">    </span>/* lsn of the end of the newest</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>modification log record to the page */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页的类型</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define<span style="mso-tab-count: 1;">    </span>FIL_PAGE_TYPE<span style="mso-tab-count: 2;">         </span>24<span style="mso-tab-count: 1;">    </span>/* file page type: FIL_PAGE_INDEX,...,</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>2 bytes */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_FILE_FLUSH_LSN<span style="mso-tab-count: 1;">     </span>26<span style="mso-tab-count: 1;">    </span>/* this is only defined for the</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>first page in a data file: the file</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>has been flushed to disk at least up</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>to this lsn */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID<span style="mso-spacerun: yes;">  </span>34 /appex /bin /boot /dev /etc /home /initrd.img /lib /lib64 /lost+found /media /mnt /opt /proc /root /run /sbin /serverspeeder /srv /sys /tmp /usr /var /vmlinuz starting from 4.1.x this</span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-size: small;"><span style="font-family: Times New Roman;"><span style="font-size: medium;"><span style="mso-tab-count: 5;">                                   </span>contains the space id of the page */</span></span></span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt; mso-outline-level: 1;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">//</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">这里的</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">38</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">表示的是长度</span></span></p>&#13;\n<p class="MsoNormal" style="background: #e6e6e6; margin: 0cm 0cm 0pt;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: medium;">#define FIL_PAGE_DATA<span style="mso-tab-count: 2;">           </span>38<span style="mso-tab-count: 1;">    </span>/* start of the data on the page */</span></span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: Times New Roman;">  </span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">因此文件划分为很多页，每一页有</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">38</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">个字节用于描述页头。而我们知道的是，共享存储空间是有很多数据库共同使用的，假设有如下的操作顺序：</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt; text-indent: -18pt; mso-list: l0 level1 lfo1; tab-stops: list 18.0pt;"><span style="font-size: medium;"><span style="mso-fareast-font-family: 'Times New Roman';" lang="EN-US" xml:lang="EN-US"><span style="mso-list: Ignore;"><span style="font-family: Times New Roman;">1）<span style="font-weight: normal; line-height: normal; font-style: normal; font-family: &quot;Times New Roman&quot;; font-variant: normal;">  </span></span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">创建表</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，并插入数据</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt; text-indent: -18pt; mso-list: l0 level1 lfo1; tab-stops: list 18.0pt;"><span style="font-size: medium;"><span style="mso-fareast-font-family: 'Times New Roman';" lang="EN-US" xml:lang="EN-US"><span style="mso-list: Ignore;"><span style="font-family: Times New Roman;">2）<span style="font-weight: normal; line-height: normal; font-style: normal; font-family: &quot;Times New Roman&quot;; font-variant: normal;">  </span></span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">创建表</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">2</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，并插入数据</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt; text-indent: -18pt; mso-list: l0 level1 lfo1; tab-stops: list 18.0pt;"><span style="font-size: medium;"><span style="mso-fareast-font-family: 'Times New Roman';" lang="EN-US" xml:lang="EN-US"><span style="mso-list: Ignore;"><span style="font-family: Times New Roman;">3）<span style="font-weight: normal; line-height: normal; font-style: normal; font-family: &quot;Times New Roman&quot;; font-variant: normal;">  </span></span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">表</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">插入数据</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt; text-indent: -18pt; mso-list: l0 level1 lfo1; tab-stops: list 18.0pt;"><span style="font-size: medium;"><span style="mso-fareast-font-family: 'Times New Roman';" lang="EN-US" xml:lang="EN-US"><span style="mso-list: Ignore;"><span style="font-family: Times New Roman;">4）<span style="font-weight: normal; line-height: normal; font-style: normal; font-family: &quot;Times New Roman&quot;; font-variant: normal;">  </span></span></span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">表</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">2</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">插入数据</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt; text-indent: 17.95pt; mso-char-indent-count: 1.71;"><span style="font-size: medium;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">如果我们每次分配一个页，就会存储得很凌乱。可能第</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">n</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页属于</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">t1,n+1</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页属于</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">t2</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">n+3</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页属于</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">t1,n+4</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页属于</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">t2</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，……</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt; text-indent: 17.95pt; mso-char-indent-count: 1.71;"><span style="font-size: medium;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">这样会降低</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">io</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">读写性能，连续读取性能会更好些，减少了磁头的频繁移动。</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">Bingxi</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，你觉得</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">mysql</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">是怎么解决这个问题的呢？</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-size: medium;">”</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>Bingxi</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">：“</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">ok</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">，这里面就引出了一个新的结构：簇。簇是连续的页，数量为</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">64</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">页。这个我们下篇讲。”</span></span></p>&#13;\n<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: medium;"><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;"><span style="mso-spacerun: yes;">  </span>Alex</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">：“</span><span lang="EN-US" xml:lang="EN-US"><span style="font-family: Times New Roman;">ok</span></span><span style="font-family: 宋体; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';">”</span></span></p> &#13;\n
