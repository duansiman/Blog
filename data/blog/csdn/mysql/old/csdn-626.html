\n\n<div><span style="font-family:Microsoft YaHei; font-size:18px">  在慢查询优化中， 对于 IN 这个关键字的优化的出现概率还是挺高的。 其实对于 IN 关键字出现的 SQL 优化其实难度不高， 重要的是熟悉该 SQL 的应用场景也可以说是业务逻辑。</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">  <strong><span style="color:#ff0000">一、举个最近遇到的例子</span></strong>( 业务： 查询该标签下所有的文章数量 )：</span></div>&#13;\n<div>&#13;\n<div><pre name="code" class="sql">select count(*) from cms_article ca where 某个TagID in (select cat.tag_id from cms_article_tag cat where ca.id=cat.article_id)</pre><br />&#13;\n<br />&#13;\n</div>&#13;\n<div><span style="color:rgb(34,34,34)"><span style="font-family:Microsoft YaHei; font-size:18px">看下 EXPLAIN 结果：</span></span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><img src="http://img.blog.csdn.net/20150808021410240?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br />&#13;\n</div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><br />&#13;\n</div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">引用MySQL官方文档的一句话：A typical case for poor <code style="padding:0px; border:0px; outline:0px; vertical-align:baseline; color:rgb(2,103,137); font-weight:bold">IN</code> subquery performance is when&#13;\n the subquery returns a small number of rows but the outer query returns a large number of rows to be compared to the subquery result.</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">可以从 EXPLAIN 结果明显看出， IN 子查询就扫了2行， 而另一个查询扫描了大量行数， 完全符合官方文档说的慢查询情况。</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Helvetica,Arial,sans-serif; font-size:14px">  </span>&#13;\n<span style="font-family:Microsoft YaHei; font-size:18px; color:#ff0000"><strong>二、如何优化呢？</strong></span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"> </span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">  本文开头就说了， 先熟悉业务逻辑， 然后就很好改了。</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">引用MySQL官方文档的解决方案：The optimizer is more mature for joins than for subqueries, so in many cases a statement that uses a subquery can be executed more efficiently if you rewrite it as a join.［也就是熟悉业务，&#13;\n 然后大多数情况都能改成 JOIN 的方式来优化］</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">优化后SQL：</span></div>&#13;\n<div>&#13;\n<div><pre name="code" class="sql">select count(*) from cms_article ca RIGHT JOIN cms_article_tag cat ON cna.id = cnat.article_id WHERE cnat.tag_id=某TagID</pre><br />&#13;\n<br />&#13;\n</div>&#13;\n<div><span style="color:rgb(34,34,34)"><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></span></div>&#13;\n<div><span style="color:rgb(34,34,34)"><span style="font-family:Microsoft YaHei; font-size:18px">EXPLAIN结果：</span></span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><img src="http://img.blog.csdn.net/20150808021427670?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /><br />&#13;\n</div>&#13;\n</div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">查询行数锐减， 只要25*1的复杂度就完成了本次查询。 </span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">  <strong><span style="color:#ff0000">三、 参考资料</span></strong></span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-family:Microsoft YaHei; font-size:18px">                         MySQL官网</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><br />&#13;\n</div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n<div style="font-family:'Helvetica Neue'; font-size:14px"><span style="font-family:Helvetica,Arial,sans-serif"><br />&#13;\n</span></div>&#13;\n</div>&#13;\n &#13;\n
