\n\n<h1>&#13;\n</h1><p><span style="font-size:32px">一、           发现慢查询</span></p>&#13;\n&#13;\n<div><span style="font-size:14px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-size:14px">上一讲我们谈论了慢查询的定义，这一讲我们来创建一张大表，为慢查询做数据准备。</span></div>&#13;\n<div><span style="font-size:14px"><br />&#13;\n</span></div>&#13;\n<div><span style="font-size:14px"><br />&#13;\n</span></div>&#13;\n<div>&#13;\n<p><strong><span style="font-size:24px">2.      慢查询数据准备</span></strong></p>&#13;\n<div><span style="font-size:14px"><br />&#13;\n</span></div>&#13;\n<span style="font-size:14px">要想发现慢查询，首先要使慢查询发生。在一张普通数量级的表格中是不能发生慢查询的，除非你对于慢查询的定义时一个毫秒。因此我们必须手动创建一张大数量级的表，这里选择创建一张40万数量级的表（同学们也可以创建百万级的，如果你们的电脑很厉害。但是一般情况下，十万级的数据就可以看出慢查询了）。<br />&#13;\n</span></div>&#13;\n<div><span style="font-size:14px"><br />&#13;\n</span></div>&#13;\n<div>&#13;\n<p><strong><span style="font-size:14px">1)    创建数据库</span></strong></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">Create database bigTable default character set GBK;</pre><br />&#13;\n<p></p>&#13;\n<p><strong><span style="font-size:14px">2)    创建表</span></strong></p>&#13;\n<span style="font-size:14px">#部门表#</span></div>&#13;\n<div>&#13;\n<p><span style="font-size:14px"><br />&#13;\n</span></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">CREATE TABLE dept(\nid int unsigned primary key auto_increment,\ndeptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0, \ndname VARCHAR(20) NOT NULL DEFAULT "",\nloc VARCHAR(13) NOT NULL DEFAULT ""\n) ENGINE=INNODB DEFAULT CHARSET=GBK ;</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<p><span style="font-size:14px">#雇员表#<br />&#13;\n</span></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">CREATE TABLE emp\n(\nid int unsigned primary key auto_increment,\nempno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0, /*编号*/\nename VARCHAR(20) NOT NULL DEFAULT "", /*名字*/\njob VARCHAR(9) NOT NULL DEFAULT "",/*工作*/\nmgr MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,/*上级编号*/\nhiredate DATE NOT NULL,/*入职时间*/\nsal DECIMAL(7,2) NOT NULL,/*薪水*/\ncomm DECIMAL(7,2) NOT NULL,/*红利*/\ndeptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0 /*部门编号*/\n)ENGINE=INNODB DEFAULT CHARSET=GBK ;</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<p><strong><span style="font-size:14px">3)    创建函数</span></strong></p>&#13;\n<p><span style="font-size:14px">函数用于随机产生数据，保证每条数据都不同</span></p>&#13;\n<p><span style="font-size:14px">#函数1 创建#</span></p>&#13;\n<p><span style="font-size:14px">#创建函数. 用于随机产生字符串。该函数接收一个整数</span></p>&#13;\n<p><span style="font-size:14px"><br />&#13;\n</span></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">delimiter $$#定义一个新的命令结束符合\ncreate function rand_string(n INT) \nreturns varchar(255) #该函数会返回一个字符串\nbegin \n#chars_str定义一个变量 chars_str,类型是 varchar(100),默认值'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ';\n declare chars_str varchar(100) default\n 'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ';\n declare return_str varchar(255) default '';\n declare i int default 0;\n while i &lt; n do \n set return_str =concat(return_str,substring(chars_str,floor(1+rand()*52),1));\n set i = i + 1;\n end while;\n return return_str;\n end $$</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<p><span style="font-size:14px">#函数2创建#</span></p>&#13;\n<p><span style="font-size:14px">#用于随机产生部门编号</span></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">create function rand_num( )\nreturns int(5)\nbegin \n declare i int default 0;\n set i = floor(10+rand()*500);\nreturn i;\n end $$</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<p><strong><span style="font-size:14px">4)    创建存储过程</span></strong></p>&#13;\n<p><span style="font-size:14px"> </span></p>&#13;\n<p><span style="font-size:14px">#存储过程一#</span></p>&#13;\n<span style="font-size:14px">#该存储过程用于往emp表中插入大量数据<br />&#13;\n</span>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">create procedure insert_emp(in start int(10),in max_num int(10))\nbegin\ndeclare i int default 0; \n#set autocommit =0 把autocommit设置成0\n set autocommit = 0; \n repeat\n set i = i + 1;\n insert into emp (empno, ename ,job ,mgr ,hiredate ,sal ,comm ,deptno ) values ((start+i) ,rand_string(6),'SALESMAN',0001,curdate(),2000,400,rand_num());\n until i = max_num\n end repeat;\n commit;\n end $$</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<p><span style="font-size:14px">执行存储过程，往emp表添加40万条数据</span></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">call insert_emp(100001,400000);</pre><br />&#13;\n<p></p>&#13;\n<p><span style="font-size:14px">查询，发现Emp表插入了40万条记录<br />&#13;\n</span></p>&#13;\n<p><span style="font-size:14px"><img src="http://img.blog.csdn.net/20150331095320353?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHp5MzgzMjQ=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="" /><br />&#13;\n</span></p>&#13;\n<p><span style="font-size:14px"><br />&#13;\n</span></p>&#13;\n<p><span style="font-size:14px">#存储过程二#</span></p>&#13;\n<p><span style="font-size:14px">#往dept表添加随机数据</span></p>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">create procedure insert_dept(in start int(10),in max_num int(10))\nbegin\ndeclare i int default 0; \n set autocommit = 0; \n repeat\n set i = i + 1;\n insert into dept (deptno ,dname,loc ) values ((start+i) ,rand_string(10),rand_string(8));\n until i = max_num\n end repeat;\n commit;\n end $$</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<span style="font-size:14px">执行存储过程二</span>&#13;\n<p></p>&#13;\n<pre name="code" class="plain">delimiter ;\ncall insert_dept(100,10);</pre><br />&#13;\n<br />&#13;\n<p></p>&#13;\n<span style="font-size:14px"><strong>至此，数据准备完成。我们创建了大表emp。</strong><br />&#13;\n</span>&#13;\n<p></p>&#13;\n<p><span style="font-size:14px"><br />&#13;\n</span></p>&#13;\n<p><span style="font-size:14px">下一讲，我们将利用已创建的大表去发现慢查询，并试着把慢查询记录到日志中。</span></p>&#13;\n</div>&#13;\n<div><span style="font-size:14px"><br />&#13;\n</span></div>&#13;\n &#13;\n
