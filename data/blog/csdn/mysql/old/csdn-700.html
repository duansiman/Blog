\n <div class="markdown_views"><p><strong>1、游标的概念（Cursor）</strong></p>\n\n<blockquote>\n <p>一条sql，对应N条资源，取出资源的接口，就是游标，沿着游标，可以一次取出1行。如果开发过安卓的同学应该知道有一个Api是Cursor，也是读取SQLite数据库用的，和这个有点类似。</p>\n</blockquote>\n\n<p><strong>2、使用游标的步骤</strong></p>\n\n<p>（1）声明</p>\n\n<p>使用declare进行声明</p>\n\n<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-keyword">declare</span> 游标名 cursor <span class="hljs-keyword">for</span> select_statement</code></pre>\n\n<p>（2）打开游标</p>\n\n<p>使用open进行打开</p>\n\n<pre class="prettyprint"><code class=" hljs fsharp"><span class="hljs-keyword">open</span> 游标名</code></pre>\n\n<p>（3）从游标中取值</p>\n\n<p>使用fetch进行取值</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs r">fetch 游标名 into var1,var2[,<span class="hljs-keyword">...</span>] --将取到的一行赋值给多个变量</code></pre>\n\n<p>（4）关闭游标</p>\n\n<p>使用close关闭游标</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs livecodeserver"><span class="hljs-built_in">close</span> 游标名</code></pre>\n\n<p><strong>3、创建一个简单的游标</strong></p>\n\n<blockquote>\n <p>需求：从商品表中读取第一行数据</p>\n</blockquote>\n\n<p>商品表（goods）数据：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120101751740" alt="这里写图片描述" title="" /></p>\n\n<p>注意：我这里已经将MySQL的结束标识符改为 <code>$</code>，如果要知道怎么设置为<code>$</code>，请参考我的另一篇文章：<a href="http://blog.csdn.net/baochao95/article/details/53197183">MySQL触发器</a>。</p>\n\n<p>定义：</p>\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">p12</span><span class="hljs-params">()</span>\n<span class="hljs-title">begin</span>\n /*定义三个变量用于存放商品<span class="hljs-title">id</span>,商品名称，商品库存量*/\n <span class="hljs-title">declare</span> <span class="hljs-title">row_gid</span> <span class="hljs-title">int</span> ;</span> \n declare row_name varchar(<span class="hljs-number">20</span>);\n declare row_num int;\n declare getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods; --定义游标\n open getgoods; --打开游标\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;--从游标中取值\n <span class="hljs-keyword">select</span> row_name,row_num; --显示操作\n close getgoods; --关闭游标\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出结果：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120102317719" alt="这里写图片描述" title="" /></p>\n\n<p><strong>4、多次取值操作</strong></p>\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">p13</span><span class="hljs-params">()</span>\n<span class="hljs-title">begin</span>\n <span class="hljs-title">declare</span> <span class="hljs-title">row_gid</span> <span class="hljs-title">int</span> ;</span>\n declare row_name varchar(<span class="hljs-number">20</span>);\n declare row_num int;\n declare getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods; \n open getgoods;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n close getgoods;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120102455810" alt="这里写图片描述" title="" /></p>\n\n<p>注意：当游标读到末尾，如果继续进行取值操作会发生报错</p>\n\n<p><strong>5、游标循环表中的所有数据</strong></p>\n\n<p>（1）使用计数器来循环</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs vbnet">create procedure p14()\nbegin \n <span class="hljs-keyword">declare</span> cnt int <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;\n <span class="hljs-keyword">declare</span> i int <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;\n <span class="hljs-keyword">declare</span> row_gid int ;\n <span class="hljs-keyword">declare</span> row_name varchar(<span class="hljs-number">20</span>);\n <span class="hljs-keyword">declare</span> row_num int;\n <span class="hljs-keyword">declare</span> getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods;\n <span class="hljs-keyword">select</span> count(*) <span class="hljs-keyword">into</span> cnt <span class="hljs-keyword">from</span> goods;\n open getgoods;\n repeat \n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n <span class="hljs-keyword">set</span> i:= i+<span class="hljs-number">1</span>;\n <span class="hljs-keyword">until</span> i &gt;= cnt <span class="hljs-keyword">end</span> repeat;\n close getgoods;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出结果：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120102611952" alt="这里写图片描述" title="" /></p>\n\n<p>（2）使用越界标志来控制循环</p>\n\n<blockquote>\n <p>在mysql cursor中，可以声明declare continue handler来操作1个越界标志</p>\n</blockquote>\n\n<p>语法：</p>\n\n<pre class="prettyprint"><code class=" hljs sql">declare continue <span class="hljs-operator"><span class="hljs-keyword">handler</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">FOUND</span> statement;</span></code></pre>\n\n<p>使用：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">p15</span><span class="hljs-params">()</span>\n<span class="hljs-title">begin</span>\n <span class="hljs-title">declare</span> <span class="hljs-title">row_gid</span> <span class="hljs-title">int</span> ;</span>\n declare row_name varchar(<span class="hljs-number">20</span>);\n declare row_num int;\n declare have int <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;\n declare getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods;\n declare <span class="hljs-keyword">continue</span> handler <span class="hljs-keyword">for</span> <span class="hljs-keyword">NOT</span> FOUND <span class="hljs-keyword">set</span> have:= <span class="hljs-number">0</span>;\n open getgoods;\n <span class="hljs-keyword">repeat</span> \n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n <span class="hljs-keyword">until</span> have = <span class="hljs-number">0</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">repeat</span>;\n close getgoods;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出结果：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120102830581" alt="这里写图片描述" title="" /></p>\n\n<p>注意：这里发生了错误，这里输出了4行数据，而表中只有3行数据，而且还爆出了警告，后面会说怎么结果这个问题。</p>\n\n<p>程序执行逻辑：</p>\n\n<p>循环游标-&gt;fetch第三条数据-&gt;显示-&gt;fetch第四条数据-&gt;没有数据-&gt;设置have=0操作-&gt;执行continue Handler-&gt;程序不退出，执行显示操作-&gt;还是显示第三条数据</p>\n\n<p><strong>6、continue和exit的区别</strong></p>\n\n<blockquote>\n <p>continue：若没有数据返回，程序继续，并将变量IS_FOUND设为0，这种情况是出现在select XX into XXX from tablename的时候发生的。 </p>\n \n <p>exit：若没有数据返回，退出程序，并将变量IS_FOUND设为0，这种情况是出现在select XX into XXX from tablename的时候发生的。</p>\n</blockquote>\n\n<p>使用exit来替换continue： <br />\n使用exit就不会出现上面的那种情况了，程序执行逻辑：</p>\n\n<p>循环游标-&gt;fetch到第三条数据-&gt;显示-&gt;第四次fetch操作-&gt;没有数据-&gt;设置 have=0操作-&gt;程序直接退出exit</p>\n\n<p>所以就没有显示出第四条数据。</p>\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">p16</span><span class="hljs-params">()</span>\n<span class="hljs-title">begin</span>\n <span class="hljs-title">declare</span> <span class="hljs-title">row_gid</span> <span class="hljs-title">int</span> ;</span>\n declare row_name varchar(<span class="hljs-number">20</span>);\n declare row_num int;\n declare have int <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;\n declare getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods;\n declare <span class="hljs-keyword">exit</span> handler <span class="hljs-keyword">for</span> <span class="hljs-keyword">NOT</span> FOUND <span class="hljs-keyword">set</span> have:= <span class="hljs-number">0</span>;\n open getgoods;\n <span class="hljs-keyword">repeat</span> \n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">select</span> row_name,row_num;\n <span class="hljs-keyword">until</span> have = <span class="hljs-number">0</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">repeat</span>;\n close getgoods;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出结果：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120103130396" alt="这里写图片描述" title="" /></p>\n\n<p><strong>7、正确的游标循环</strong></p>\n\n<blockquote>\n <p>在一些特殊的情况中，我们可以读到的数据为空，或者压根sql语句就有错误，我们不能避免出现这种情况，所以我们要正确的使用游标循环操作。</p>\n</blockquote>\n\n<p>首先应该创建游标，然后打开游标后，应先手动进行fetch操作获取到一行数据，然后再通过循环，在循环里先做处理内容，后进行fetch操作。这样如果在手动获取数据的期间就没有获得到数据的话，就会执行have = 0，如果是repeat循环，然后进入repeat循环，先输出null数据，最后又进行获取，这样运行到until时就会退出循环；如果是while循环，压根就不进去while循环里，就不会有任何1行输出。</p>\n\n<p>（1）repeat循环：</p>\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">p17</span><span class="hljs-params">()</span>\n<span class="hljs-title">begin</span>\n <span class="hljs-title">declare</span> <span class="hljs-title">row_gid</span> <span class="hljs-title">int</span>;</span>\n declare row_name varchar(<span class="hljs-number">20</span>);\n declare row_num int;\n declare have int <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;\n declare getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods <span class="hljs-keyword">where</span> <span class="hljs-number">0</span>;\n declare <span class="hljs-keyword">continue</span> handler <span class="hljs-keyword">for</span> <span class="hljs-keyword">NOT</span> FOUND <span class="hljs-keyword">set</span> have:= <span class="hljs-number">0</span>;\n open getgoods;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">repeat</span> \n <span class="hljs-keyword">select</span> row_name,row_num;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">until</span> have = <span class="hljs-number">0</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">repeat</span>;\n close getgoods;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出结果：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120103234508" alt="这里写图片描述" title="" /></p>\n\n<p>（2）while循环：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> <span class="hljs-function"><span class="hljs-keyword">procedure</span> <span class="hljs-title">p18</span><span class="hljs-params">()</span>\n<span class="hljs-title">begin</span>\n <span class="hljs-title">declare</span> <span class="hljs-title">row_gid</span> <span class="hljs-title">int</span>;</span>\n declare row_name varchar(<span class="hljs-number">20</span>);\n declare row_num int;\n declare have int <span class="hljs-keyword">default</span> <span class="hljs-number">1</span>;\n declare getgoods cursor <span class="hljs-keyword">for</span> <span class="hljs-keyword">select</span> gid,name,num <span class="hljs-keyword">from</span> goods <span class="hljs-keyword">where</span> <span class="hljs-number">0</span>;\n declare <span class="hljs-keyword">continue</span> handler <span class="hljs-keyword">for</span> <span class="hljs-keyword">NOT</span> FOUND <span class="hljs-keyword">set</span> have:= <span class="hljs-number">0</span>;\n open getgoods;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">while</span> have = <span class="hljs-number">1</span> <span class="hljs-keyword">do</span> \n <span class="hljs-keyword">select</span> row_name,row_num;\n fetch getgoods <span class="hljs-keyword">into</span> row_gid,row_name,row_num;\n <span class="hljs-keyword">end</span> <span class="hljs-keyword">while</span>;\n close getgoods;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>输出结果：</p>\n\n<p><img src="http://img.blog.csdn.net/20161120103321400" alt="这里写图片描述" title="" /></p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
