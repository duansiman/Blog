\n <div class="markdown_views"><p>如何建立理想的索引？</p>\n\n<ul>\n<li>查询频繁度</li>\n<li>区分度</li>\n<li>索引长度</li>\n<li>覆盖字段</li>\n</ul>\n\n<p><strong>区分度</strong></p>\n\n<p>假设100万用户,性别基本上男/女各为50W, 区分度就低。</p>\n\n<p><strong>长度小</strong></p>\n\n<p>索引长度直接影响索引文件的大小,影响增删改的速度,并间接影响查询速度(占用内存多).</p>\n\n<p><strong>区分度高，长度小</strong></p>\n\n<p>问题：如果让区分度高，而长度小？</p>\n\n<p>答：可以针对列中的值,从左往右截取部分,来建索引</p>\n\n<p>（1）截的越短, 重复度越高,区分度越小, 索引效果越不好 <br />\n（2）截的越长, 重复度越低,区分度越高, 索引效果越好,但带来的影响也越大–增删改变慢,并间影响查询速度.</p>\n\n<p>所以, 我们要在 区分度 + 长度 两者上,取得一个平衡。惯用手法：截取不同长度,并测试其区分度。</p>\n\n<p>假设我们有一张表：英语4级的单词表，里面有13324条记录，我们怎么给name字段加索引呢？</p>\n\n<p><img src="http://img.blog.csdn.net/20170315101702583?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmFvY2hhbzk1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p>如果计算区分度？</p>\n\n<p>截取单词第1位的不重复数：<code>select count(distinct left(name,1)) from dict</code></p>\n\n<p>总的数量：<code>select count(*) from dict</code></p>\n\n<p>区分度：不重复数/总的数量，sql语句如下：</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">select</span> (<span class="hljs-keyword">select</span> <span class="hljs-aggregate">count</span>(<span class="hljs-keyword">distinct</span> <span class="hljs-keyword">left</span>(name,<span class="hljs-number">1</span>)) <span class="hljs-keyword">from</span> dict) / (<span class="hljs-keyword">select</span> <span class="hljs-aggregate">count</span>(*) <span class="hljs-keyword">from</span> dict) <span class="hljs-keyword">as</span> rate;</span></code></pre>\n\n<p>然后按照这样的步骤把其他长度所对应的区分度给找出来，看一个这个图表，可以知道当长度为11的时候重复度仅仅为1%，我们可以考虑建立11位长的索引</p>\n\n<p><img src="http://img.blog.csdn.net/20170315101848444?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmFvY2hhbzk1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> dict <span class="hljs-keyword">add</span> index name name(<span class="hljs-number">11</span>);</span></code></pre>\n\n<p><strong>左前缀不好区分的情况</strong></p>\n\n<p>对于左前缀不易区分的列 ,建立索引的技巧</p>\n\n<p>如url列 <br />\n<a href="http://www.baidu.com">http://www.baidu.com</a> <br />\n<a href="http://www.web-bc.cn">http://www.web-bc.cn</a> <br />\n列的前11个字符都是一样的,不易区分, 可以用如下2个办法来解决</p>\n\n<p>（1）把列内容倒过来存储,并建立索引 <br />\nmoc.udiab.www//:ptth <br />\nnc.cb-bew.www//://ptth <br />\n这样左前缀区分度大</p>\n\n<p>（2）伪hash索引效果 <br />\n同时存url和url_hash列</p>\n\n<pre class="prettyprint"><code class=" hljs sql">#建表\n<span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t10 (\nid <span class="hljs-keyword">int</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">key</span>,\nurl <span class="hljs-keyword">char</span>(<span class="hljs-number">60</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">default</span> <span class="hljs-string">''</span>\n);</span>\n\n#插入数据\n<span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> t10 <span class="hljs-keyword">values</span> \n(<span class="hljs-number">1</span>,<span class="hljs-string">'http://www.baidu.com'</span>),\n(<span class="hljs-number">2</span>,<span class="hljs-string">'http://www.sina.com'</span>),\n(<span class="hljs-number">3</span>,<span class="hljs-string">'http://www.sohu.com.cn'</span>),\n(<span class="hljs-number">4</span>,<span class="hljs-string">'http://www.onlinedown.net'</span>),\n(<span class="hljs-number">5</span>,<span class="hljs-string">'http://www.gov.cn'</span>);</span>\n\n#修改表结构，添加urlcrc列\n<span class="hljs-operator"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> t10 <span class="hljs-keyword">add</span> urlcrc <span class="hljs-keyword">int</span> unsigned <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>;</span></code></pre>\n\n<p>在存储的时候，将url对应的crc32码一同插入到数据库中，然后按照urlcrc字段建立索引，然后查找的时候，我们在业务层中将对应的url转换为crc32进行查找，就可以利用上索引了。</p>\n\n<p>因为crc的结果是32位int无符号数,因此当数据超过40亿,也会有重复,但这是值得的.(索引长度为int4个字节)</p>\n\n<p><strong>多列索引</strong></p>\n\n<p>多列索引的考虑因素—列的查询频率 , 列的区分度, 注意一定要结合实际业务场景 <br />\n以ecshop商城为例, goods表中的cat_id,brand_id,做多列索引，从区分度看,brand_id区分度更高, 但从 商城的实际业务业务看, 顾客一般先选大分类-&gt;小分类-&gt;品牌，最终选择建立2个索引： <br />\n（1）index(cat_id,brand_id) <br />\n（2）index(cat_id,shop_price)</p>\n\n<p>甚至可以再加 (3)index(cat_id,brand_id,shop_price),3个冗余索引</p>\n\n<p>但(3)中的前2列和(1)中的前2列一样,所以可以再去掉(1)，建立2个索引 <br />\nindex(cat_id,price) 和 index(cat_id,brand_id,shop_price);</p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
