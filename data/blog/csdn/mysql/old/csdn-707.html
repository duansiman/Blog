\n <div class="markdown_views"><p>在MySQL中，MyISAM采用的是非聚簇索引的，InnoDB存储引擎是采用聚簇索引的。</p>\n\n<p>聚簇结构的特点：</p>\n\n<ul>\n<li>根据主键查询条目时,不用回行(数据就在主键节点下)</li>\n<li>如果碰到不规则数据插入时,造成频繁的页分裂</li>\n</ul>\n\n<p>为什么会产生页分裂？</p>\n\n<p>这是因为聚簇索引采用的是平衡二叉树算法，而且每个节点都保存了该主键所对应行的数据，假设插入数据的主键是自增长的，那么根据二叉树算法会很快的把该数据添加到某个节点下，而其他的节点不用动；但是如果插入的是不规则的数据，那么每次插入都会改变二叉树之前的数据状态。从而导致了页分裂。</p>\n\n<p>测试：</p>\n\n<p>创建2张表</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t8(\nid <span class="hljs-keyword">int</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">key</span>,\nc1 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc2 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc3 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc4 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc5 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc6 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>)\n) engine innodb charset utf8;</span>\n<span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> t9(\nid <span class="hljs-keyword">int</span> <span class="hljs-keyword">primary</span> <span class="hljs-keyword">key</span>,\nc1 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc2 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc3 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc4 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc5 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>),\nc6 <span class="hljs-keyword">varchar</span>(<span class="hljs-number">500</span>)\n) engine innodb charset utf8;</span></code></pre>\n\n<p>写一个php脚本，用于插入1W条无规则的主键数据和1W条规则的主键数据，来看看区别。</p>\n\n<pre class="prettyprint"><code class=" hljs bash">&lt;?php\n<span class="hljs-keyword">set</span>_time_limit(<span class="hljs-number">0</span>);\n<span class="hljs-variable">$conn</span> = mysql_connect(<span class="hljs-string">'localhost'</span>,<span class="hljs-string">'root'</span>,<span class="hljs-string">'1234'</span>);\nmysql_query(<span class="hljs-string">'use test;'</span>);\n\n//自增长主键\n<span class="hljs-variable">$str</span> = str_repeat(<span class="hljs-string">'a'</span>, <span class="hljs-number">500</span>);\n<span class="hljs-variable">$startTime</span> = microtime(<span class="hljs-literal">true</span>);\n<span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">1</span>;<span class="hljs-variable">$i</span>&lt;=<span class="hljs-number">10000</span>;<span class="hljs-variable">$i</span>++){\n mysql_query(<span class="hljs-string">"insert into t8 values(<span class="hljs-variable">$i</span>,'<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>')"</span>);\n}\n<span class="hljs-variable">$endTime</span> = microtime(<span class="hljs-literal">true</span>);\n<span class="hljs-built_in">echo</span> <span class="hljs-variable">$endTime</span>-<span class="hljs-variable">$startTime</span>.<span class="hljs-string">'&lt;br/&gt;'</span>;\n\n//无序的主键\n<span class="hljs-variable">$arr</span> = range(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>);\nshuffle(<span class="hljs-variable">$arr</span>);\n<span class="hljs-variable">$startTime</span> = microtime(<span class="hljs-literal">true</span>);\nforeach(<span class="hljs-variable">$arr</span> as <span class="hljs-variable">$i</span>){\n mysql_query(<span class="hljs-string">"insert into t9 values(<span class="hljs-variable">$i</span>,'<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>','<span class="hljs-variable">$str</span>')"</span>);\n}\n<span class="hljs-variable">$endTime</span> = microtime(<span class="hljs-literal">true</span>);\n<span class="hljs-built_in">echo</span> <span class="hljs-variable">$endTime</span>-<span class="hljs-variable">$startTime</span>.<span class="hljs-string">'&lt;br/&gt;'</span>;\n</code></pre>\n\n<p>测试结果图</p>\n\n<p><img src="http://img.blog.csdn.net/20170313190301428?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYmFvY2hhbzk1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" /></p>\n\n<p>1W条规则的数据：998秒 = 16分钟 <br />\n1W条不规则的数据：1939秒 = 32分钟</p>\n\n<p>结论：</p>\n\n<p>聚簇索引的主键值,应尽量是连续增长的值,而不是要是随机值, (不要用随机字符串或UUID)，否则会造成大量的页分裂与页移动。在使用InnoDB的时候最好定义成：</p>\n\n<p><code>id int unsigned primary key auto_increment</code></p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
