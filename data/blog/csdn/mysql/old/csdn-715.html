\n <div class="markdown_views"><p><strong>1、触发器的概念</strong></p>\n\n<blockquote>\n <p>触发器（trigger）是MySQL提供给程序员和数据分析员来保证数据完整性的一种方法，它是与表事件相关的特殊的存储过程，它的执行不是由程序调用，也不是手工启动，而是由事件来触发，比如当对一个表进行操作（ <br />\n insert，delete， update）时就会激活它执行。——百度百科</p>\n</blockquote>\n\n<p>上面是百度给的触发器的概念，我理解的触发器的概念，就是你执行一条sql语句，这条sql语句的执行会自动去触发执行其他的sql语句，就这么简单。</p>\n\n<p>超简说明：sql1-&gt;触发-&gt;sqlN，一条sql触发多个sql</p>\n\n<p><strong>2、触发器创建的四个要素</strong></p>\n\n<p>（1）监视地点（table） <br />\n（2）监视事件（insert/update/delete） <br />\n（3）触发时间（after/before） <br />\n（4）触发事件（insert/update/delete）</p>\n\n<p><strong>3、创建触发器</strong></p>\n\n<p>需求：在下订单的时候，对应的商品的库存量要相应的减少，即买几个商品就减少多少个库存量。</p>\n\n<p>订单表：ord <br />\n商品表：goods</p>\n\n<p>首先来创建表并添加几条数据：</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> goods(\n gid <span class="hljs-keyword">int</span>,\n name <span class="hljs-keyword">varchar</span>(<span class="hljs-number">20</span>),\n num <span class="hljs-keyword">smallint</span>\n);</span>\n<span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> ord(\n oid <span class="hljs-keyword">int</span>,\n gid <span class="hljs-keyword">int</span>,\n much <span class="hljs-keyword">smallint</span>\n);</span>\n<span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> goods <span class="hljs-keyword">values</span>(<span class="hljs-number">1</span>,<span class="hljs-string">'cat'</span>,<span class="hljs-number">40</span>);</span>\n<span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> goods <span class="hljs-keyword">values</span>(<span class="hljs-number">2</span>,<span class="hljs-string">'dog'</span>,<span class="hljs-number">63</span>);</span>\n<span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> goods <span class="hljs-keyword">values</span>(<span class="hljs-number">3</span>,<span class="hljs-string">'pig'</span>,<span class="hljs-number">87</span>);</span></code></pre>\n\n<p>然后按照触发器创建的四个要素来进行分析：</p>\n\n<blockquote>\n <p>监视谁：ord（订单表） <br />\n 监视动作：insert（插入操作） <br />\n 触发时间：after（在插入操作后触发） <br />\n 触发事件：update（触发更新操作）</p>\n</blockquote>\n\n<p>最后创建触发器：</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> t1 \n<span class="hljs-keyword">after</span>\n<span class="hljs-keyword">insert</span> \n<span class="hljs-keyword">on</span> ord\n<span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>\n<span class="hljs-keyword">begin</span>\n <span class="hljs-keyword">update</span> goods <span class="hljs-keyword">set</span> num=num-<span class="hljs-number">2</span> <span class="hljs-keyword">where</span> gid = <span class="hljs-number">1</span>;</span>\n<span class="hljs-operator"><span class="hljs-keyword">end</span>$</span></code></pre>\n\n<p>分析：触发器的名称为t1，触发时间为after，监视动作为insert，监视ord表，for each row最后在进行讨论，这里先记住就行了，begin和end之间写触发事件，这里是一个update语句。意思是不论我下什么订单，都会把商品编号为1的商品的库存量减去2个。</p>\n\n<p>注意：先不要运行上面的代码，因为mysql的执行结束标识默认是<code>;</code>。如果运行以上的sql语句，mysql碰到<code>;</code>时会自动停止执行，然后end语句就执行不到了。所以我们需要先将mysql的结束标识符改为其他的字符，一般都选用<code>$</code>或者<code>$$</code>，这里选用$来作为执行的结束标识。使用下面的语句来修改MySQL执行的结束标识。</p>\n\n<pre class="prettyprint"><code class=" hljs cs">delimiter $ <span class="hljs-comment">//设置MySQL执行结束标志，默认为;</span></code></pre>\n\n<p><strong>4、查看和删除已有的触发器</strong></p>\n\n<p>（1）查看已有触发器：<code>show triggers</code> <br />\n（2）删除已有触发器：<code>drop trigger triggerName</code></p>\n\n<p><strong>5、触发器中引用行变量</strong></p>\n\n<p>（1）在触发目标上执行insert操作后会有一个新行，如果在触发事件中需要用到这个新行的变量，可以用new关键字表示 <br />\n（2）在触发目标上执行delete操作后会有一个旧行，如果在触发事件中需要用到这个旧行的变量，可以用old关键字表示 <br />\n（3）在触发目标上执行update操作后原纪录是旧行，新记录是新行，可以使用new和old关键字来分别操作</p>\n\n<p>当下订单时减少相应的货品的库存量，创建触发器：</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> t2\n<span class="hljs-keyword">after</span>\n<span class="hljs-keyword">insert</span> \n<span class="hljs-keyword">on</span> ord\n<span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>\n<span class="hljs-keyword">begin</span>\n <span class="hljs-keyword">update</span> goods <span class="hljs-keyword">set</span> num=num-new.much <span class="hljs-keyword">where</span> gid=new.gid;</span>\n<span class="hljs-operator"><span class="hljs-keyword">end</span>$</span></code></pre>\n\n<p>当删除订单时增加相应的修改货品的库存量，创建触发器：</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> t3\n<span class="hljs-keyword">after</span>\n<span class="hljs-keyword">delete</span>\n<span class="hljs-keyword">on</span> ord\n<span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>\n<span class="hljs-keyword">begin</span>\n <span class="hljs-keyword">update</span> goods <span class="hljs-keyword">set</span> num=num+old.much <span class="hljs-keyword">where</span> gid=old.gid;</span>\n<span class="hljs-operator"><span class="hljs-keyword">end</span>$</span></code></pre>\n\n<p>当更新订单的购买数修改相应的修改货品的库存量，创建触发器：</p>\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> t4\n<span class="hljs-keyword">before</span> \n<span class="hljs-keyword">update</span>\n<span class="hljs-keyword">on</span> ord\n<span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span>\n<span class="hljs-keyword">begin</span>\n <span class="hljs-keyword">update</span> goods <span class="hljs-keyword">set</span> num=num+old.much-new.much <span class="hljs-keyword">where</span> gid = new.gid;</span>\n<span class="hljs-operator"><span class="hljs-keyword">end</span>$</span></code></pre>\n\n<p><strong>6、after和before的区别</strong></p>\n\n<p>after操作，是在执行了监视动作后，才会执行触发事件 <br />\nbefore操作，是在执行了监视动作前，会执行触发事件 <br />\n两者在一般的触发器中并没有什么区别，但是有的时候有区别，如：</p>\n\n<blockquote>\n <p>需求：在用户定了超过库存的订单后，会修改该订单的订购数量，使订购数量的最大值和库存量相同 分析：首先判断 订购量 &gt; 库存量，然后做将订购量改为库存量</p>\n</blockquote>\n\n<p>创建触发器：</p>\n\n<pre class="prettyprint"><code class=" hljs oxygene"><span class="hljs-keyword">create</span> trigger t5\nbefore\ninsert \n<span class="hljs-keyword">on</span> ord\n<span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> row\n<span class="hljs-keyword">begin</span>\n declare restNum int;\n <span class="hljs-keyword">select</span> num <span class="hljs-keyword">into</span> restNum <span class="hljs-keyword">from</span> goods <span class="hljs-keyword">where</span> gid = <span class="hljs-keyword">new</span>.gid;\n\n <span class="hljs-keyword">if</span> <span class="hljs-keyword">new</span>.much &gt; restNum <span class="hljs-keyword">then</span>\n <span class="hljs-keyword">set</span> <span class="hljs-keyword">new</span>.much = restNum;\n <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;\n\n update goods <span class="hljs-keyword">set</span> num=num-<span class="hljs-keyword">new</span>.much <span class="hljs-keyword">where</span> gid=<span class="hljs-keyword">new</span>.gid;\n<span class="hljs-keyword">end</span>$</code></pre>\n\n<p>注意：这里如果使用的是after就会报错，如果使用的是after，就会先执行insert操作，也就是插入订单操作，然后在进行判断下单数量和库存量，得出新的下单数量，可是已经执行了下单操作了，所以就会报错。这里必须使用before操作。</p>\n\n<p><strong>7、for each row是干什么的？</strong></p>\n\n<p>在oracle触发器中，触发器分为行触发器和语句触发器</p>\n\n<p>比如：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> tn\n<span class="hljs-keyword">after</span>\n<span class="hljs-keyword">update</span>\n<span class="hljs-keyword">on</span> xxtable\n<span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-keyword">row</span> #每一行受影响，触发事件都执行，叫做行触发器\n<span class="hljs-keyword">begin</span>\n sqlN;</span>\n<span class="hljs-operator"><span class="hljs-keyword">end</span>$</span></code></pre>\n\n<p>执行：</p>\n\n\n\n<pre class="prettyprint"><code class=" hljs sql"><span class="hljs-operator"><span class="hljs-keyword">update</span> xxtable <span class="hljs-keyword">set</span> xxx=xxx <span class="hljs-keyword">where</span> id&gt;<span class="hljs-number">100</span>;</span></code></pre>\n\n<p>该修改操作假设100行，那么sqlN，会触发多少次？答案：会触发100次。</p>\n\n<p>拓展：</p>\n\n<p>在oracle中，for each row如果不写，无论update语句一次影响了多少行，都只执行一次触发事件。 <br />\n比如：1人下了订单，买了5件商品，insert 5次，可以用行级触发器，修改5次库存；用语句级触发器触发，insert一条发货提醒。 <br />\n遗憾的是mysql目前不支持语句级触发器。</p></div>&#13;\n <script type="text/javascript">&#13;\n $(function () {&#13;\n $('pre.prettyprint code').each(function () {&#13;\n var lines = $(this).text().split('\\n').length;&#13;\n var $numbering = $('&lt;ul/&gt;').addClass('pre-numbering').hide();&#13;\n $(this).addClass('has-numbering').parent().append($numbering);&#13;\n for (i = 1; i &lt;= lines; i++) {&#13;\n $numbering.append($('&lt;li/&gt;').text(i));&#13;\n };&#13;\n $numbering.fadeIn(1700);&#13;\n });&#13;\n });&#13;\n </script>&#13;\n &#13;\n
